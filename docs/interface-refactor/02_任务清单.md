# 接口管理模块重构 - 开发任务清单

> 版本: v2.0
> 日期: 2025-02-11
> 架构师: Claude (Architect Agent)

---

## Phase 1: 清理旧代码 (P0)

### 1.1 前端清理

- [ ] 删除 `frontend/src/pages/interface/` 整个目录
- [ ] 删除 `frontend/src/pages/interface-refactor/` 整个目录
- [ ] 更新 `frontend/src/App.tsx` 移除旧路由
- [ ] 清理相关 API 客户端方法（如需）

### 1.2 后端清理

- [ ] 检查并清理 `backend/app/api/v1/endpoints/interfaces.py` 中不需要的方法
- [ ] 清理 `backend/app/models/interface_history.py`（如果不需要）
- [ ] 清理 `backend/app/services/test_case_generator.py`（如果不需要）

---

## Phase 2: 数据库设计确认 (P0)

### 2.1 模型确认

**现有模型已满足需求** (`backend/app/models/project.py`):
- ✅ `Interface` - 接口模型
- ✅ `InterfaceFolder` - 文件夹模型
- ✅ `ProjectEnvironment` - 环境配置模型

### 2.2 数据库迁移

- [ ] 检查现有迁移是否包含所有必需字段
- [ ] 如需新增字段，执行 `uv run alembic revision --autogenerate -m "Add interface management fields"`
- [ ] 执行迁移 `uv run alembic upgrade head`

---

## Phase 3: 后端 API 开发 (P0)

### 3.1 接口管理 API

**文件**: `backend/app/api/v1/endpoints/interfaces.py`

| 任务 | 优先级 | 说明 |
|-----|--------|------|
| [ ] `GET /interfaces/` | P0 | 获取接口列表（支持分页、筛选） |
| [ ] `POST /interfaces/` | P0 | 创建接口 |
| [ ] `GET /interfaces/{id}` | P0 | 获取接口详情 |
| [ ] `PUT /interfaces/{id}` | P0 | 更新接口 |
| [ ] `DELETE /interfaces/{id}` | P0 | 删除接口 |
| [ ] `GET /interfaces/search` | P0 | 搜索接口（按名称/URL） |
| [ ] `PUT /interfaces/{id}/move` | P1 | 移动接口到其他文件夹 |
| [ ] `POST /interfaces/{id}/copy` | P1 | 复制接口 |

### 3.2 文件夹管理 API

**文件**: `backend/app/api/v1/endpoints/interfaces.py`

| 任务 | 优先级 | 说明 |
|-----|--------|------|
| [ ] `GET /interfaces/folders` | P0 | 获取文件夹树（支持 project_id 筛选） |
| [ ] `POST /interfaces/folders` | P0 | 创建文件夹 |
| [ ] `DELETE /interfaces/folders/{id}` | P0 | 删除文件夹（需检查子项） |
| [ ] `PUT /interfaces/folders/{id}/move` | P1 | 移动文件夹 |

### 3.3 环境管理 API

**文件**: `backend/app/api/v1/endpoints/environments.py`

| 任务 | 优先级 | 说明 |
|-----|--------|------|
| [ ] `GET /projects/{id}/environments` | P0 | 获取环境列表 |
| [ ] `POST /projects/{id}/environments` | P0 | 创建环境 |
| [ ] `GET /projects/{id}/environments/{envId}` | P0 | 获取环境详情 |
| [ ] `PUT /projects/{id}/environments/{envId}` | P0 | 更新环境 |
| [ ] `DELETE /projects/{id}/environments/{envId}` | P0 | 删除环境 |
| [ ] `POST /projects/{id}/environments/{envId}/copy` | P1 | 复制环境 |
| [ ] `POST /projects/{id}/environments/{envId}/replace` | P0 | 变量替换（`{{变量}}` 语法） |

### 3.4 请求执行 API

**文件**: `backend/app/api/v1/endpoints/interfaces.py`

| 任务 | 优先级 | 说明 |
|-----|--------|------|
| [ ] `POST /interfaces/debug/send` | P0 | 直接发送请求（httpx） |
| [ ] `POST /interfaces/debug/execute-engine` | P0 | 通过引擎执行请求 |
| [ ] `POST /interfaces/parse-curl` | P0 | 解析 cURL 命令 |

### 3.5 Schema 定义

**文件**: `backend/app/schemas/interface.py`

| 任务 | 优先级 | 说明 |
|-----|--------|------|
| [ ] 定义 `InterfaceCreate` | P0 | 创建接口请求体 |
| [ ] 定义 `InterfaceUpdate` | P0 | 更新接口请求体 |
| [ ] 定义 `InterfaceResponse` | P0 | 接口响应体 |
| [ ] 定义 `FolderCreate` | P0 | 创建文件夹请求体 |
| [ ] 定义 `FolderResponse` | P0 | 文件夹响应体 |
| [ ] 定义 `CurlParseRequest` | P0 | cURL 解析请求 |
| [ ] 定义 `CurlParseResponse` | P0 | cURL 解析响应 |
| [ ] 定义 `EngineExecuteRequest` | P0 | 引擎执行请求 |
| [ ] 定义 `EngineExecuteResponse` | P0 | 引擎执行响应 |

### 3.6 服务层开发

**新建文件**: `backend/app/services/`

| 任务 | 优先级 | 说明 |
|-----|--------|------|
| [ ] `yaml_generator.py` | P0 | YAML 生成服务（引擎集成） |
| [ ] `variable_replacer.py` | P0 | 变量替换服务（`{{变量}}` 语法） |
| [ ] `engine_executor.py` | P0 | 引擎执行服务（调用 sisyphus CLI） |
| [ ] `interface_service.py` | P1 | 接口业务逻辑服务 |

---

## Phase 4: 前端开发 (P0)

### 4.1 页面结构

**新建目录**: `frontend/src/pages/interface-management/`

| 组件 | 路径 | 说明 |
|------|------|------|
| [ ] `InterfaceManagement.tsx` | pages/interface-management/ | 主页面容器 |
| [ ] `InterfaceTree.tsx` | pages/interface-management/components/ | 左侧目录树 |
| [ ] `WelcomeCards.tsx` | pages/interface-management/components/ | 欢迎卡片 |
| [ ] `RequestEditor.tsx` | pages/interface-management/components/ | 请求编辑器 |
| [ ] `ResponseViewer.tsx` | pages/interface-management/components/ | 响应查看器 |

### 4.2 请求编辑器组件

**目录**: `frontend/src/pages/interface-management/components/RequestEditor/`

| 组件 | 说明 |
|------|------|
| [ ] `RequestEditor.tsx` | 主编辑器容器 |
| [ ] `MethodSelector.tsx` | HTTP 方法选择器 |
| [ ] `UrlInput.tsx` | URL 输入框（支持环境变量） |
| [ ] `ParamsTab.tsx` | Query 参数编辑 |
| [ ] `BodyTab.tsx` | 请求体编辑（JSON/form-data/raw） |
| [ ] `HeadersTab.tsx` | 请求头编辑 |
| [ ] `CookiesTab.tsx` | Cookie 编辑 |
| [ ] `AuthTab.tsx` | 认证配置 |
| [ ] `KeyValueEditor.tsx` | 通用键值对编辑器 |
| [ ] `FormDataEditor.tsx` | form-data 编辑器（支持文件上传） |
| [ ] `EnvironmentSelector.tsx` | 环境选择器 |

### 4.3 响应查看器组件

**目录**: `frontend/src/pages/interface-management/components/ResponseViewer/`

| 组件 | 说明 |
|------|------|
| [ ] `ResponseViewer.tsx` | 主查看器容器 |
| [ ] `ResponseHeader.tsx` | 状态码、耗时、大小 |
| [ ] `BodyViewer.tsx` | 响应体展示（支持 Pretty/Raw） |
| [ ] `HeadersViewer.tsx` | 响应头展示 |
| [ ] `CookiesViewer.tsx` | 响应 Cookie 展示 |
| [ ] `TimelineViewer.tsx` | 请求时间线（DNS/TCP/TTFB） |
| [ ] `ExecutionLogViewer.tsx` | 执行日志 |

### 4.4 弹窗组件

**目录**: `frontend/src/pages/interface-management/dialogs/`

| 组件 | 说明 |
|------|------|
| [ ] `EnvironmentDialog.tsx` | 环境管理弹窗 |
| [ ] `CurlImportDialog.tsx` | cURL 导入弹窗 |
| [ ] `SaveInterfaceDialog.tsx` | 保存接口弹窗（可选） |

### 4.5 API 客户端

**文件**: `frontend/src/api/client.ts`

| 任务 | 说明 |
|------|------|
| [ ] 添加 `interfaceManagementApi` | 新增接口管理 API 方法 |
| [ ] 添加环境变量替换 API | 变量替换方法 |
| [ ] 添加引擎执行 API | 引擎执行方法 |

### 4.6 类型定义

**新建文件**: `frontend/src/pages/interface-management/types.ts`

| 任务 | 说明 |
|------|------|
| [ ] 定义 `Interface` 类型 | 接口数据结构 |
| [ ] 定义 `InterfaceFolder` 类型 | 文件夹数据结构 |
| [ ] 定义 `Environment` 类型 | 环境数据结构 |
| [ ] 定义 `RequestData` 类型 | 请求编辑器数据 |
| [ ] 定义 `ResponseData` 类型 | 响应数据结构 |
| [ ] 定义 `KeyValuePair` 类型 | 键值对数据结构 |
| [ ] 定义 `AuthConfig` 类型 | 认证配置类型 |
| [ ] 定义 `BodyType` 类型 | Body 类型枚举 |

### 4.7 路由配置

**文件**: `frontend/src/App.tsx`

| 任务 | 说明 |
|------|------|
| [ ] 添加接口管理路由 | `/api/interfaces` 和 `/api/interfaces/:id` |
| [ ] 添加导航菜单项 | 侧边栏导航 |

---

## Phase 5: 引擎集成 (P0)

### 5.1 后端集成

| 任务 | 文件 | 说明 |
|------|------|------|
| [ ] 实现 YAML 生成器 | `backend/app/services/yaml_generator.py` | 将接口配置转换为 YAML |
| [ ] 实现变量替换 | `backend/app/services/variable_replacer.py` | `{{变量}}` 替换逻辑 |
| [ ] 实现引擎执行 | `backend/app/services/engine_executor.py` | 调用 sisyphus CLI |
| [ ] 临时文件管理 | `backend/app/services/engine_executor.py` | 生成和清理临时 YAML |
| [ ] 结果解析 | `backend/app/services/engine_executor.py` | 解析引擎 JSON 输出 |

### 5.2 前端集成

| 任务 | 说明 |
|------|------|
| [ ] 添加"通过引擎执行"按钮 | 请求编辑器顶部 |
| [ ] 执行模式切换 | 直接发送 / 引擎执行 |
| [ ] 展示引擎输出 | 响应查看器 |

---

## Phase 6: 环境变量系统 (P0)

### 6.1 后端实现

| 任务 | 说明 |
|------|------|
| [ ] 环境变量存储 | `ProjectEnvironment.variables` (JSON) |
| [ ] 变量替换 API | `POST /environments/{id}/replace` |
| [ ] 变量优先级 | 环境变量 > 全局变量 |

### 6.2 前端实现

| 任务 | 说明 |
|------|------|
| [ ] 环境选择器 | 顶部工具栏 |
| [ ] 变量编辑器 | 环境管理弹窗 |
| [ ] 变量语法高亮 | `{{变量名}}` 高亮显示 |
| [ ] 自动补全提示 | 输入 `{{` 时提示可用变量 |

---

## Phase 7: cURL 解析 (P0)

### 7.1 后端

| 任务 | 说明 |
|------|------|
| [ ] 解析 cURL 命令 | 已有 `CurlParser` 服务 |
| [ ] 支持参数 | `-H`, `-d`, `--data-raw`, `-X`, `-u` 等 |
| [ ] API 端点 | `POST /interfaces/parse-curl` |

### 7.2 前端

| 任务 | 说明 |
|------|------|
| [ ] cURL 导入弹窗 | 多行文本输入 |
| [ ] 解析结果展示 | 预览解析后的请求 |
| [ ] 错误处理 | 解析失败提示 |

---

## Phase 8: 测试 (P1)

### 8.1 单元测试

| 任务 | 覆盖目标 |
|------|---------|
| [ ] 后端 API 测试 | 80%+ |
| [ ] 前端组件测试 | 80%+ |
| [ ] 服务层测试 | 90%+ |

### 8.2 集成测试

| 任务 | 说明 |
|------|------|
| [ ] API 端到端测试 | 关键流程 |
| [ ] 环境变量测试 | 替换逻辑 |
| [ ] 引擎集成测试 | YAML 生成和执行 |

### 8.3 E2E 测试

| 任务 | 说明 |
|------|------|
| [ ] Playwright 测试 | 关键用户流程 |
| [ ] 创建接口流程 | 新建 → 编辑 → 保存 |
| [ ] 发送请求流程 | 配置 → 发送 → 查看响应 |
| [ ] 环境管理流程 | 创建 → 切换 → 删除 |

---

## Phase 9: 文档和部署 (P1)

### 9.1 文档

| 任务 | 说明 |
|------|------|
| [ ] API 文档 | Swagger/OpenAPI |
| [ ] 用户手册 | 如何使用接口管理 |
| [ ] 开发文档 | 架构说明 |

### 9.2 部署

| 任务 | 说明 |
|------|------|
| [ ] 前端构建 | `npm run build` |
| [ ] 后端部署 | Docker 部署 |
| [ ] 数据库迁移 | 生产环境迁移 |

---

## 任务优先级说明

- **P0**: 必须完成（核心功能）
- **P1**: 应该完成（增强功能）
- **P2**: 可以延后（锦上添花）

## 开发顺序建议

1. Phase 1 清理旧代码（半天）
2. Phase 2 确认数据库设计（半天）
3. Phase 3 后端 API 开发（2-3 天）
4. Phase 4 前端开发（3-4 天）
5. Phase 5-7 功能集成（1-2 天）
6. Phase 8 测试（2 天）
7. Phase 9 文档和部署（1 天）

**总计**: 约 10-12 个工作日

---

**文档变更记录**

| 版本 | 日期 | 作者 | 变更说明 |
|-----|------|------|---------|
| v2.0 | 2025-02-11 | Claude (Architect) | 根据新 PRD 重新规划任务清单 |
