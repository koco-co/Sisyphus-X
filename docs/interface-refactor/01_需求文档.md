# 接口管理模块重构需求文档 (PRD)

> 版本: v2.0
> 日期: 2025-02-11
> 产品经理: Claude (PM Agent)
> 项目: SisyphusX

---

## 1. 用户决策记录

### 用户原始需求

根据用户在 README.md 中的原始需求描述：

> 1、先删除当前项目中的两个接口管理模块相关的代码、文档等等，
>
> 2、新增「接口管理」模块, 直接抄apifox就可以了, 只需要抄接口调试部分, 左侧的目录树部分就可以了。默认情况下，左侧展示接口目录树，右侧展示「新建HTTP请求」（默认引用环境中的baseurl）、「导入cURL」等卡片，点击左侧的接口后，右侧展示接口调试功能，覆盖掉之前的卡片，可以进行调试，请求方式枚举值支持requests库所有支持的值，右上角有环境管理按钮，点击可以进入弹窗设置多个环境，支持新建环境，需要填写环境名称、baseURL、环境变量名和值，保存后，新建的HTTP请求前置url自动取这个环境设置的url，支持发送、保存。下方支持Params、Body、headers、Cookies等，各处都可以通过{{}}进行参数值引用,引用当前环境中设置的变量名。发送请求后，下方展示响应内容：body、header。这部分的模块要跟sisyphus-api-engine这个模块打通，通过将这些参数转换为临时且唯一的yaml文件，然后通过sisyphus --cases examples/01_HTTP请求方法.yaml --format json -v 命令去执行yaml文件，将得到的json输出到body中。

---

## 2. 项目背景与目标

### 2.1 项目背景

SisyphusX 是一个 AI 驱动的企业级自动化测试平台，当前系统中存在两个接口管理模块：

1. **`interface-refactor` 模块**: 位于 `frontend/src/pages/interface-refactor/`，是新开发的接口管理功能，已实现基础的接口目录树、请求编辑器、响应查看器等组件
2. **旧的 `interface` 模块**: 位于 `frontend/src/pages/interface/`，功能相对老旧

### 2.2 重构目标

参考 Apifox 的接口调试功能，打造一个现代化的接口调试工具，具体目标：

1. **清理旧代码**: 删除 `interface` 和 `interface-refactor` 两个旧模块的所有相关代码和文档
2. **重新实现**: 全新实现接口管理模块，只保留 Apifox 风格的核心调试功能
3. **简化界面**: 左侧目录树 + 右侧操作区的简洁布局
4. **快速调试**: 无需切换页面，直接在界面中发送请求查看响应
5. **环境管理**: 支持多环境配置，快速切换不同环境的 baseURL 和变量
6. **引擎集成**: 与 `sisyphus-api-engine` 打通，支持生成 YAML 并通过引擎执行
7. **变量引用**: 支持 `{{变量名}}` 语法引用环境变量

### 2.3 设计参考

- [Apifox 接口调试工具](https://apifox.com/apiskills/api-interface-debugging-tool-evaluation/)
- [2026年API调试工具天梯图](https://blog.csdn.net/chicken_bob/article/details/156654319)

---

## 3. 用户角色表

| 角色 ID | 角色名称 | 描述 | 主要目标 |
|---------|----------|------|---------|
| R001 | 测试工程师 | 负责API接口测试和验证 | 快速调试接口,验证接口响应是否符合预期 |
| R002 | 后端开发工程师 | 开发和调试后端API接口 | 方便地测试自己开发的接口,查看响应结果 |
| R003 | 前端开发工程师 | 调用后端API进行前端开发 | 查看API响应格式,调试数据传递问题 |
| R004 | API文档维护者 | 维护接口文档和集合 | 组织接口结构,为团队提供接口文档 |

---

## 4. 核心用户故事 (User Stories)

### US001: 查看接口目录树

**优先级**: P0 (必须有)
**角色**: R001, R002, R003, R004
**功能**: 左侧展示接口目录树，用户可以浏览所有已保存的接口

**验收标准**:
- [ ] 左侧面板显示项目的接口目录树结构
- [ ] 支持按文件夹组织接口(至少支持2级文件夹)
- [ ] 每个接口显示 HTTP 方法和接口名称
- [ ] 支持搜索接口(按名称或URL搜索)
- [ ] 点击接口后,右侧展示该接口的调试界面（覆盖欢迎卡片）
- [ ] 支持展开/折叠文件夹

---

### US002: 新建 HTTP 请求

**优先级**: P0 (必须有)
**角色**: R001, R002, R003
**功能**: 默认情况下,右侧显示"新建HTTP请求"和"导入cURL"卡片

**验收标准**:
- [ ] 未选择接口时,右侧显示欢迎界面
- [ ] 欢迎界面包含两个主要操作卡片:
  - [ ] "新建HTTP请求"卡片:点击进入请求编辑模式
  - [ ] "导入cURL"卡片:点击打开cURL导入弹窗
- [ ] 点击"新建请求"后,URL输入框自动填充当前环境的 baseURL
- [ ] 默认HTTP方法为 GET
- [ ] 支持的HTTP方法: GET, POST, PUT, DELETE, PATCH, HEAD, OPTIONS（requests 库所有方法）
- [ ] 可通过下拉选择器切换HTTP方法

---

### US003: 导入 cURL 命令

**优先级**: P0 (必须有)
**角色**: R001, R002, R003
**功能**: 支持从 cURL 命令快速导入接口配置

**验收标准**:
- [ ] 点击"导入cURL"卡片后,打开cURL导入弹窗
- [ ] 弹窗包含一个多行文本输入框,用于粘贴cURL命令
- [ ] 解析cURL后,自动填充:
  - [ ] HTTP方法
  - [ ] URL
  - [ ] Headers
  - [ ] 请求体(如果有)
- [ ] 解析失败时,显示友好的错误提示信息
- [ ] 支持常见的cURL格式(包括:-H, -d, --data-raw等参数)

---

### US004: 环境管理

**优先级**: P0 (必须有)
**角色**: R001, R002, R003, R004
**功能**: 支持创建和管理多个环境,每个环境有不同的 baseURL 和变量

**验收标准**:
- [ ] 右上角有"环境管理"按钮,点击打开环境管理弹窗
- [ ] 环境管理弹窗显示所有已创建的环境列表
- [ ] 支持创建新环境,需填写:
  - [ ] 环境名称(必填)
  - [ ] Base URL(必填,如:https://api-dev.example.com)
  - [ ] 环境变量(可选,键值对形式)
- [ ] 支持编辑和删除环境
- [ ] 支持设置默认环境
- [ ] 请求编辑器顶部有环境选择器,可快速切换当前环境
- [ ] 切换环境后,URL自动更新为新环境的 baseURL
- [ ] 新建HTTP请求时,URL前缀自动填充为当前环境的 baseURL

---

### US005: 环境变量引用

**优先级**: P0 (必须有)
**角色**: R001, R002, R003
**功能**: 在请求的各个位置支持通过 `{{变量名}}` 引用环境变量

**验收标准**:
- [ ] 支持在URL中引用变量,如: `{{baseURL}}/api/users`
- [ ] 支持在Params中引用变量
- [ ] 支持在Headers中引用变量
- [ ] 支持在Body中引用变量
- [ ] 支持在Cookies中引用变量
- [ ] 发送请求前,自动将 `{{变量名}}` 替换为实际值
- [ ] 变量不存在时,显示错误提示

---

### US006: 请求编辑器

**优先级**: P0 (必须有)
**角色**: R001, R002, R003
**功能**: 提供完整的请求配置界面

**验收标准**:
- [ ] 支持编辑以下标签页:
  - [ ] Params: Query 参数编辑
  - [ ] Body: 请求体编辑（支持 none/JSON/form-data/x-www-form-urlencoded）
  - [ ] Headers: 请求头编辑
  - [ ] Cookies: Cookie 编辑
- [ ] 每个标签页支持:
  - [ ] 添加/删除键值对
  - [ ] 启用/禁用某个参数
  - [ ] 使用 `{{变量名}}` 引用环境变量
- [ ] Body 标签页支持:
  - [ ] JSON 格式化
  - [ ] form-data 文件上传
  - [ ] x-www-form-urlencoded 表单编码

---

### US007: 发送请求并查看响应

**优先级**: P0 (必须有)
**角色**: R001, R002, R003
**功能**: 点击"发送"按钮后,执行HTTP请求并在下方展示响应

**验收标准**:
- [ ] 点击"发送"按钮后,显示加载状态
- [ ] 请求执行完成后,下方区域显示响应结果
- [ ] 响应结果包含:
  - [ ] Body: 显示响应体,支持 Pretty/Raw 切换
  - [ ] Headers: 显示响应头
  - [ ] 状态码(带颜色标识:2xx绿色,3xx黄色,4xx橙色,5xx红色)
  - [ ] 响应时间
- [ ] Body自动格式化(JSON格式化,XML高亮等)
- [ ] 请求失败时显示错误信息和堆栈

---

### US008: 保存接口

**优先级**: P0 (必须有)
**角色**: R001, R002, R003, R004
**功能**: 支持保存配置好的接口到数据库

**验收标准**:
- [ ] 请求编辑器顶部显示接口名称输入框
- [ ] 右上角有"保存"按钮
- [ ] 保存时需填写接口名称(必填)
- [ ] 保存成功后,接口出现在左侧目录树中
- [ ] 如果是编辑已有接口,保存后更新数据库记录
- [ ] 如果是新建接口,保存后自动切换到编辑模式
- [ ] 保存失败时显示错误提示

---

### US009: 与 sisyphus-api-engine 集成

**优先级**: P0 (必须有)
**角色**: R001
**功能**: 将当前请求配置转换为临时 YAML 文件,并通过 sisyphus CLI 执行

**验收标准**:
- [ ] 提供"通过引擎执行"选项
- [ ] 将请求转换为 YAML 格式,符合 sisyphus-api-engine 规范
- [ ] 生成唯一的临时 YAML 文件路径
- [ ] 通过命令执行: `sisyphus --cases {yaml_path} --format json -v`
- [ ] 将引擎输出的 JSON 结果解析并显示在响应区域
- [ ] 支持切换执行模式:
  - [ ] 直接发送: 通过 httpx 直接发送请求
  - [ ] 引擎执行: 通过 sisyphus CLI 执行

---

## 5. 功能需求详情

### 5.1 界面布局

```
┌─────────────────────────────────────────────────────────────────┐
│ [Logo] SisyphusX                        [用户头像]         │
├──────────┬────────────────────────────────────────────────────┤
│          │  [接口名称输入框]    [环境▼] [保存] [引擎执行] │
│  接口树  ├────────────────────────────────────────────────────┤
│          │ [▼] GET [https://api.example.com]  [发送]     │
│ ┌──────┐ │ ┌─────────────┬────────────────────────────────┐│
│ │ 文件夹│ │ │ Params      │ Body   │ Headers│Cookies     ││
│ ├──────┤ │ ├──────────────────────────────────────────┤│
│ │┌─┐   │ │ │ Key │ Value │ Enabled │ 操作           ││
│ ││GET接口│ │ │ ────┼───────┼─────────┼────────      ││
│ │└─┘   │ │ │ token│{{...}}│   ✓    │ [+][删除]     ││
│ ├──────┤ │ └──────────────────────────────────────────┘│
│ │┌─┐   │ │ ┌──────────────┬─────────────────────────┐│
│ ││POST  │ │ ││ 200 OK      │  245ms    │ 1.2KB  ││
│ │└─┘   │ │ │├──────────────┴─────────────────────────┤│
│ └──────┘ │ │ │ Body│Headers                          ││
│          │ │ ├──────────────────────────────────────────┤│
│          │ │ │ {                                   ││
│          │ │ │   "status": "success",               ││
│          │ │ │   "data": {...}                     ││
│          │ │ │ }                                   ││
│          │ │ └──────────────────────────────────────────┘│
└──────────┴───────────────────────────────────────────────────┘
```

**未选择接口时的欢迎界面**:

```
┌─────────────────────────────────────────────────────────────────┐
│ [Logo] SisyphusX                        [环境管理] [用户]  │
├──────────┬────────────────────────────────────────────────────┤
│          │                                                │
│  接口树  │  ┌─────────────────┐  ┌─────────────────┐      │
│          │  │                 │  │                 │      │
│ ┌──────┐ │  │   新建HTTP请求    │  │    导入cURL     │      │
│ │ 文件夹│ │  │                 │  │                 │      │
│ ├──────┤ │  │   [点击创建]     │  │   [点击导入]     │      │
│ │┌─┐   │ │  │                 │  │                 │      │
│ ││GET   │ │  │                 │  │                 │      │
│ │└─┘   │ │  │                 │  │                 │      │
│ └──────┘ │  └─────────────────┘  └─────────────────┘      │
│          │                                                │
│          │  最近使用 (可选):                                │
│          │  ┌────────────────────────────────────────┐       │
│          │  │ GET  /api/users              2分钟前  │       │
│          │  │ POST /api/login             5分钟前  │       │
│          │  └────────────────────────────────────────┘       │
└──────────┴───────────────────────────────────────────────────┘
```

### 5.2 环境管理弹窗

```
┌────────────────────────────────────────────────┐
│ 环境管理                          [×]     │
├────────────────────────────────────────────────┤
│ [+ 新建环境]                              │
├────────────────────────────────────────────────┤
│ ◉ 开发环境 (dev)                    [编辑][删除]│
│   baseURL: https://api-dev.example.com   │
│   变量: token, user_id                  │
│ ○ 测试环境 (test)                   [编辑][删除]│
│   baseURL: https://api-test.example.com  │
│   变量: token, user_id                  │
│ ○ 生产环境 (prod)                   [编辑][删除]│
│   baseURL: https://api.example.com       │
│   变量: -                              │
└────────────────────────────────────────────────┘
```

### 5.3 HTTP 方法支持

根据 Python `requests` 库的支持情况，支持的 HTTP 方法：

| 方法 | 描述 | 支持 |
|-----|------|-----|
| GET | 获取资源 | ✓ |
| POST | 创建资源 | ✓ |
| PUT | 更新资源(全量) | ✓ |
| DELETE | 删除资源 | ✓ |
| PATCH | 更新资源(部分) | ✓ |
| HEAD | 获取响应头 | ✓ |
| OPTIONS | 获取支持的方法 | ✓ |

### 5.4 变量引用语法

采用与 Apifox/Postman 一致的 `{{变量名}}` 语法：

**支持的位置**:
- URL: `{{baseURL}}/api/users/{{userId}}`
- Params: `?token={{token}}&size={{pageSize}}`
- Headers: `Authorization: Bearer {{token}}`
- Body (JSON):
  ```json
  {
    "username": "{{username}}",
    "password": "{{password}}"
  }
  ```
- Cookies: `sessionId={{sessionId}}`

**优先级**:
1. 环境变量(从当前选择的环境读取)
2. 全局变量(未来支持)

### 5.5 与 sisyphus-api-engine 集成方案

#### 5.5.1 YAML 生成规则

```yaml
name: "接口调试 - {{接口名称}}"
description: "{{接口描述}}"
config:
  profiles:
    {{环境名称}}:
      base_url: "{{环境baseURL}}"
  active_profile: "{{当前环境}}"
  variables:
    {{合并环境变量}}
steps:
  - name: "{{接口名称}}"
    type: request
    method: {{HTTP方法}}
    url: "{{完整URL}}"
    headers:
      {{合并Headers}}
    params:
      {{合并Query参数}}
    body:
      {{请求体内容}}
    cookies:
      {{合并Cookies}}
```

#### 5.5.2 执行流程

```
用户点击"通过引擎执行"
    ↓
前端收集请求配置(method, url, headers, params, body等)
    ↓
调用后端 API: POST /api/v1/interfaces/execute-with-engine
    ↓
后端生成临时 YAML 文件
    ↓
后端执行命令: sisyphus --cases /tmp/xxx.yaml --format json -v
    ↓
后端解析 JSON 输出并返回给前端
    ↓
前端展示响应结果
```

#### 5.5.3 临时文件管理

- 文件路径格式: `/tmp/sisyphus_debug_{timestamp}_{random}.yaml`
- 执行完成后自动删除(延迟5分钟)
- 使用后台任务定期清理过期的临时文件

---

## 6. 数据模型

### 6.1 接口 (Interface)

```typescript
interface Interface {
  id?: number
  project_id: number
  folder_id?: number | null
  name: string
  url: string
  method: 'GET' | 'POST' | 'PUT' | 'DELETE' | 'PATCH' | 'HEAD' | 'OPTIONS'
  status?: 'draft' | 'stable' | 'deprecated'
  description?: string
  headers?: Record<string, string>
  params?: Record<string, unknown>
  body?: unknown
  body_type?: 'none' | 'json' | 'form-data' | 'x-www-form-urlencoded' | 'raw'
  cookies?: Record<string, string>
  order?: number
  created_at?: string
  updated_at?: string
}
```

### 6.2 接口文件夹 (InterfaceFolder)

```typescript
interface InterfaceFolder {
  id?: number
  project_id: number
  name: string
  parent_id?: number | null
  order?: number
  created_at?: string
}
```

### 6.3 环境配置 (ProjectEnvironment)

```typescript
interface ProjectEnvironment {
  id?: number
  project_id: number
  name: string
  domain: string // baseURL
  variables?: Record<string, string>
  headers?: Record<string, string>
  is_preupload?: boolean
  created_at?: string
  updated_at?: string
}
```

---

## 7. API 设计

### 7.1 接口管理

| 方法 | 路径 | 描述 |
|-----|------|------|
| GET | `/api/v1/interfaces/` | 获取接口列表 |
| POST | `/api/v1/interfaces/` | 创建接口 |
| GET | `/api/v1/interfaces/{id}` | 获取接口详情 |
| PUT | `/api/v1/interfaces/{id}` | 更新接口 |
| DELETE | `/api/v1/interfaces/{id}` | 删除接口 |

### 7.2 文件夹管理

| 方法 | 路径 | 描述 |
|-----|------|------|
| GET | `/api/v1/interfaces/folders` | 获取文件夹列表 |
| POST | `/api/v1/interfaces/folders` | 创建文件夹 |
| DELETE | `/api/v1/interfaces/folders/{id}` | 删除文件夹 |

### 7.3 环境管理

| 方法 | 路径 | 描述 |
|-----|------|------|
| GET | `/api/v1/projects/{id}/environments` | 获取环境列表 |
| POST | `/api/v1/projects/{id}/environments` | 创建环境 |
| GET | `/api/v1/projects/{id}/environments/{envId}` | 获取环境详情 |
| PUT | `/api/v1/projects/{id}/environments/{envId}` | 更新环境 |
| DELETE | `/api/v1/projects/{id}/environments/{envId}` | 删除环境 |

### 7.4 请求执行

| 方法 | 路径 | 描述 |
|-----|------|------|
| POST | `/api/v1/interfaces/debug/send` | 直接发送请求(httpx) |
| POST | `/api/v1/interfaces/debug/execute-engine` | 通过引擎执行请求 |
| POST | `/api/v1/interfaces/parse-curl` | 解析 cURL 命令 |

---

## 8. 实施计划

### Phase 1: 清理旧代码 (P0)

**目标**: 删除旧的接口管理模块

- [ ] 删除 `frontend/src/pages/interface/` 目录
- [ ] 删除 `frontend/src/pages/interface-refactor/` 目录
- [ ] 删除 `docs/interface-refactor/` 目录下的旧文档
- [ ] 更新 `App.tsx` 移除旧模块的路由引用

### Phase 2: 新增接口管理模块 (P0)

**目标**: 从零开始实现全新的接口管理模块

- [ ] 创建 `frontend/src/pages/interface-management/` 目录结构
- [ ] 实现主页面组件 `InterfaceManagement.tsx`
- [ ] 实现左侧接口目录树组件 `InterfaceTree.tsx`
- [ ] 实现欢迎卡片组件 `WelcomeCards.tsx`
- [ ] 实现请求编辑器组件 `RequestEditor.tsx`
- [ ] 实现响应查看器组件 `ResponseViewer.tsx`
- [ ] 实现环境管理弹窗 `EnvironmentDialog.tsx`
- [ ] 实现 cURL 导入弹窗 `CurlImportDialog.tsx`
- [ ] 实现各 Tab 组件: `ParamsTab`, `BodyTab`, `HeadersTab`, `CookiesTab`
- [ ] 添加路由到 `App.tsx`

### Phase 3: 后端 API 实现 (P0)

**目标**: 实现所需的后端接口

- [ ] 实现接口 CRUD API
- [ ] 实现文件夹管理 API
- [ ] 实现环境管理 API
- [ ] 实现请求发送 API (httpx 直接发送)
- [ ] 实现 cURL 解析 API

### Phase 4: 引擎集成 (P0)

**目标**: 与 sisyphus-api-engine 打通

- [ ] 后端实现 YAML 生成服务
- [ ] 后端实现引擎执行 API
- [ ] 前端添加"通过引擎执行"按钮
- [ ] 实现临时文件管理
- [ ] 实现执行结果解析和展示

---

## 9. 验收标准总结

### 9.1 功能完整性

- [ ] 所有 P0 级别的用户故事已实现
- [ ] 支持 7 种 HTTP 方法
- [ ] 支持 cURL 导入
- [ ] 支持环境管理和变量引用
- [ ] 支持与 sisyphus-api-engine 集成

### 9.2 用户体验

- [ ] 界面简洁直观,参考 Apifox 的设计
- [ ] 左侧目录树操作流畅
- [ ] 请求发送响应快速(<200ms)
- [ ] 错误提示清晰

### 9.3 技术质量

- [ ] 代码符合项目编码规范
- [ ] TypeScript 类型覆盖率 100%
- [ ] 无 console.log 等调试代码
- [ ] 组件拆分合理(<800 行/文件)

---

## 10. 风险与依赖

### 10.1 技术风险

| 风险 | 影响 | 应对措施 |
|-----|------|---------|
| sisyphus CLI 未安装 | 引擎执行失败 | 提供友好的错误提示,引导用户安装 |
| YAML 格式不兼容 | 引擎执行报错 | 严格按照引擎规范生成 YAML |
| 临时文件清理失败 | 磁盘空间占用 | 定期清理机制 + 文件监控 |

### 10.2 依赖项

| 依赖 | 版本要求 | 状态 |
|-----|---------|------|
| sisyphus-api-engine | ≥ 1.0 | 需确认 |
| React | ≥ 19.2 | ✓ |
| FastAPI | ≥ 0.115 | ✓ |
| SQLModel | ≥ 0.0.14 | ✓ |

---

## 11. 附录

### 11.1 参考文档

- [Apifox 官方文档](https://apifox.com/)
- [sisyphus-api-engine GitHub](https://github.com/koco-co/Sisyphus-api-engine)
- [项目 CLAUDE.md](/Users/poco/Documents/Projects/Sisyphus-X/CLAUDE.md)

### 11.2 术语表

| 术语 | 定义 |
|-----|------|
| 接口 | HTTP API 端点,包含 URL、方法、参数等信息 |
| 环境 | 一组配置(baseURL + 变量),用于区分不同部署环境 |
| 变量引用 | 通过 `{{变量名}}` 语法引用变量值 |
| YAML | sisyphus-api-engine 的测试用例格式 |
| 引擎 | sisyphus CLI,用于执行 YAML 格式的测试用例 |

---

**文档变更记录**

| 版本 | 日期 | 作者 | 变更说明 |
|-----|------|------|---------|
| v2.0 | 2025-02-11 | Claude (PM Agent) | 根据用户原始需求重写PRD,聚焦核心功能 |
| v1.0 | 2025-02-11 | Claude | 初始版本(已废弃) |
