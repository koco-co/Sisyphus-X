# 接口管理模块 - 数据库设计

> 版本: v2.0
> 日期: 2025-02-11
> 架构师: Claude (Architect Agent)

---

## 1. 数据库表结构

### 1.1 项目表 (project)

**已有表**，位于 `backend/app/models/project.py`

| 字段 | 类型 | 约束 | 说明 |
|------|------|--------|------|
| id | INTEGER | PK, AUTO | 主键 |
| name | VARCHAR(255) | NOT NULL | 项目名称 |
| key | VARCHAR(50) | NOT NULL, UNIQUE | 项目标识 |
| owner | VARCHAR(100) | NOT NULL | 负责人 |
| description | TEXT | NULL | 项目描述 |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |

**索引**:
- PRIMARY KEY (id)
- UNIQUE INDEX (key)

---

### 1.2 接口文件夹表 (interfacefolder)

**已有表**，位于 `backend/app/models/project.py`

| 字段 | 类型 | 约束 | 说明 |
|------|------|--------|------|
| id | INTEGER | PK, AUTO | 主键 |
| project_id | INTEGER | FK, NOT NULL | 项目 ID |
| name | VARCHAR(255) | NOT NULL | 文件夹名称 |
| parent_id | INTEGER | FK, NULL | 父文件夹 ID（支持树形结构） |
| order | INTEGER | NOT NULL, DEFAULT 0 | 同级排序序号 |
| created_at | DATETIME | NOT NULL | 创建时间 |

**外键**:
- `project_id` → `project(id)` ON DELETE CASCADE
- `parent_id` → `interfacefolder(id)` ON DELETE CASCADE

**索引**:
- PRIMARY KEY (id)
- INDEX (project_id)
- INDEX (parent_id)

**设计说明**:
- 支持多级文件夹结构（通过 `parent_id` 自引用）
- 删除父文件夹时级联删除子文件夹

---

### 1.3 接口表 (interface)

**已有表**，位于 `backend/app/models/project.py`

| 字段 | 类型 | 约束 | 说明 |
|------|------|--------|------|
| id | INTEGER | PK, AUTO | 主键 |
| project_id | INTEGER | FK, NOT NULL | 项目 ID |
| folder_id | INTEGER | FK, NULL | 所属文件夹 ID |
| name | VARCHAR(255) | NOT NULL | 接口名称 |
| url | VARCHAR(2048) | NOT NULL | 接口路径 |
| method | VARCHAR(10) | NOT NULL | HTTP 方法 |
| status | VARCHAR(20) | NOT NULL, DEFAULT 'draft' | 接口状态 |
| description | TEXT | NULL | 接口描述 |
| headers | JSON | NOT NULL, DEFAULT {} | 请求头 |
| params | JSON | NOT NULL, DEFAULT {} | Query 参数 |
| body | JSON | NOT NULL, DEFAULT {} | 请求体 |
| body_type | VARCHAR(50) | NOT NULL, DEFAULT 'json' | Body 类型 |
| cookies | JSON | NOT NULL, DEFAULT {} | Cookies |
| order | INTEGER | NOT NULL, DEFAULT 0 | 同级排序序号 |
| auth_config | JSON | NOT NULL, DEFAULT {} | 认证配置 |
| schema_snapshot | JSON | NOT NULL, DEFAULT {} | Swagger 原始结构 |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |

**外键**:
- `project_id` → `project(id)` ON DELETE CASCADE
- `folder_id` → `interfacefolder(id)` ON DELETE SET NULL

**索引**:
- PRIMARY KEY (id)
- INDEX (project_id)
- INDEX (folder_id)
- INDEX (method)
- INDEX (status)
- COMPOSITE INDEX (project_id, folder_id)

**JSON 字段说明**:

**headers**:
```json
{
  "Content-Type": "application/json",
  "Authorization": "Bearer {{token}}"
}
```

**params**:
```json
{
  "page": 1,
  "size": 20
}
```

**body**:
```json
{
  "username": "test",
  "password": "123456"
}
```

**auth_config**:
```json
{
  "type": "bearer",
  "token": "{{token}}",
  "prefix": "Bearer"
}
```

---

### 1.4 项目环境表 (projectenvironment)

**已有表**，位于 `backend/app/models/project.py`

| 字段 | 类型 | 约束 | 说明 |
|------|------|--------|------|
| id | INTEGER | PK, AUTO | 主键 |
| project_id | INTEGER | FK, NOT NULL | 项目 ID |
| name | VARCHAR(50) | NOT NULL | 环境名称 |
| domain | VARCHAR(500) | NOT NULL, DEFAULT '' | Base URL |
| variables | JSON | NOT NULL, DEFAULT {} | 全局变量 |
| headers | JSON | NOT NULL, DEFAULT {} | 全局请求头 |
| is_preupload | BOOLEAN | NOT NULL, DEFAULT FALSE | 是否预上传 |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |

**外键**:
- `project_id` → `project(id)` ON DELETE CASCADE

**索引**:
- PRIMARY KEY (id)
- UNIQUE INDEX (project_id, name)
- INDEX (project_id)

**JSON 字段说明**:

**variables**:
```json
{
  "token": "dev_token_123",
  "user_id": "10001",
  "baseURL": "https://api-dev.example.com"
}
```

**headers**:
```json
{
  "X-Env": "dev",
  "X-Debug": "true"
}
```

**设计说明**:
- 每个项目可以有多个环境（开发、测试、生产）
- 环境变量使用 `{{变量名}}` 语法引用
- `domain` 存储环境的 Base URL

---

### 1.5 项目数据源表 (projectdatasource)

**已有表**，位于 `backend/app/models/project.py`

| 字段 | 类型 | 约束 | 说明 |
|------|------|--------|------|
| id | INTEGER | PK, AUTO | 主键 |
| project_id | INTEGER | FK, NOT NULL | 项目 ID |
| name | VARCHAR(100) | NOT NULL | 数据源名称 |
| db_type | VARCHAR(50) | NOT NULL | 数据库类型 |
| host | VARCHAR(255) | NOT NULL | 主机地址 |
| port | INTEGER | NOT NULL | 端口 |
| db_name | VARCHAR(100) | NOT NULL, DEFAULT '' | 数据库名 |
| username | VARCHAR(100) | NOT NULL, DEFAULT '' | 用户名 |
| password_hash | VARCHAR(255) | NOT NULL, DEFAULT '' | 加密密码 |
| variable_name | VARCHAR(50) | NOT NULL, DEFAULT '' | 引用变量名 |
| is_enabled | BOOLEAN | NOT NULL, DEFAULT TRUE | 是否启用 |
| status | VARCHAR(20) | NOT NULL, DEFAULT 'unchecked' | 连接状态 |
| last_test_at | DATETIME | NULL | 最后测试时间 |
| error_msg | TEXT | NULL | 错误信息 |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |

**外键**:
- `project_id` → `project(id)` ON DELETE CASCADE

**索引**:
- PRIMARY KEY (id)
- INDEX (project_id)

**设计说明**:
- 存储数据库连接信息（用于测试断言）
- 密码需要加密存储

---

## 2. ER 图

```
┌─────────────┐
│   project   │
└──────┬──────┘
       │ 1
       │
       │ N
┌──────────────────────┐
│  interfacefolder    │
└──────┬───────────────┘
       │ 1
       │ parent_id (self-ref)
       │ N
┌──────────────────────┐
│  interfacefolder    │ (children)
└──────────────────────┘

┌──────┐
│ project │
└──────┬─────┘
       │ 1
       │
       │ N
┌──────────┐
│interface │
└──────────┘

┌──────┐
│ project │
└──────┬─────┘
       │ 1
       │
       │ N
┌──────────────────┐
│projectenvironment│
└──────────────────┘

┌──────┐
│ project │
└──────┬─────┘
       │ 1
       │
       │ N
┌──────────────────┐
│projectdatasource │
└──────────────────┘
```

---

## 3. 数据字典

### 3.1 接口状态枚举 (status)

| 值 | 说明 |
|------|------|
| draft | 草稿 |
| stable | 稳定 |
| deprecated | 已废弃 |

### 3.2 HTTP 方法枚举 (method)

| 值 | 说明 |
|------|------|
| GET | 获取资源 |
| POST | 创建资源 |
| PUT | 更新资源（全量） |
| DELETE | 删除资源 |
| PATCH | 更新资源（部分） |
| HEAD | 获取响应头 |
| OPTIONS | 获取支持的方法 |

### 3.3 Body 类型枚举 (body_type)

| 值 | 说明 |
|------|------|
| none | 无请求体 |
| json | JSON 格式 |
| form-data | multipart/form-data |
| x-www-form-urlencoded | application/x-www-form-urlencoded |
| raw | 原始文本 |

### 3.4 认证类型枚举 (auth_config.type)

| 值 | 说明 |
|------|------|
| no_auth | 无认证 |
| bearer | Bearer Token |
| basic | HTTP Basic |
| api_key | API Key |
| oauth2 | OAuth 2.0 |

### 3.5 数据库类型枚举 (db_type)

| 值 | 说明 |
|------|------|
| mysql | MySQL |
| postgresql | PostgreSQL |
| mongodb | MongoDB |
| redis | Redis |

---

## 4. 数据迁移

### 4.1 现有迁移文件

**位置**: `backend/alembic/versions/`

现有项目已有数据库表结构，无需新增字段。

### 4.2 迁移命令

```bash
cd backend

# 检查当前版本
uv run alembic current

# 生成新迁移（如需新增字段）
uv run alembic revision --autogenerate -m "Add interface management fields"

# 应用迁移
uv run alembic upgrade head

# 回滚
uv run alembic downgrade -1
```

---

## 5. 数据访问层 (Repository)

### 5.1 InterfaceRepository

**位置**: `backend/app/repositories/interface_repository.py`

```python
class InterfaceRepository:
    """接口数据访问层"""

    async def create(self, data: InterfaceCreate) -> Interface:
        """创建接口"""

    async def get_by_id(self, id: int) -> Interface | None:
        """获取接口详情"""

    async def list(
        self,
        project_id: int,
        folder_id: int | None = None,
        page: int = 1,
        size: int = 10
    ) -> PageResponse[Interface]:
        """获取接口列表"""

    async def update(self, id: int, data: InterfaceUpdate) -> Interface:
        """更新接口"""

    async def delete(self, id: int) -> bool:
        """删除接口"""

    async def search(
        self,
        project_id: int,
        keyword: str | None = None,
        method: str | None = None
    ) -> list[Interface]:
        """搜索接口"""
```

### 5.2 FolderRepository

**位置**: `backend/app/repositories/folder_repository.py`

```python
class FolderRepository:
    """文件夹数据访问层"""

    async def create(self, data: FolderCreate) -> InterfaceFolder:
        """创建文件夹"""

    async def get_tree(self, project_id: int) -> list[InterfaceFolder]:
        """获取文件夹树"""

    async def delete(self, id: int) -> bool:
        """删除文件夹（检查子项）"""
```

### 5.3 EnvironmentRepository

**位置**: `backend/app/repositories/environment_repository.py`

```python
class EnvironmentRepository:
    """环境数据访问层"""

    async def create(self, data: EnvironmentCreate) -> ProjectEnvironment:
        """创建环境"""

    async def list(self, project_id: int) -> list[ProjectEnvironment]:
        """获取环境列表"""

    async def get_by_id(self, id: int) -> ProjectEnvironment | None:
        """获取环境详情"""

    async def update(self, id: int, data: EnvironmentUpdate) -> ProjectEnvironment:
        """更新环境"""

    async def delete(self, id: int) -> bool:
        """删除环境"""

    async def copy(self, id: int, new_name: str) -> ProjectEnvironment:
        """复制环境"""
```

---

## 6. 性能优化建议

### 6.1 索引优化

```sql
-- 复合索引优化查询
CREATE INDEX idx_interface_project_folder ON interface(project_id, folder_id);
CREATE INDEX idx_interface_project_method ON interface(project_id, method);

-- 覆盖索引减少回表
CREATE INDEX idx_interface_search ON interface(project_id, name, url);
```

### 6.2 查询优化

- 使用 `select_related` 减少数据库查询次数
- 分页查询避免一次性加载大量数据
- JSON 字段查询使用 PostgreSQL 的 JSONB 索引

### 6.3 缓存策略

- 环境列表缓存（变化不频繁）
- 接口树结构缓存
- 使用 Redis 缓存热点数据

---

## 7. 数据安全

### 7.1 密码加密

数据源密码使用哈希加密存储：

```python
from passlib.context import CryptContext

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

hashed_password = pwd_context.hash(password)
```

### 7.2 SQL 注入防护

- 使用 SQLModel/SQLAlchemy 参数化查询
- 禁止字符串拼接 SQL

### 7.3 数据备份

- 定期备份 PostgreSQL 数据
- 保留最近 30 天的备份

---

**文档变更记录**

| 版本 | 日期 | 作者 | 变更说明 |
|-----|------|------|---------|
| v2.0 | 2025-02-11 | Claude (Architect) | 确认现有数据库模型满足需求，补充设计文档 |
