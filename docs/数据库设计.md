# Sisyphus-X 数据库设计

**版本**: v1.0
**日期**: 2026-02-15
**架构师**: Architect Agent
**数据库**: PostgreSQL 15+

---

## 目录

- [1. 数据库架构原则](#1-数据库架构原则)
- [2. ER 图](#2-er-图)
- [3. 核心表设计](#3-核心表设计)
- [4. 索引设计](#4-索引设计)
- [5. 数据迁移策略](#5-数据迁移策略)
- [6. 性能优化](#6-性能优化)

---

## 1. 数据库架构原则

### 1.1 设计原则

基于 **Clean Architecture** 和 **DDD** 原则：

1. **数据完整性**: 使用外键约束确保数据一致性
2. **级联删除**: 合理使用 `ON DELETE CASCADE`
3. **软删除**: 核心数据使用软删除（如测试报告）
4. **时间戳**: 所有表包含 `created_at` 和 `updated_at`
5. **JSONB**: 灵活数据使用 JSONB 类型（如 headers, body）
6. **UUID**: 所有主键使用 UUID（分布式友好）
7. **命名规范**: snake_case 命名

### 1.2 技术选型

- **ORM**: SQLAlchemy 2.0 (async)
- **Schema 验证**: Pydantic v2
- **迁移工具**: Alembic
- **连接池**: asyncpg (PostgreSQL async driver)
- **备份策略**: 每日全量备份 + WAL 归档

---

## 2. ER 图

### 2.1 核心关系

```
users (用户表)
  ├─ 1:N → projects (项目表)
  ├─ 1:N → scenarios (场景表)
  ├─ 1:N → test_plans (测试计划表)
  ├─ 1:N → test_executions (测试执行表)
  └─ 1:N → global_params (全局参数表)

projects (项目表)
  ├─ 1:N → database_configs (数据库配置表)
  ├─ 1:N → interface_folders (接口目录表)
  ├─ 1:N → interfaces (接口表)
  ├─ 1:N → environments (环境表)
  ├─ 1:N → keywords (关键字表)
  └─ 1:N → datasets (测试数据集表)

interface_folders (接口目录表)
  └─ 1:N → interfaces (接口表，自关联)

scenarios (场景表)
  ├─ 1:N → scenario_steps (场景步骤表)
  ├─ 1:N → datasets (测试数据集表)
  └─ 1:N → test_reports (测试报告表)

test_plans (测试计划表)
  ├─ 1:N → plan_scenarios (计划场景关联表)
  └─ 1:N → test_executions (测试执行表)

environments (环境表)
  └─ 1:N → env_variables (环境变量表)

test_executions (测试执行表)
  └─ 1:N → execution_steps (执行步骤表)
  └─ 1:N → test_reports (测试报告表)
```

---

## 3. 核心表设计

### 3.1 用户表 (users)

**功能**: 存储用户认证信息

```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    hashed_password VARCHAR(255),  -- NULL 表示 OAuth 用户
    oauth_provider VARCHAR(50),     -- 'github' / 'google' / NULL
    oauth_id VARCHAR(255),          -- OAuth 提供商的用户 ID
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_oauth ON users(oauth_provider, oauth_id);

-- 触发器：自动更新 updated_at
CREATE TRIGGER update_users_updated_at
    BEFORE UPDATE ON users
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

**字段说明**:

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | UUID | PK | 主键 |
| email | VARCHAR(255) | UNIQUE NOT NULL | 邮箱（唯一） |
| hashed_password | VARCHAR(255) | NULL | bcrypt 哈希密码 |
| oauth_provider | VARCHAR(50) | NULL | OAuth 提供商 |
| oauth_id | VARCHAR(255) | NULL | OAuth 用户 ID |
| is_active | BOOLEAN | DEFAULT TRUE | 账户状态 |

---

### 3.2 项目表 (projects)

**功能**: 存储测试项目信息

```sql
CREATE TABLE projects (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    description TEXT,
    created_by UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(created_by, name)  -- 同一用户下项目名称唯一
);

-- 索引
CREATE INDEX idx_projects_created_by ON projects(created_by);
CREATE INDEX idx_projects_name ON projects(name);
```

**字段说明**:

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | UUID | PK | 主键 |
| name | VARCHAR(255) | NOT NULL | 项目名称 |
| description | TEXT | NULL | 项目描述 |
| created_by | UUID | FK → users.id | 创建人 |

---

### 3.3 数据库配置表 (database_configs)

**功能**: 存储项目的数据库连接配置

```sql
CREATE TABLE database_configs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    variable_name VARCHAR(255),
    db_type VARCHAR(50) NOT NULL,          -- 'MySQL' / 'PostgreSQL'
    host VARCHAR(255) NOT NULL,
    port INTEGER NOT NULL,
    initial_database VARCHAR(255),
    username VARCHAR(255) NOT NULL,
    password VARCHAR(255) NOT NULL,        -- 加密存储
    is_enabled BOOLEAN DEFAULT TRUE,
    connection_status VARCHAR(50) DEFAULT 'unknown',  -- 'connected' / 'failed' / 'unknown'
    last_tested_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(project_id, variable_name)
);

-- 索引
CREATE INDEX idx_database_configs_project_id ON database_configs(project_id);
CREATE INDEX idx_database_configs_variable_name ON database_configs(variable_name);
```

**字段说明**:

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| project_id | UUID | FK → projects.id | 所属项目 |
| name | VARCHAR(255) | NOT NULL | 连接名称 |
| variable_name | VARCHAR(255) | UNIQUE | 引用变量名 |
| db_type | VARCHAR(50) | NOT NULL | 数据库类型 |
| password | VARCHAR(255) | NOT NULL | 加密存储 |

**加密策略**: 使用 `cryptography` 库 Fernet 加密

---

### 3.4 接口目录表 (interface_folders)

**功能**: 存储接口目录结构（支持多级）

```sql
CREATE TABLE interface_folders (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    parent_id UUID REFERENCES interface_folders(id) ON DELETE SET NULL,
    name VARCHAR(255) NOT NULL,
    sort_order INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_interface_folders_project_id ON interface_folders(project_id);
CREATE INDEX idx_interface_folders_parent_id ON interface_folders(parent_id);
```

**自关联**: `parent_id` 指向同表的 `id`，实现多级目录

---

### 3.5 接口表 (interfaces)

**功能**: 存储接口定义

```sql
CREATE TABLE interfaces (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    folder_id UUID REFERENCES interface_folders(id) ON DELETE SET NULL,
    name VARCHAR(255) NOT NULL,
    method VARCHAR(10) NOT NULL,          -- 'GET' / 'POST' / 'PUT' / 'DELETE' / 'PATCH'
    url TEXT NOT NULL,
    headers JSONB,
    body JSONB,
    assertions JSONB,                     -- 断言规则数组
    sort_order INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_interfaces_project_id ON interfaces(project_id);
CREATE INDEX idx_interfaces_folder_id ON interfaces(folder_id);
CREATE INDEX idx_interfaces_method ON interfaces(method);

-- GIN 索引：加速 JSONB 查询
CREATE INDEX idx_interfaces_headers ON interfaces USING GIN (headers);
CREATE INDEX idx_interfaces_assertions ON interfaces USING GIN (assertions);
```

**JSONB 示例**:

```jsonb
-- headers
{
  "Content-Type": "application/json",
  "Authorization": "Bearer {{token}}"
}

-- assertions
[
  {
    "type": "json",
    "expression": "$.code",
    "operator": "==",
    "expected_value": 0
  },
  {
    "type": "status_code",
    "expression": "$.status",
    "operator": "==",
    "expected_value": 200
  }
]
```

---

### 3.6 环境表 (environments)

**功能**: 存储项目运行环境

```sql
CREATE TABLE environments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    base_url VARCHAR(1024),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(project_id, name)
);

-- 索引
CREATE INDEX idx_environments_project_id ON environments(project_id);
```

---

### 3.7 环境变量表 (env_variables)

**功能**: 存储环境变量和全局变量

```sql
CREATE TABLE env_variables (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    environment_id UUID NOT NULL REFERENCES environments(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    value TEXT NOT NULL,
    description TEXT,
    is_global BOOLEAN DEFAULT FALSE,      -- TRUE 表示全局变量
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(environment_id, name, is_global)
);

-- 索引
CREATE INDEX idx_env_variables_environment_id ON env_variables(environment_id);
CREATE INDEX idx_env_variables_is_global ON env_variables(is_global);
```

**全局变量**: `is_global=TRUE` 时，所有环境共享该变量

---

### 3.8 关键字表 (keywords)

**功能**: 存储自定义关键字

```sql
CREATE TABLE keywords (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID REFERENCES projects(id) ON DELETE CASCADE,  -- NULL 表示内置
    type VARCHAR(50) NOT NULL,          -- 'request' / 'assertion' / 'extract' / 'db' / 'custom'
    name VARCHAR(255) NOT NULL,
    method_name VARCHAR(255) NOT NULL,
    code TEXT NOT NULL,                 -- Python 代码块
    parameters JSONB,                   -- 入参释义
    is_builtin BOOLEAN DEFAULT FALSE,
    is_enabled BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(project_id, name)
);

-- 索引
CREATE INDEX idx_keywords_project_id ON keywords(project_id);
CREATE INDEX idx_keywords_type ON keywords(type);
CREATE INDEX idx_keywords_is_builtin ON keywords(is_builtin);
CREATE INDEX idx_keywords_is_enabled ON keywords(is_enabled);
```

**内置关键字**: `project_id=NULL` 且 `is_builtin=TRUE`

---

### 3.9 场景表 (scenarios)

**功能**: 存储测试场景

```sql
CREATE TABLE scenarios (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    priority VARCHAR(10) DEFAULT 'P2',   -- 'P0' / 'P1' / 'P2' / 'P3'
    tags JSONB,                         -- 标签数组
    variables JSONB,                    -- 场景级变量
    pre_sql TEXT,                       -- 前置 SQL
    post_sql TEXT,                      -- 后置 SQL
    created_by UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_scenarios_project_id ON scenarios(project_id);
CREATE INDEX idx_scenarios_created_by ON scenarios(created_by);
CREATE INDEX idx_scenarios_priority ON scenarios(priority);
CREATE INDEX idx_scenarios_tags ON scenarios USING GIN (tags);
```

---

### 3.10 场景步骤表 (scenario_steps)

**功能**: 存储测试场景的执行步骤

```sql
CREATE TABLE scenario_steps (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    scenario_id UUID NOT NULL REFERENCES scenarios(id) ON DELETE CASCADE,
    description TEXT,
    keyword_type VARCHAR(50) NOT NULL,
    keyword_name VARCHAR(255) NOT NULL,
    parameters JSONB,
    sort_order INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_scenario_steps_scenario_id ON scenario_steps(scenario_id);
CREATE INDEX idx_scenario_steps_sort_order ON scenario_steps(sort_order);
```

---

### 3.11 测试数据集表 (datasets)

**功能**: 存储数据驱动测试的 CSV 数据

```sql
CREATE TABLE datasets (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    scenario_id UUID REFERENCES scenarios(id) ON DELETE CASCADE,  -- 可选：关联场景
    name VARCHAR(255) NOT NULL,
    csv_data TEXT NOT NULL,             -- CSV 格式数据
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_datasets_project_id ON datasets(project_id);
CREATE INDEX idx_datasets_scenario_id ON datasets(scenario_id);
```

---

### 3.12 测试计划表 (test_plans)

**功能**: 存储测试计划

```sql
CREATE TABLE test_plans (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    created_by UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_test_plans_project_id ON test_plans(project_id);
CREATE INDEX idx_test_plans_created_by ON test_plans(created_by);
```

---

### 3.13 计划场景关联表 (plan_scenarios)

**功能**: 存储测试计划与场景的多对多关系

```sql
CREATE TABLE plan_scenarios (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    test_plan_id UUID NOT NULL REFERENCES test_plans(id) ON DELETE CASCADE,
    scenario_id UUID NOT NULL REFERENCES scenarios(id) ON DELETE CASCADE,
    dataset_id UUID REFERENCES datasets(id) ON DELETE SET NULL,
    environment_id UUID REFERENCES environments(id) ON DELETE SET NULL,
    variables JSONB,                    -- 场景变量覆盖
    sort_order INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(test_plan_id, scenario_id)
);

-- 索引
CREATE INDEX idx_plan_scenarios_test_plan_id ON plan_scenarios(test_plan_id);
CREATE INDEX idx_plan_scenarios_scenario_id ON plan_scenarios(scenario_id);
CREATE INDEX idx_plan_scenarios_sort_order ON plan_scenarios(sort_order);
```

---

### 3.14 测试执行表 (test_executions)

**功能**: 存储测试执行记录

```sql
CREATE TABLE test_executions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    test_plan_id UUID NOT NULL REFERENCES test_plans(id) ON DELETE CASCADE,
    status VARCHAR(50) DEFAULT 'running',  -- 'running' / 'completed' / 'terminated' / 'paused' / 'failed'
    started_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP,
    created_by UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_test_executions_test_plan_id ON test_executions(test_plan_id);
CREATE INDEX idx_test_executions_status ON test_executions(status);
CREATE INDEX idx_test_executions_created_by ON test_executions(created_by);
CREATE INDEX idx_test_executions_started_at ON test_executions(started_at DESC);
```

---

### 3.15 执行步骤表 (execution_steps)

**功能**: 存储测试执行的详细步骤

```sql
CREATE TABLE execution_steps (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    execution_id UUID NOT NULL REFERENCES test_executions(id) ON DELETE CASCADE,
    scenario_id UUID NOT NULL REFERENCES scenarios(id) ON DELETE CASCADE,
    status VARCHAR(50) DEFAULT 'pending',  -- 'pending' / 'running' / 'passed' / 'failed' / 'skipped'
    result JSONB,
    started_at TIMESTAMP,
    completed_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_execution_steps_execution_id ON execution_steps(execution_id);
CREATE INDEX idx_execution_steps_scenario_id ON execution_steps(scenario_id);
CREATE INDEX idx_execution_steps_status ON execution_steps(status);
```

**JSONB 示例**:

```jsonb
-- result (执行通过时)
{
  "total_steps": 10,
  "passed_steps": 10,
  "failed_steps": 0,
  "duration": 1234,
  "steps": [...]
}

-- result (执行失败时)
{
  "error": "Assertion failed",
  "step_id": "xxx",
  "expected": 200,
  "actual": 500
}
```

---

### 3.16 测试报告表 (test_reports)

**功能**: 存储测试报告（持久化）

```sql
CREATE TABLE test_reports (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    execution_id UUID NOT NULL REFERENCES test_executions(id) ON DELETE CASCADE,
    scenario_id UUID NOT NULL REFERENCES scenarios(id) ON DELETE CASCADE,
    status VARCHAR(50),                   -- 'passed' / 'failed' / 'skipped'
    duration INTEGER,                     -- 耗时（秒）
    result JSONB,                        -- 详细结果
    allure_report_path TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_test_reports_execution_id ON test_reports(execution_id);
CREATE INDEX idx_test_reports_scenario_id ON test_reports(scenario_id);
CREATE INDEX idx_test_reports_status ON test_reports(status);
CREATE INDEX idx_test_reports_created_at ON test_reports(created_at DESC);
```

**数据保留策略**: Allure 报告默认保留 30 天

---

### 3.17 全局参数表 (global_params)

**功能**: 存储全局工具函数

```sql
CREATE TABLE global_params (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    class_name VARCHAR(255) NOT NULL,
    method_name VARCHAR(255) NOT NULL,
    code TEXT NOT NULL,
    description TEXT,
    parameters JSONB,                    -- 入参释义
    return_value JSONB,                  -- 出参释义
    created_by UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(class_name, method_name)
);

-- 索引
CREATE INDEX idx_global_params_class_name ON global_params(class_name);
CREATE INDEX idx_global_params_created_by ON global_params(created_by);
```

**JSONB 示例**:

```jsonb
-- parameters
[
  {
    "name": "length",
    "type": "int",
    "description": "生成字符串的长度"
  }
]

-- return_value
{
  "type": "str",
  "description": "随机字符串"
}
```

---

## 4. 索引设计

### 4.1 索引策略

**B-tree 索引**（默认）:
- 主键、外键
- 等值查询（`=`、`IN`）
- 范围查询（`>`、`<`、`BETWEEN`）
- 排序（`ORDER BY`）

**GIN 索引**:
- JSONB 字段（`headers`、`assertions`、`tags`）
- 数组查询（`@>`、`?`、`?&`、`?|`）

### 4.2 复合索引

```sql
-- 示例：查询用户的项目列表（按更新时间排序）
CREATE INDEX idx_projects_user_updated ON projects(created_by, updated_at DESC);

-- 示例：查询执行记录（状态 + 开始时间）
CREATE INDEX idx_executions_status_started ON test_executions(status, started_at DESC);
```

### 4.3 部分索引

```sql
-- 示例：仅索引启用的关键字
CREATE INDEX idx_keywords_enabled
    ON keywords(project_id, name)
    WHERE is_enabled = TRUE;
```

---

## 5. 数据迁移策略

### 5.1 Alembic 配置

**目录结构**:

```
backend/
├── alembic/
│   ├── versions/           # 迁移脚本
│   ├── env.py             # Alembic 环境配置
│   └── script.py.mako     # 模板
├── alembic.ini            # Alembic 配置文件
└── app/
    └── models/            # SQLModel 模型
```

### 5.2 迁移命令

```bash
# 生成迁移脚本
alembic revision --autogenerate -m "描述"

# 应用迁移
alembic upgrade head

# 回滚一个版本
alembic downgrade -1

# 查看迁移历史
alembic history

# 查看当前版本
alembic current
```

### 5.3 迁移脚本示例

```python
# alembic/versions/001_initial_schema.py
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

def upgrade():
    op.create_table(
        'users',
        sa.Column('id', postgresql.UUID(as_uuid=True), primary_key=True),
        sa.Column('email', sa.String(255), nullable=False),
        sa.Column('hashed_password', sa.String(255)),
        sa.Column('oauth_provider', sa.String(50)),
        sa.Column('oauth_id', sa.String(255)),
        sa.Column('is_active', sa.Boolean(), default=True),
        sa.Column('created_at', sa.TIMESTAMP(), server_default=sa.text('CURRENT_TIMESTAMP')),
        sa.Column('updated_at', sa.TIMESTAMP(), server_default=sa.text('CURRENT_TIMESTAMP'))
    )
    op.create_index('idx_users_email', 'users', ['email'], unique=True)

def downgrade():
    op.drop_index('idx_users_email', table_name='users')
    op.drop_table('users')
```

---

## 6. 性能优化

### 6.1 连接池配置

**backend/app/core/db.py**:

```python
from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession

engine = create_async_engine(
    DATABASE_URL,
    pool_size=10,           # 连接池大小
    max_overflow=20,        # 最大溢出连接数
    pool_pre_ping=True,     # 连接前检测可用性
    echo=False              # 生产环境关闭 SQL 日志
)
```

### 6.2 查询优化

**使用 `select_in` 加载**（避免 N+1 查询）:

```python
# ❌ 错误：N+1 查询
scenarios = await session.execute(select(Scenario))
for scenario in scenarios.scalars():
    print(scenario.project.name)  # 每次都查询数据库

# ✅ 正确：使用 select_in_load
from sqlalchemy.orm import selectinload

result = await session.execute(
    select(Scenario)
    .options(selectinload(Scenario.project))
)
for scenario in result.scalars():
    print(scenario.project.name)  # 已预加载
```

### 6.3 分页优化

**使用游标分页**（大数据量场景）:

```python
# 传统分页（OFFSET 性能差）
SELECT * FROM scenarios ORDER BY created_at LIMIT 10 OFFSET 1000;

# 游标分页（性能好）
SELECT * FROM scenarios
WHERE created_at > '2026-02-15 10:00:00'
ORDER BY created_at
LIMIT 10;
```

### 6.4 JSONB 查询优化

**使用 GIN 索引**:

```sql
-- 创建 GIN 索引
CREATE INDEX idx_interfaces_headers ON interfaces USING GIN (headers);

-- 查询示例
SELECT * FROM interfaces
WHERE headers @> '{"Content-Type": "application/json"}';
```

### 6.5 数据归档

**定期清理历史数据**:

```python
# 清理 30 天前的 Allure 报告
DELETE FROM test_reports
WHERE created_at < NOW() - INTERVAL '30 days';
```

---

## 7. 数据库备份与恢复

### 7.1 备份策略

**全量备份**（每日）:

```bash
pg_dump -U sisyphus -d sisyphus -F c -f sisyphus_$(date +%Y%m%d).dump
```

**增量备份**（WAL 归档）:

```bash
# postgresql.conf
wal_level = replica
archive_mode = on
archive_command = 'cp %p /wal_archive/%f'
```

### 7.2 恢复流程

```bash
# 1. 停止应用
# 2. 恢复全量备份
pg_restore -U sisyphus -d sisyphus_new sisyphus_20260215.dump

# 3. 应用 WAL 日志
# 4. 验证数据完整性
# 5. 切换流量
```

---

## 8. 监控与告警

### 8.1 关键指标

- **连接池使用率** > 80% 告警
- **慢查询** > 1s 记录日志
- **死锁检测** 自动回滚
- **磁盘使用率** > 85% 告警
- **复制延迟** > 10s 告警

### 8.2 日志规范

**结构化日志（JSON 格式）**:

```json
{
  "timestamp": "2026-02-15T10:00:00Z",
  "level": "ERROR",
  "database": "sisyphus",
  "query": "SELECT * FROM users WHERE id = $1",
  "params": ["xxx-xxx-xxx"],
  "duration_ms": 1234,
  "error": "connection timeout"
}
```

---

## 附录

### A. 数据库初始化脚本

```bash
#!/bin/bash
# init_db.sh

# 创建数据库
psql -U postgres -c "CREATE DATABASE sisyphus;"

# 创建用户
psql -U postgres -c "CREATE USER sisyphus WITH PASSWORD 'sisyphus123';"

# 授权
psql -U postgres -c "GRANT ALL PRIVILEGES ON DATABASE sisyphus TO sisyphus;"

# 应用迁移
cd backend
alembic upgrade head
```

### B. 性能基准

| 操作 | 目标性能 | 测试方法 |
|------|----------|----------|
| 简单查询 | < 50ms | `EXPLAIN ANALYZE` |
| 复杂 JOIN | < 200ms | `EXPLAIN ANALYZE` |
| JSONB 查询 | < 100ms | `EXPLAIN ANALYZE` |
| 批量插入 | > 1000 rows/s | `COPY` 命令 |

---

**文档结束**

最后更新：2026-02-15
