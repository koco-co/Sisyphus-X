# 接口管理模块 - API 接口定义

> 版本: v2.0
> 日期: 2025-02-11
> 架构师: Claude (Architect Agent)

---

## 1. 接口管理 API

### 1.1 获取接口列表

```http
GET /api/v1/interfaces/
```

**Query 参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| page | integer | 否 | 页码，默认 1 |
| size | integer | 否 | 每页数量，默认 10，最大 100 |
| project_id | integer | 是 | 项目 ID |
| folder_id | integer | 否 | 文件夹 ID（筛选） |

**响应**:
```json
{
  "items": [
    {
      "id": 1,
      "project_id": 1,
      "folder_id": 5,
      "name": "获取用户列表",
      "url": "/api/users",
      "method": "GET",
      "status": "stable",
      "description": "获取分页的用户列表",
      "headers": {},
      "params": {},
      "body": {},
      "body_type": "json",
      "cookies": {},
      "order": 0,
      "created_at": "2025-02-11T10:00:00Z",
      "updated_at": "2025-02-11T10:00:00Z"
    }
  ],
  "total": 42,
  "page": 1,
  "size": 10,
  "pages": 5
}
```

---

### 1.2 创建接口

```http
POST /api/v1/interfaces/
```

**请求体**:
```json
{
  "project_id": 1,
  "folder_id": 5,
  "name": "创建用户",
  "url": "/api/users",
  "method": "POST",
  "status": "draft",
  "description": "创建新用户",
  "headers": {
    "Content-Type": "application/json"
  },
  "params": {},
  "body": {
    "username": "test",
    "password": "123456"
  },
  "body_type": "json",
  "cookies": {},
  "order": 0
}
```

**响应**: 创建的接口对象（同 1.1）

---

### 1.3 获取接口详情

```http
GET /api/v1/interfaces/{interface_id}
```

**路径参数**:
| 参数 | 类型 | 说明 |
|------|------|------|
| interface_id | integer | 接口 ID |

**响应**: 接口对象（同 1.1）

---

### 1.4 更新接口

```http
PUT /api/v1/interfaces/{interface_id}
```

**请求体** (部分更新):
```json
{
  "name": "获取用户列表（更新）",
  "url": "/api/users/list",
  "method": "GET",
  "headers": {
    "Authorization": "Bearer {{token}}"
  },
  "params": {
    "page": 1,
    "size": 20
  }
}
```

**响应**: 更新后的接口对象

---

### 1.5 删除接口

```http
DELETE /api/v1/interfaces/{interface_id}
```

**响应**:
```json
{
  "deleted": 1
}
```

---

### 1.6 搜索接口

```http
GET /api/v1/interfaces/search
```

**Query 参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| project_id | integer | 是 | 项目 ID |
| q | string | 否 | 搜索关键词（名称/URL） |
| method | string | 否 | HTTP 方法筛选 |
| folder_id | integer | 否 | 文件夹 ID 筛选 |
| page | integer | 否 | 页码 |
| size | integer | 否 | 每页数量 |

**响应**: 同 1.1（分页结果）

---

## 2. 文件夹管理 API

### 2.1 获取文件夹树

```http
GET /api/v1/interfaces/folders
```

**Query 参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| project_id | integer | 是 | 项目 ID |

**响应**:
```json
[
  {
    "id": 1,
    "project_id": 1,
    "name": "用户管理",
    "parent_id": null,
    "order": 0,
    "created_at": "2025-02-11T10:00:00Z"
  },
  {
    "id": 2,
    "project_id": 1,
    "name": "订单管理",
    "parent_id": null,
    "order": 1,
    "created_at": "2025-02-11T10:00:00Z"
  }
]
```

---

### 2.2 创建文件夹

```http
POST /api/v1/interfaces/folders
```

**请求体**:
```json
{
  "project_id": 1,
  "name": "用户管理",
  "parent_id": null,
  "order": 0
}
```

**响应**: 创建的文件夹对象

---

### 2.3 删除文件夹

```http
DELETE /api/v1/interfaces/folders/{folder_id}
```

**响应**:
```json
{
  "deleted": 1
}
```

**错误**:
```json
{
  "detail": "Cannot delete folder with children or interfaces"
}
```

---

## 3. 环境管理 API

### 3.1 获取环境列表

```http
GET /api/v1/projects/{project_id}/environments
```

**路径参数**:
| 参数 | 类型 | 说明 |
|------|------|------|
| project_id | integer | 项目 ID |

**响应**:
```json
[
  {
    "id": 1,
    "project_id": 1,
    "name": "开发环境",
    "domain": "https://api-dev.example.com",
    "variables": {
      "token": "dev_token_123",
      "user_id": "10001"
    },
    "headers": {
      "X-Env": "dev"
    },
    "is_preupload": false,
    "created_at": "2025-02-11T10:00:00Z",
    "updated_at": "2025-02-11T10:00:00Z"
  },
  {
    "id": 2,
    "project_id": 1,
    "name": "测试环境",
    "domain": "https://api-test.example.com",
    "variables": {
      "token": "test_token_456"
    },
    "headers": {},
    "is_preupload": false,
    "created_at": "2025-02-11T10:00:00Z",
    "updated_at": "2025-02-11T10:00:00Z"
  }
]
```

---

### 3.2 创建环境

```http
POST /api/v1/projects/{project_id}/environments
```

**请求体**:
```json
{
  "name": "生产环境",
  "domain": "https://api.example.com",
  "variables": {
    "token": "{{prod_token}}",
    "api_key": "{{api_key}}"
  },
  "headers": {
    "X-Env": "production"
  },
  "is_preupload": false
}
```

**响应**: 创建的环境对象

---

### 3.3 获取环境详情

```http
GET /api/v1/projects/{project_id}/environments/{environment_id}
```

**响应**: 环境对象

---

### 3.4 更新环境

```http
PUT /api/v1/projects/{project_id}/environments/{environment_id}
```

**请求体** (部分更新):
```json
{
  "name": "生产环境（更新）",
  "domain": "https://api-prod.example.com",
  "variables": {
    "token": "new_token"
  }
}
```

**响应**: 更新后的环境对象

---

### 3.5 删除环境

```http
DELETE /api/v1/projects/{project_id}/environments/{environment_id}
```

**响应**:
```json
{
  "deleted": 2
}
```

---

### 3.6 复制环境

```http
POST /api/v1/projects/{project_id}/environments/{environment_id}/copy
```

**请求体**:
```json
{
  "name": "测试环境副本"
}
```

**响应**: 新创建的环境对象

---

### 3.7 变量替换

```http
POST /api/v1/projects/{project_id}/environments/{environment_id}/replace
```

**请求体**:
```json
{
  "text": "Authorization: Bearer {{token}}\nURL: {{baseURL}}/api/users",
  "additional_vars": {
    "baseURL": "https://api.example.com"
  }
}
```

**响应**:
```json
{
  "original": "Authorization: Bearer {{token}}\nURL: {{baseURL}}/api/users",
  "replaced": "Authorization: Bearer dev_token_123\nURL: https://api.example.com/api/users",
  "variables_used": ["token", "baseURL"]
}
```

---

## 4. 请求执行 API

### 4.1 直接发送请求

```http
POST /api/v1/interfaces/debug/send
```

**请求体**:
```json
{
  "url": "https://api.example.com/users",
  "method": "POST",
  "headers": {
    "Content-Type": "application/json",
    "Authorization": "Bearer {{token}}"
  },
  "params": {
    "page": 1
  },
  "body": {
    "username": "test"
  },
  "files": {},
  "timeout": 10
}
```

**响应**:
```json
{
  "status_code": 200,
  "headers": {
    "Content-Type": "application/json",
    "Content-Length": "1024"
  },
  "body": {
    "code": 0,
    "message": "success",
    "data": []
  },
  "elapsed": 0.245
}
```

---

### 4.2 通过引擎执行

```http
POST /api/v1/interfaces/debug/execute-engine
```

**请求体**:
```json
{
  "interface_id": 1,
  "environment_id": 1,
  "variables": {
    "token": "test_token"
  }
}
```

**响应**:
```json
{
  "success": true,
  "result": {
    "summary": {
      "status": "success",
      "total": 1,
      "passed": 1,
      "failed": 0
    },
    "steps": [
      {
        "name": "获取用户列表",
        "status": "passed",
        "request": {
          "method": "GET",
          "url": "https://api.example.com/users"
        },
        "response": {
          "status_code": 200,
          "headers": {},
          "body": {}
        },
        "elapsed": 0.234
      }
    ]
  },
  "error": null
}
```

---

### 4.3 解析 cURL

```http
POST /api/v1/interfaces/parse-curl
```

**请求体**:
```json
{
  "curl_command": "curl -X POST https://api.example.com/users -H \"Content-Type: application/json\" -d '{\"username\":\"test\"}'"
}
```

**响应**:
```json
{
  "method": "POST",
  "url": "https://api.example.com/users",
  "headers": {
    "Content-Type": "application/json"
  },
  "params": {},
  "body": {
    "username": "test"
  },
  "body_type": "json",
  "auth": {
    "type": "no_auth"
  }
}
```

---

## 5. 数据类型定义

### 5.1 HTTP 方法枚举

```typescript
type HttpMethod = 'GET' | 'POST' | 'PUT' | 'DELETE' | 'PATCH' | 'HEAD' | 'OPTIONS'
```

### 5.2 Body 类型枚举

```typescript
type BodyType = 'none' | 'json' | 'form-data' | 'x-www-form-urlencoded' | 'raw'
```

### 5.3 接口状态枚举

```typescript
type InterfaceStatus = 'draft' | 'stable' | 'deprecated'
```

### 5.4 键值对类型

```typescript
interface KeyValuePair {
  key: string
  value: string
  enabled: boolean
}
```

### 5.5 认证配置类型

```typescript
interface AuthConfig {
  type: 'no_auth' | 'bearer' | 'basic' | 'api_key' | 'oauth2'
  token?: string
  username?: string
  password?: string
  key?: string
  value?: string
  add_to?: 'header' | 'query'
}
```

---

## 6. 错误响应格式

### 6.1 标准错误

```json
{
  "detail": "错误描述信息"
}
```

### 6.2 验证错误

```json
{
  "detail": [
    {
      "loc": ["body", "name"],
      "msg": "field required",
      "type": "value_error.missing"
    }
  ]
}
```

### 6.3 常见 HTTP 状态码

| 状态码 | 说明 |
|--------|------|
| 200 | 成功 |
| 400 | 请求参数错误 |
| 401 | 未授权 |
| 403 | 无权限 |
| 404 | 资源不存在 |
| 422 | 验证失败 |
| 500 | 服务器错误 |

---

## 7. 变量引用语法

### 7.1 语法规则

```
{{variable_name}}
```

### 7.2 支持的位置

| 位置 | 示例 |
|------|------|
| URL | `{{baseURL}}/api/users/{{userId}}` |
| Params | `?token={{token}}&size={{pageSize}}` |
| Headers | `Authorization: Bearer {{token}}` |
| Body (JSON) | `{"username": "{{username}}"}` |
| Cookies | `sessionId={{sessionId}}` |

### 7.3 变量优先级

1. 环境变量 (从当前选择的环境读取)
2. 全局变量 (未来支持)
3. 未定义变量保持原样

---

**文档变更记录**

| 版本 | 日期 | 作者 | 变更说明 |
|-----|------|------|---------|
| v2.0 | 2025-02-11 | Claude (Architect) | 根据 PRD v2.0 重新定义 API 接口 |
