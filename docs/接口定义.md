# Sisyphus-X API 接口定义

**版本**: v1.0
**日期**: 2026-02-15
**架构师**: Architect Agent

---

## 目录

- [1. 统一规范](#1-统一规范)
- [2. 用户认证模块](#2-用户认证模块)
- [3. 项目管理模块](#3-项目管理模块)
- [4. 关键字配置模块](#4-关键字配置模块)
- [5. 接口定义模块](#5-接口定义模块)
- [6. 场景编排模块](#6-场景编排模块)
- [7. 测试计划模块](#7-测试计划模块)
- [8. 测试报告模块](#8-测试报告模块)
- [9. 全局参数模块](#9-全局参数模块)
- [10. WebSocket 实时通信](#10-websocket-实时通信)
- [11. 错误处理规范](#11-错误处理规范)
- [附录](#附录)

---

## 1. 统一规范

### 1.1 API 基础 URL

```
开发环境: http://localhost:8000/api/v1
生产环境: https://api.sisyphus-x.com/api/v1
```

### 1.2 统一响应格式

#### 成功响应

```typescript
interface ApiResponse<T> {
  success: true;
  data: T;
  meta?: {
    total?: number;
    page?: number;
    limit?: number;
  };
}
```

#### 错误响应

```typescript
interface ApiError {
  success: false;
  error: string;
  detail?: string;
  code?: string;
}
```

### 1.3 HTTP 状态码

| 状态码 | 含义 | 使用场景 |
|--------|------|----------|
| 200 | OK | 请求成功 |
| 201 | Created | 资源创建成功 |
| 204 | No Content | 删除成功 |
| 400 | Bad Request | 请求参数错误 |
| 401 | Unauthorized | 未认证 |
| 403 | Forbidden | 无权限 |
| 404 | Not Found | 资源不存在 |
| 422 | Unprocessable Entity | 业务逻辑错误 |
| 500 | Internal Server Error | 服务器错误 |

### 1.4 认证方式

#### JWT Bearer Token

```http
Authorization: Bearer <JWT_TOKEN>
```

**Token 有效期**: 7 天

#### 开发模式跳过认证

环境变量 `AUTH_DISABLED=true` 时，所有接口跳过 JWT 验证。

### 1.5 分页参数

```typescript
interface PaginationParams {
  page?: number;      // 页码，默认 1
  limit?: number;     // 每页条数，默认 10
  sort?: string;      // 排序字段，如 "created_at:desc"
}
```

### 1.6 通用查询参数

```typescript
interface QueryParams extends PaginationParams {
  search?: string;    // 搜索关键词
  project_id?: string; // 项目 ID（项目相关接口）
}
```

---

## 2. 用户认证模块

### 2.1 邮箱注册

**端点**: `POST /auth/register`

**请求体**:

```typescript
interface RegisterRequest {
  email: string;      // 邮箱格式
  password: string;   // 8-20 位
  password_confirm: string; // 确认密码
}
```

**响应**: `201 Created`

```typescript
interface RegisterResponse {
  user: {
    id: string;
    email: string;
    created_at: string;
  };
  token: string;      // JWT Token
}
```

**错误响应**:

- `400`: 邮箱格式错误、密码长度不符
- `409`: 邮箱已注册

---

### 2.2 邮箱登录

**端点**: `POST /auth/login`

**请求体**:

```typescript
interface LoginRequest {
  email: string;
  password: string;
}
```

**响应**: `200 OK`

```typescript
interface LoginResponse {
  user: {
    id: string;
    email: string;
    created_at: string;
  };
  token: string;      // JWT Token
}
```

**错误响应**:

- `401`: 邮箱或密码错误

---

### 2.3 GitHub OAuth 授权

**端点**: `GET /auth/github`

**查询参数**:

```typescript
interface GitHubOAuthParams {
  redirect_uri?: string; // 回调地址
}
```

**响应**: `302 Redirect` → GitHub OAuth 页面

---

### 2.4 GitHub OAuth 回调

**端点**: `GET /auth/github/callback`

**查询参数**: GitHub OAuth 标准参数（code, state）

**响应**: `200 OK`

```typescript
interface OAuthCallbackResponse {
  user: {
    id: string;
    email: string;
    oauth_provider: "github";
    created_at: string;
  };
  token: string;      // JWT Token
}
```

---

### 2.5 Google OAuth 授权

**端点**: `GET /auth/google`

**查询参数**: 同 GitHub OAuth

**响应**: `302 Redirect` → Google OAuth 页面

---

### 2.6 Google OAuth 回调

**端点**: `GET /auth/google/callback`

**查询参数**: Google OAuth 标准参数

**响应**: `200 OK`（格式同 GitHub 回调）

---

### 2.7 获取当前用户信息

**端点**: `GET /auth/me`

**认证**: 需要 JWT Token

**响应**: `200 OK`

```typescript
interface CurrentUserResponse {
  id: string;
  email: string;
  oauth_provider?: "github" | "google";
  created_at: string;
}
```

---

## 3. 项目管理模块

### 3.1 获取项目列表

**端点**: `GET /projects`

**认证**: 需要 JWT Token

**查询参数**:

```typescript
interface ListProjectsParams extends QueryParams {
  search?: string;    // 项目名称搜索
}
```

**响应**: `200 OK`

```typescript
interface ListProjectsResponse {
  projects: Array<{
    id: string;
    name: string;
    description?: string;
    created_at: string;
    updated_at: string;
  }>;
  meta: {
    total: number;
    page: number;
    limit: number;
  };
}
```

---

### 3.2 创建项目

**端点**: `POST /projects`

**认证**: 需要 JWT Token

**请求体**:

```typescript
interface CreateProjectRequest {
  name: string;
  description?: string;
}
```

**响应**: `201 Created`

```typescript
interface ProjectResponse {
  id: string;
  name: string;
  description?: string;
  created_by: string;
  created_at: string;
  updated_at: string;
}
```

**错误响应**:

- `400`: 项目名称为空
- `409`: 项目名称已存在

---

### 3.3 获取项目详情

**端点**: `GET /projects/{id}`

**认证**: 需要 JWT Token

**路径参数**:

- `id`: 项目 ID（UUID）

**响应**: `200 OK`（同 `ProjectResponse`）

**错误响应**:

- `404`: 项目不存在

---

### 3.4 更新项目

**端点**: `PUT /projects/{id}`

**认证**: 需要 JWT Token

**请求体**:

```typescript
interface UpdateProjectRequest {
  name?: string;
  description?: string;
}
```

**响应**: `200 OK`（同 `ProjectResponse`）

---

### 3.5 删除项目

**端点**: `DELETE /projects/{id}`

**认证**: 需要 JWT Token

**响应**: `204 No Content`

**错误响应**:

- `403`: 项目下存在关联数据（场景、接口等）

---

### 3.6 获取数据库配置列表

**端点**: `GET /projects/{id}/databases`

**认证**: 需要 JWT Token

**查询参数**:

```typescript
interface ListDatabasesParams extends QueryParams {
  is_enabled?: boolean; // 启用状态筛选
}
```

**响应**: `200 OK`

```typescript
interface ListDatabasesResponse {
  databases: Array<{
    id: string;
    name: string;
    variable_name?: string;
    db_type: "MySQL" | "PostgreSQL";
    host: string;
    port: number;
    initial_database?: string;
    username: string;
    password: string;  // 脱敏显示，如 "******"
    is_enabled: boolean;
    connection_status: "connected" | "failed" | "unknown";
    last_tested_at?: string;
    created_at: string;
    updated_at: string;
  }>;
}
```

---

### 3.7 创建数据库配置

**端点**: `POST /projects/{id}/databases`

**认证**: 需要 JWT Token

**请求体**:

```typescript
interface CreateDatabaseRequest {
  name: string;
  variable_name?: string;
  db_type: "MySQL" | "PostgreSQL";
  host: string;
  port: number;
  initial_database?: string;
  username: string;
  password: string;
}
```

**响应**: `201 Created`（同数据库配置对象）

**错误响应**:

- `400`: 参数验证失败
- `409`: 变量名已存在

---

### 3.8 测试数据库连接

**端点**: `POST /projects/{id}/databases/{db_id}/test`

**认证**: 需要 JWT Token

**响应**: `200 OK`

```typescript
interface TestDatabaseResponse {
  success: boolean;
  message: string;
  latency?: number; // 连接耗时（毫秒）
}
```

---

### 3.9 更新数据库配置

**端点**: `PUT /projects/{id}/databases/{db_id}`

**认证**: 需要 JWT Token

**请求体**: 同 `CreateDatabaseRequest`（所有字段可选）

**响应**: `200 OK`

---

### 3.10 删除数据库配置

**端点**: `DELETE /projects/{id}/databases/{db_id}`

**认证**: 需要 JWT Token

**响应**: `204 No Content`

---

## 4. 关键字配置模块

### 4.1 获取关键字列表

**端点**: `GET /keywords`

**认证**: 需要 JWT Token

**查询参数**:

```typescript
interface ListKeywordsParams extends QueryParams {
  project_id?: string;    // 项目 ID（为空则返回所有内置关键字）
  type?: string;          // request / assertion / extract / db / custom
  is_builtin?: boolean;   // 是否内置
  is_enabled?: boolean;   // 启用状态
}
```

**响应**: `200 OK`

```typescript
interface ListKeywordsResponse {
  keywords: Array<{
    id: string;
    project_id?: string;  // NULL 表示内置
    type: string;
    name: string;
    method_name: string;
    code?: string;        // 内置关键字不返回代码
    parameters?: Array<{
      name: string;
      description: string;
    }>;
    is_builtin: boolean;
    is_enabled: boolean;
    created_at: string;
    updated_at: string;
  }>;
}
```

---

### 4.2 创建自定义关键字

**端点**: `POST /keywords`

**认证**: 需要 JWT Token

**请求体**:

```typescript
interface CreateKeywordRequest {
  project_id: string;
  type: "request" | "assertion" | "extract" | "db" | "custom";
  name: string;
  method_name: string;
  code: string;
  parameters?: Array<{
    name: string;
    description: string;
  }>;
}
```

**响应**: `201 Created`（同关键字对象）

---

### 4.3 获取关键字详情

**端点**: `GET /keywords/{id}`

**认证**: 需要 JWT Token

**响应**: `200 OK`（包含完整 code）

---

### 4.4 更新关键字

**端点**: `PUT /keywords/{id}`

**认证**: 需要 JWT Token

**请求体**: 同 `CreateKeywordRequest`（所有字段可选）

**响应**: `200 OK`

---

### 4.5 切换关键字启用状态

**端点**: `PATCH /keywords/{id}/toggle`

**认证**: 需要 JWT Token

**响应**: `200 OK`

```typescript
interface ToggleKeywordResponse {
  id: string;
  is_enabled: boolean;
}
```

---

### 4.6 删除关键字

**端点**: `DELETE /keywords/{id}`

**认证**: 需要 JWT Token

**响应**: `204 No Content`

**错误响应**:

- `403`: 无法删除内置关键字

---

## 5. 接口定义模块

### 5.1 获取接口目录树

**端点**: `GET /projects/{id}/interface-folders`

**认证**: 需要 JWT Token

**响应**: `200 OK`

```typescript
interface InterfaceFolderTreeResponse {
  folders: Array<{
    id: string;
    name: string;
    parent_id?: string;
    sort_order: number;
    children?: Array<...>; // 递归结构
  }>;
}
```

---

### 5.2 创建接口目录

**端点**: `POST /projects/{id}/interface-folders`

**认证**: 需要 JWT Token

**请求体**:

```typescript
interface CreateFolderRequest {
  name: string;
  parent_id?: string;
  sort_order?: number;
}
```

**响应**: `201 Created`

---

### 5.3 更新接口目录

**端点**: `PUT /projects/{id}/interface-folders/{folder_id}`

**认证**: 需要 JWT Token

**请求体**: 同 `CreateFolderRequest`（所有字段可选）

**响应**: `200 OK`

---

### 5.4 删除接口目录

**端点**: `DELETE /projects/{id}/interface-folders/{folder_id}`

**认证**: 需要 JWT Token

**响应**: `204 No Content`

**注意**: 级联删除子目录和接口

---

### 5.5 获取接口列表

**端点**: `GET /projects/{id}/interfaces`

**认证**: 需要 JWT Token

**查询参数**:

```typescript
interface ListInterfacesParams extends QueryParams {
  folder_id?: string;    // 目录 ID
  method?: string;       // GET / POST / PUT / DELETE / PATCH
  search?: string;       // 接口名称搜索
}
```

**响应**: `200 OK`

```typescript
interface ListInterfacesResponse {
  interfaces: Array<{
    id: string;
    folder_id?: string;
    name: string;
    method: string;
    url: string;
    headers?: Record<string, string>;
    body?: any;
    assertions?: Array<{
      type: string;
      expression: string;
      operator: string;
      expected_value: any;
    }>;
    created_at: string;
    updated_at: string;
  }>;
}
```

---

### 5.6 创建接口

**端点**: `POST /projects/{id}/interfaces`

**认证**: 需要 JWT Token

**请求体**:

```typescript
interface CreateInterfaceRequest {
  folder_id?: string;
  name: string;
  method: "GET" | "POST" | "PUT" | "DELETE" | "PATCH";
  url: string;
  headers?: Record<string, string>;
  body?: any;
  assertions?: Array<{
    type: string;
    expression: string;
    operator: string;
    expected_value: any;
  }>;
}
```

**响应**: `201 Created`（同接口对象）

---

### 5.7 获取接口详情

**端点**: `GET /projects/{id}/interfaces/{int_id}`

**认证**: 需要 JWT Token

**响应**: `200 OK`（同接口对象）

---

### 5.8 更新接口

**端点**: `PUT /projects/{id}/interfaces/{int_id}`

**认证**: 需要 JWT Token

**请求体**: 同 `CreateInterfaceRequest`（所有字段可选）

**响应**: `200 OK`

---

### 5.9 删除接口

**端点**: `DELETE /projects/{id}/interfaces/{int_id}`

**认证**: 需要 JWT Token

**响应**: `204 No Content`

---

### 5.10 导入 cURL

**端点**: `POST /projects/{id}/interfaces/import`

**认证**: 需要 JWT Token

**请求体**:

```typescript
interface ImportCurlRequest {
  curl: string;
  folder_id?: string;
}
```

**响应**: `201 Created`（返回解析后的接口对象）

---

### 5.11 调试接口

**端点**: `POST /projects/{id}/interfaces/debug`

**认证**: 需要 JWT Token

**请求体**:

```typescript
interface DebugInterfaceRequest {
  interface_id: string;
  environment_id?: string;
  variables?: Record<string, any>;
  files?: Array<{
    key: string;
    filename: string;
    content: string;  // Base64 编码
  }>;
}
```

**响应**: `200 OK`

```typescript
interface DebugInterfaceResponse {
  success: boolean;
  request: {
    method: string;
    url: string;
    headers: Record<string, string>;
    body?: any;
  };
  response: {
    status_code: number;
    headers: Record<string, string>;
    body: any;
  };
  duration: number;  // 耗时（毫秒）
  assertion_results?: Array<{
    type: string;
    passed: boolean;
    expected: any;
    actual: any;
  }>;
  extracted_variables?: Record<string, any>;
}
```

---

### 5.12 获取环境列表

**端点**: `GET /projects/{id}/environments`

**认证**: 需要 JWT Token

**响应**: `200 OK`

```typescript
interface ListEnvironmentsResponse {
  environments: Array<{
    id: string;
    name: string;
    base_url?: string;
    created_at: string;
    updated_at: string;
  }>;
}
```

---

### 5.13 创建环境

**端点**: `POST /projects/{id}/environments`

**认证**: 需要 JWT Token

**请求体**:

```typescript
interface CreateEnvironmentRequest {
  name: string;
  base_url?: string;
}
```

**响应**: `201 Created`

---

### 5.14 获取环境变量

**端点**: `GET /projects/{id}/environments/{env_id}/variables`

**认证**: 需要 JWT Token

**查询参数**:

```typescript
interface GetEnvVariablesParams {
  is_global?: boolean; // 是否全局变量
}
```

**响应**: `200 OK`

```typescript
interface EnvVariablesResponse {
  variables: Array<{
    id: string;
    name: string;
    value: string;
    description?: string;
    is_global: boolean;
  }>;
}
```

---

### 5.15 创建/更新环境变量

**端点**: `POST /projects/{id}/environments/{env_id}/variables`

**认证**: 需要 JWT Token

**请求体**:

```typescript
interface UpsertVariableRequest {
  name: string;
  value: string;
  description?: string;
  is_global: boolean;
}
```

**响应**: `201 Created` 或 `200 OK`

---

## 6. 场景编排模块

### 6.1 获取场景列表

**端点**: `GET /scenarios`

**认证**: 需要 JWT Token

**查询参数**:

```typescript
interface ListScenariosParams extends QueryParams {
  project_id?: string;
  priority?: "P0" | "P1" | "P2" | "P3";
  search?: string;
}
```

**响应**: `200 OK`

```typescript
interface ListScenariosResponse {
  scenarios: Array<{
    id: string;
    project_id: string;
    name: string;
    description?: string;
    priority: string;
    tags?: string[];
    created_by: string;
    created_at: string;
    updated_at: string;
  }>;
}
```

---

### 6.2 创建场景

**端点**: `POST /scenarios`

**认证**: 需要 JWT Token

**请求体**:

```typescript
interface CreateScenarioRequest {
  project_id: string;
  name: string;
  description?: string;
  priority?: "P0" | "P1" | "P2" | "P3";
  tags?: string[];
}
```

**响应**: `201 Created`（同场景对象）

---

### 6.3 获取场景详情

**端点**: `GET /scenarios/{id}`

**认证**: 需要 JWT Token

**响应**: `200 OK`

```typescript
interface ScenarioDetailResponse {
  id: string;
  project_id: string;
  name: string;
  description?: string;
  priority: string;
  tags?: string[];
  created_by: string;
  created_at: string;
  updated_at: string;
  steps: Array<{
    id: string;
    description?: string;
    keyword_type: string;
    keyword_name: string;
    parameters?: any;
    sort_order: number;
  }>;
  variables?: Record<string, any>;
  pre_sql?: string;
  post_sql?: string;
}
```

---

### 6.4 更新场景

**端点**: `PUT /scenarios/{id}`

**认证**: 需要 JWT Token

**请求体**: 同 `CreateScenarioRequest`（所有字段可选）

**响应**: `200 OK`

---

### 6.5 删除场景

**端点**: `DELETE /scenarios/{id}`

**认证**: 需要 JWT Token

**响应**: `204 No Content`

---

### 6.6 创建/更新测试步骤

**端点**: `POST /scenarios/{id}/steps`

**认证**: 需要 JWT Token

**请求体**:

```typescript
interface CreateStepRequest {
  description?: string;
  keyword_type: string;
  keyword_name: string;
  parameters?: any;
  sort_order: number;
}
```

**响应**: `201 Created` 或 `200 OK`

---

### 6.7 批量更新步骤排序

**端点**: `PUT /scenarios/{id}/steps/reorder`

**认证**: 需要 JWT Token

**请求体**:

```typescript
interface ReorderStepsRequest {
  step_ids: string[]; // 按新顺序排列的步骤 ID 数组
}
```

**响应**: `200 OK`

---

### 6.8 删除测试步骤

**端点**: `DELETE /scenarios/{id}/steps/{step_id}`

**认证**: 需要 JWT Token

**响应**: `204 No Content`

---

### 6.9 获取测试数据集列表

**端点**: `GET /scenarios/{id}/datasets`

**认证**: 需要 JWT Token

**响应**: `200 OK`

```typescript
interface ListDatasetsResponse {
  datasets: Array<{
    id: string;
    name: string;
    csv_data: string;
    created_at: string;
    updated_at: string;
  }>;
}
```

---

### 6.10 创建测试数据集

**端点**: `POST /scenarios/{id}/datasets`

**认证**: 需要 JWT Token

**请求体**:

```typescript
interface CreateDatasetRequest {
  name: string;
  csv_data: string; // CSV 格式字符串
}
```

**响应**: `201 Created`

---

### 6.11 导入 CSV

**端点**: `POST /scenarios/{id}/datasets/import`

**认证**: 需要 JWT Token

**请求体**:

```typescript
interface ImportCsvRequest {
  dataset_id: string;
  file: string; // Base64 编码的 CSV 文件
}
```

**响应**: `200 OK`

---

### 6.12 导出 CSV

**端点**: `GET /scenarios/{id}/datasets/{dataset_id}/export`

**认证**: 需要 JWT Token

**响应**: `200 OK` (CSV 文件)

---

### 6.13 调试场景

**端点**: `POST /scenarios/{id}/debug`

**认证**: 需要 JWT Token

**请求体**:

```typescript
interface DebugScenarioRequest {
  environment_id?: string;
  dataset_id?: string;
  variables?: Record<string, any>;
}
```

**响应**: `200 OK`

```typescript
interface DebugScenarioResponse {
  execution_id: string;
  report_url: string; // Allure 报告 URL
  results: Array<{
    step_id: string;
    status: "passed" | "failed";
    duration: number;
    error?: string;
  }>;
}
```

---

## 7. 测试计划模块

### 7.1 获取测试计划列表

**端点**: `GET /plans`

**认证**: 需要 JWT Token

**查询参数**:

```typescript
interface ListPlansParams extends QueryParams {
  project_id?: string;
  search?: string;
}
```

**响应**: `200 OK`

```typescript
interface ListPlansResponse {
  plans: Array<{
    id: string;
    project_id: string;
    name: string;
    description?: string;
    created_by: string;
    created_at: string;
    updated_at: string;
  }>;
}
```

---

### 7.2 创建测试计划

**端点**: `POST /plans`

**认证**: 需要 JWT Token

**请求体**:

```typescript
interface CreatePlanRequest {
  project_id: string;
  name: string;
  description?: string;
}
```

**响应**: `201 Created`（同计划对象）

---

### 7.3 获取测试计划详情

**端点**: `GET /plans/{id}`

**认证**: 需要 JWT Token

**响应**: `200 OK`

```typescript
interface PlanDetailResponse {
  id: string;
  project_id: string;
  name: string;
  description?: string;
  created_by: string;
  created_at: string;
  updated_at: string;
  scenarios: Array<{
    id: string;
    scenario_id: string;
    scenario_name: string;
    dataset_id?: string;
    dataset_name?: string;
    environment_id?: string;
    environment_name?: string;
    variables?: Record<string, any>;
    sort_order: number;
  }>;
}
```

---

### 7.4 添加测试场景到计划

**端点**: `POST /plans/{id}/scenarios`

**认证**: 需要 JWT Token

**请求体**:

```typescript
interface AddScenarioToPlanRequest {
  scenario_id: string;
  dataset_id?: string;
  environment_id?: string;
  variables?: Record<string, any>;
  sort_order?: number;
}
```

**响应**: `201 Created`

---

### 7.5 更新计划中的场景

**端点**: `PUT /plans/{id}/scenarios/{plan_scenario_id}`

**认证**: 需要 JWT Token

**请求体**: 同 `AddScenarioToPlanRequest`（所有字段可选）

**响应**: `200 OK`

---

### 7.6 批量更新场景排序

**端点**: `PUT /plans/{id}/scenarios/reorder`

**认证**: 需要 JWT Token

**请求体**: 同场景排序

**响应**: `200 OK`

---

### 7.7 删除计划中的场景

**端点**: `DELETE /plans/{id}/scenarios/{plan_scenario_id}`

**认证**: 需要 JWT Token

**响应**: `204 No Content`

---

### 7.8 执行测试计划

**端点**: `POST /plans/{id}/execute`

**认证**: 需要 JWT Token

**请求体**:

```typescript
interface ExecutePlanRequest {
  scenario_ids?: string[]; // 可选：指定要执行的场景 ID
}
```

**响应**: `202 Accepted`

```typescript
interface ExecutePlanResponse {
  execution_id: string;
  status: "running";
  started_at: string;
}
```

---

### 7.9 获取执行记录列表

**端点**: `GET /plans/{id}/executions`

**认证**: 需要 JWT Token

**查询参数**:

```typescript
interface ListExecutionsParams extends QueryParams {
  status?: string;
}
```

**响应**: `200 OK`

```typescript
interface ListExecutionsResponse {
  executions: Array<{
    id: string;
    test_plan_id: string;
    status: string;
    started_at: string;
    completed_at?: string;
    created_by: string;
    created_at: string;
  }>;
}
```

---

### 7.10 获取执行记录详情

**端点**: `GET /plans/{id}/executions/{execution_id}`

**认证**: 需要 JWT Token

**响应**: `200 OK`

```typescript
interface ExecutionDetailResponse {
  id: string;
  test_plan_id: string;
  status: string;
  started_at: string;
  completed_at?: string;
  created_by: string;
  steps: Array<{
    id: string;
    scenario_id: string;
    scenario_name: string;
    status: string;
    result?: any;
    started_at?: string;
    completed_at?: string;
  }>;
}
```

---

### 7.11 终止执行

**端点**: `POST /plans/{id}/terminate`

**认证**: 需要 JWT Token

**请求体**:

```typescript
interface TerminateExecutionRequest {
  execution_id: string;
}
```

**响应**: `200 OK`

---

### 7.12 暂停执行

**端点**: `POST /plans/{id}/pause`

**认证**: 需要 JWT Token

**请求体**: 同终止

**响应**: `200 OK`

---

### 7.13 恢复执行

**端点**: `POST /plans/{id}/resume`

**认证**: 需要 JWT Token

**请求体**: 同终止

**响应**: `200 OK`

---

## 8. 测试报告模块

### 8.1 获取测试报告列表

**端点**: `GET /reports`

**认证**: 需要 JWT Token

**查询参数**:

```typescript
interface ListReportsParams extends QueryParams {
  execution_id?: string;
  scenario_id?: string;
  status?: string;
}
```

**响应**: `200 OK`

```typescript
interface ListReportsResponse {
  reports: Array<{
    id: string;
    execution_id: string;
    scenario_id: string;
    scenario_name: string;
    status: string;
    duration: number;
    created_at: string;
  }>;
}
```

---

### 8.2 获取测试报告详情

**端点**: `GET /reports/{id}`

**认证**: 需要 JWT Token

**响应**: `200 OK`

```typescript
interface ReportDetailResponse {
  id: string;
  execution_id: string;
  scenario_id: string;
  scenario_name: string;
  status: string;
  duration: number;
  result: {
    total_steps: number;
    passed_steps: number;
    failed_steps: number;
    skipped_steps: number;
    steps: Array<any>;
  };
  allure_report_path?: string;
  created_at: string;
}
```

---

### 8.3 获取 Allure 报告 URL

**端点**: `GET /reports/{id}/allure`

**认证**: 需要 JWT Token

**响应**: `200 OK`

```typescript
interface AllureReportResponse {
  url: string;
}
```

---

### 8.4 导出测试报告

**端点**: `POST /reports/{id}/export`

**认证**: 需要 JWT Token

**请求体**:

```typescript
interface ExportReportRequest {
  format: "pdf" | "html" | "json";
}
```

**响应**: `200 OK` (文件流)

---

### 8.5 删除测试报告

**端点**: `DELETE /reports/{id}`

**认证**: 需要 JWT Token

**响应**: `204 No Content`

---

## 9. 全局参数模块

### 9.1 获取全局参数列表

**端点**: `GET /global-params`

**认证**: 需要 JWT Token

**查询参数**:

```typescript
interface ListGlobalParamsParams extends QueryParams {
  class_name?: string; // 按类名筛选
}
```

**响应**: `200 OK`

```typescript
interface ListGlobalParamsResponse {
  global_params: Array<{
    id: string;
    class_name: string;
    method_name: string;
    description?: string;
    parameters?: Array<{
      name: string;
      type: string;
      description: string;
    }>;
    return_value?: {
      type: string;
      description: string;
    };
    created_by: string;
    created_at: string;
    updated_at: string;
  }>;
}
```

---

### 9.2 创建全局参数

**端点**: `POST /global-params`

**认证**: 需要 JWT Token

**请求体**:

```typescript
interface CreateGlobalParamRequest {
  code: string; // Python 代码块
}
```

**响应**: `201 Created`

```typescript
interface CreateGlobalParamResponse {
  id: string;
  class_name: string;
  method_name: string;
  description?: string;
  parameters?: Array<any>;
  return_value?: any;
  created_at: string;
}
```

**注意**: 后端自动解析 Google docstring 提取元数据

---

### 9.3 获取全局参数详情

**端点**: `GET /global-params/{id}`

**认证**: 需要 JWT Token

**响应**: `200 OK`（包含完整 code）

---

### 9.4 更新全局参数

**端点**: `PUT /global-params/{id}`

**认证**: 需要 JWT Token

**请求体**: 同 `CreateGlobalParamRequest`

**响应**: `200 OK`

---

### 9.5 删除全局参数

**端点**: `DELETE /global-params/{id}`

**认证**: 需要 JWT Token

**响应**: `204 No Content`

---

## 10. WebSocket 实时通信

### 10.1 执行进度推送

**端点**: `WS /ws/executions/{execution_id}`

**认证**: JWT Token 作为查询参数或子协议

**消息格式**:

```typescript
interface ExecutionProgressMessage {
  type: "progress" | "step_started" | "step_completed" | "completed" | "failed";
  data: {
    execution_id: string;
    timestamp: string;
    // 根据 type 不同，data 内容不同
  };
}
```

#### 消息类型

##### 1. 进度更新 (progress)

```typescript
interface ProgressData {
  execution_id: string;
  timestamp: string;
  total_scenarios: number;
  completed_scenarios: number;
  failed_scenarios: number;
  running_scenarios: number;
  progress_percentage: number;
}
```

##### 2. 步骤开始 (step_started)

```typescript
interface StepStartedData {
  execution_id: string;
  timestamp: string;
  scenario_id: string;
  scenario_name: string;
  step_id: string;
  step_description?: string;
}
```

##### 3. 步骤完成 (step_completed)

```typescript
interface StepCompletedData {
  execution_id: string;
  timestamp: string;
  scenario_id: string;
  step_id: string;
  status: "passed" | "failed" | "skipped";
  duration: number;
  result?: any;
  error?: string;
}
```

##### 4. 执行完成 (completed)

```typescript
interface ExecutionCompletedData {
  execution_id: string;
  timestamp: string;
  status: "completed";
  total_duration: number;
  total_scenarios: number;
  passed_scenarios: number;
  failed_scenarios: number;
  report_url: string;
}
```

##### 5. 执行失败 (failed)

```typescript
interface ExecutionFailedData {
  execution_id: string;
  timestamp: string;
  status: "failed";
  error: string;
}
```

---

### 10.2 心跳机制

**客户端 → 服务器**:

```typescript
interface PingMessage {
  type: "ping";
}
```

**服务器 → 客户端**:

```typescript
interface PongMessage {
  type: "pong";
  timestamp: string;
}
```

**心跳间隔**: 30 秒

---

### 10.3 连接管理

**连接生命周期**:

1. 客户端连接 WebSocket
2. 服务器验证 JWT Token
3. 验证成功后，订阅执行进度
4. 实时推送进度消息
5. 执行完成或客户端断开连接时，取消订阅

**错误处理**:

- `401`: JWT Token 无效
- `404`: 执行记录不存在
- `403`: 无权限访问该执行记录

---

## 11. 错误处理规范

### 11.1 错误处理原则

1. **统一格式**: 所有错误响应使用统一格式
2. **清晰描述**: 错误信息对开发者友好，避免暴露敏感信息
3. **日志追踪**: 每个错误包含唯一的 request_id 用于日志追踪
4. **分级处理**: 区分客户端错误（4xx）和服务器错误（5xx）
5. **国际化**: 错误信息支持多语言（使用 i18next）

### 11.2 错误响应格式

#### 标准错误响应

```typescript
interface ApiErrorResponse {
  success: false;
  error: string;              // 错误类型（用户可见）
  code: string;               // 错误码（用于程序识别）
  detail?: {
    field?: string;           // 错误字段（表单验证失败时）
    message?: string;         // 详细错误信息
    docs_url?: string;        // 文档链接
  };
  request_id: string;         // 请求追踪 ID
  timestamp: string;          // 错误发生时间
}
```

#### 错误响应示例

```json
{
  "success": false,
  "error": "Validation failed",
  "code": "VALIDATION_ERROR",
  "detail": {
    "field": "email",
    "message": "Invalid email format"
  },
  "request_id": "req_abc123",
  "timestamp": "2026-02-15T10:30:00Z"
}
```

### 11.3 错误码体系

#### 错误码格式

```
<模块>_<类型>_<序号>
```

- **模块**: AUTH（认证）、PROJ（项目）、INTF（接口）、SCEN（场景）、PLAN（计划）、EXEC（执行）
- **类型**: 001（参数错误）、002（不存在）、003（已存在）、004（权限不足）、005（业务逻辑错误）
- **序号**: 3 位数字

#### 完整错误码列表

| 错误码 | HTTP 状态码 | 错误类型 | 说明 |
|--------|------------|----------|------|
| **认证模块** ||||
| `AUTH_001` | 401 | Token 无效或过期 | JWT Token 验证失败 |
| `AUTH_002` | 401 | 邮箱或密码错误 | 登录凭证错误 |
| `AUTH_003` | 409 | 邮箱已注册 | 注册时邮箱冲突 |
| `AUTH_004` | 400 | 密码格式错误 | 密码长度或格式不符合要求 |
| `AUTH_005` | 403 | OAuth 提供商不支持 | 不支持的 OAuth 类型 |
| **项目模块** ||||
| `PROJ_001` | 404 | 项目不存在 | 查询的项目 ID 无效 |
| `PROJ_002` | 409 | 项目名称已存在 | 同一用户下项目名称重复 |
| `PROJ_003` | 403 | 无法删除项目 | 项目下存在关联数据 |
| `PROJ_004` | 400 | 项目名称为空 | 必填字段验证失败 |
| `PROJ_005` | 403 | 无权限访问项目 | 非项目成员 |
| **数据库配置模块** ||||
| `DB_001` | 422 | 数据库连接失败 | 连接测试失败 |
| `DB_002` | 409 | 变量名已存在 | 同一项目下变量名重复 |
| `DB_003` | 400 | 连接参数错误 | host、port 等参数验证失败 |
| `DB_004` | 500 | 密码加密失败 | 加密服务异常 |
| **接口模块** ||||
| `INTF_001` | 404 | 接口不存在 | 查询的接口 ID 无效 |
| `INTF_002` | 400 | cURL 解析失败 | cURL 命令格式错误 |
| `INTF_003` | 404 | 接口目录不存在 | 查询的目录 ID 无效 |
| `INTF_004` | 409 | 目录名称重复 | 同一级目录下名称重复 |
| `INTF_005` | 422 | 接口调试失败 | 调试执行失败 |
| **场景模块** ||||
| `SCEN_001` | 404 | 场景不存在 | 查询的场景 ID 无效 |
| `SCEN_002` | 400 | 步骤参数错误 | 关键字参数验证失败 |
| `SCEN_003` | 422 | 场景调试失败 | 调试执行失败 |
| `SCEN_004` | 400 | CSV 格式错误 | CSV 数据解析失败 |
| `SCEN_005` | 409 | 数据集名称重复 | 同一场景下数据集名称重复 |
| **测试计划模块** ||||
| `PLAN_001` | 404 | 测试计划不存在 | 查询的计划 ID 无效 |
| `PLAN_002` | 409 | 场景已添加 | 场景已在计划中 |
| `PLAN_003` | 400 | 计划名称为空 | 必填字段验证失败 |
| `PLAN_004` | 409 | 计划名称重复 | 同一项目下计划名称重复 |
| **执行模块** ||||
| `EXEC_001` | 404 | 执行记录不存在 | 查询的执行 ID 无效 |
| `EXEC_002` | 422 | 执行状态不允许 | 当前状态不允许该操作 |
| `EXEC_003` | 500 | 执行器调用失败 | sisyphus-api-engine 调用失败 |
| `EXEC_004` | 409 | 执行已在运行 | 重复执行 |
| `EXEC_005` | 500 | YAML 生成失败 | 场景转 YAML 失败 |
| **全局参数模块** ||||
| `GLOBAL_001` | 409 | 方法名已存在 | 同一类下方法名重复 |
| `GLOBAL_002` | 400 | 代码解析失败 | docstring 解析失败 |
| `GLOBAL_003` | 400 | 代码执行失败 | 全局参数代码有语法错误 |
| **通用错误** ||||
| `COMMON_001` | 429 | 速率限制 | 超出 API 调用频率限制 |
| `COMMON_002` | 500 | 服务器内部错误 | 未捕获的异常 |
| `COMMON_003` | 503 | 服务不可用 | 数据库或外部服务不可用 |
| `COMMON_004` | 413 | 请求体过大 | 超过最大请求大小 |
| `COMMON_005` | 415 | 不支持的媒体类型 | Content-Type 错误 |

### 11.4 错误日志规范

#### 日志格式

```json
{
  "timestamp": "2026-02-15T10:30:00Z",
  "level": "ERROR",
  "request_id": "req_abc123",
  "user_id": "user_123",
  "method": "POST",
  "path": "/api/v1/auth/login",
  "status_code": 401,
  "error_code": "AUTH_002",
  "error_message": "Invalid email or password",
  "stack_trace": "...",
  "context": {
    "email": "user@example.com",
    "ip": "192.168.1.1",
    "user_agent": "Mozilla/5.0..."
  }
}
```

#### 日志级别

| 级别 | 使用场景 | 示例 |
|------|----------|------|
| DEBUG | 调试信息 | SQL 查询、函数入参 |
| INFO | 关键操作 | 用户登录、项目创建 |
| WARNING | 警告信息 | 重复操作、即将废弃的功能 |
| ERROR | 错误信息 | 业务逻辑错误、外部服务失败 |
| CRITICAL | 严重错误 | 数据库连接失败、服务不可用 |

### 11.5 错误处理最佳实践

#### 后端实现

```python
from fastapi import Request, status
from fastapi.responses import JSONResponse
from sqlalchemy.exc import IntegrityError
import uuid

class AppException(Exception):
    """应用异常基类"""
    def __init__(
        self,
        error: str,
        code: str,
        status_code: int = 400,
        detail: dict | None = None,
    ):
        self.error = error
        self.code = code
        self.status_code = status_code
        self.detail = detail

async def app_exception_handler(request: Request, exc: AppException):
    """应用异常处理器"""
    return JSONResponse(
        status_code=exc.status_code,
        content={
            "success": False,
            "error": exc.error,
            "code": exc.code,
            "detail": exc.detail,
            "request_id": str(uuid.uuid4()),
            "timestamp": datetime.now().isoformat(),
        },
    )

async def generic_exception_handler(request: Request, exc: Exception):
    """通用异常处理器"""
    logger.error(f"Unhandled exception: {exc}", exc_info=True)
    return JSONResponse(
        status_code=500,
        content={
            "success": False,
            "error": "Internal server error",
            "code": "COMMON_002",
            "request_id": str(uuid.uuid4()),
            "timestamp": datetime.now().isoformat(),
        },
    )
```

#### 前端处理

```typescript
// api/client.ts
import axios, { AxiosError } from 'axios'

interface ApiErrorResponse {
  success: false
  error: string
  code: string
  detail?: {
    field?: string
    message?: string
  }
  request_id: string
  timestamp: string
}

apiClient.interceptors.response.use(
  (response) => response,
  (error: AxiosError<ApiErrorResponse>) => {
    const errorData = error.response?.data

    if (errorData) {
      // 业务错误
      switch (errorData.code) {
        case 'AUTH_001':
          // Token 过期，跳转登录
          localStorage.removeItem('sisyphus-token')
          window.location.href = '/login'
          break
        case 'COMMON_001':
          // 速率限制
          toast.error(`请求过于频繁，请 ${errorData.retry_after} 秒后重试`)
          break
        default:
          toast.error(errorData.error)
      }
    } else {
      // 网络错误
      toast.error('网络连接失败，请检查网络')
    }

    return Promise.reject(error)
  }
)
```

### 11.6 错误告警规则

#### 告警级别

| 级别 | 触发条件 | 通知方式 |
|------|----------|----------|
| P0 - 严重 | 错误率 > 10% 或 服务不可用 | 电话 + 短信 + 邮件 |
| P1 - 高 | 错误率 > 5% 或 CRITICAL 日志 | 短信 + 邮件 |
| P2 - 中 | 错误率 > 1% 或 ERROR 日志 | 邮件 |
| P3 - 低 | 错误率 > 0.1% | 仅记录 |

#### 告警场景

1. **认证失败**: 5 分钟内超过 100 次 AUTH_002 错误
2. **数据库异常**: 任何 DB_001 或 CRITICAL 级别日志
3. **执行失败**: EXEC_003 错误率 > 5%
4. **服务不可用**: 503 错误率 > 1%
5. **速率限制**: COMMON_001 错误率 > 10%

---

## 附录

### A. 错误码列表

| 错误码 | 含义 | HTTP 状态码 |
|--------|------|-------------|
| `AUTH_001` | Token 无效或过期 | 401 |
| `AUTH_002` | 邮箱或密码错误 | 401 |
| `AUTH_003` | 邮箱已注册 | 409 |
| `PROJ_001` | 项目不存在 | 404 |
| `PROJ_002` | 项目名称已存在 | 409 |
| `PROJ_003` | 无法删除有关联数据的项目 | 403 |
| `DB_001` | 数据库连接失败 | 422 |
| `DB_002` | 变量名已存在 | 409 |
| `KW_001` | 关键字不存在 | 404 |
| `KW_002` | 无法删除内置关键字 | 403 |
| `INTF_001` | 接口不存在 | 404 |
| `INTF_002` | cURL 解析失败 | 400 |
| `SCEN_001` | 场景不存在 | 404 |
| `PLAN_001` | 测试计划不存在 | 404 |
| `EXEC_001` | 执行记录不存在 | 404 |
| `EXEC_002` | 执行状态不允许该操作 | 422 |

---

### B. 通用错误响应格式

```typescript
interface ApiErrorResponse {
  success: false;
  error: string;
  code?: string;
  detail?: {
    field?: string;
    message?: string;
  };
  request_id: string;  // 用于日志追踪
}
```

---

### C. 速率限制

| 接口类型 | 速率限制 |
|----------|----------|
| 认证接口 | 10 次/分钟/IP |
| CRUD 接口 | 100 次/分钟/用户 |
| 执行接口 | 20 次/分钟/用户 |
| WebSocket | 5 个连接/用户 |

**超出限制响应**:

```typescript
interface RateLimitResponse {
  success: false;
  error: "Rate limit exceeded";
  retry_after: number; // 秒
}
```

---

### D. API 版本策略

- **当前版本**: v1
- **版本前缀**: `/api/v1`
- **向后兼容**: v1 API 保持向后兼容，至少 6 个月
- **弃用通知**: 通过响应头 `X-API-Deprecation` 通知

---

**文档结束**

最后更新：2026-02-15
