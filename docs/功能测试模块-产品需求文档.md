# 功能测试用例管理模块 - 产品需求文档 (PRD)

> **文档版本**: v1.0
> **创建日期**: 2025-01-30
> **产品**: Sisyphus X - AI驱动测试平台
> **目标**: 打造智能化的测试用例管理平台，支持AI辅助生成、管理、评审测试用例

---

## 一、产品概述

### 1.1 业务背景

当前测试团队面临的核心痛点：
- **需求碎片化**：产品需求常以图片、碎片化描述提供，缺乏结构化文档
- **用例编写效率低**：手动编写测试用例耗时，容易遗漏测试点
- **知识无法沉淀**：历史用例格式不统一，难以复用和参考
- **评审成本高**：用例评审缺乏可视化工具，沟通效率低
- **工具割裂**：需要在不同平台间切换（如禅道、Excel、思维导图工具）

### 1.2 产品目标

构建一个**AI驱动的功能测试用例管理平台**，实现：

1. **智能化需求理解**：AI辅助将碎片化需求转化为结构化文档
2. **自动化用例生成**：基于需求文档和历史知识库自动生成高质量测试用例
3. **多模态展示**：支持表格、思维导图等多种展示模式
4. **无缝工具集成**：支持导出到禅道、Excel等主流工具
5. **知识沉淀复用**：历史用例作为知识库，持续提升生成质量

### 1.3 核心价值主张

> **"让AI成为测试工程师的智能助手，而非替代者"**

- **效率提升**：用例编写时间减少 70%
- **质量保障**：AI辅助发现测试盲点，覆盖率提升 40%
- **知识复用**：历史用例标准化存储，新员工上手更快
- **协作流畅**：需求-用例-执行全链路可追溯

---

## 二、用户角色与使用场景

### 2.1 核心用户角色

| 角色 | 职责 | 核心诉求 |
|------|------|----------|
| **测试工程师** | 编写、执行测试用例 | 快速生成高质量用例，减少重复劳动 |
| **测试负责人** | 用例评审、质量把控 | 用例结构清晰，评审高效，可追溯 |
| **产品经理** | 提供需求文档 | 需求传递准确，测试点覆盖全面 |
| **AI配置管理员** | 管理AI配置 | 灵活切换AI厂商，成本可控 |

### 2.2 典型使用场景

#### 场景1：迭代需求测试用例生成
**角色**：测试工程师小王
**流程**：
1. 产品经理在群里发了3张截图和一段需求描述
2. 小王打开平台，创建新的需求分析任务
3. 上传截图和需求描述，AI开始多轮对话引导需求澄清
4. AI识别出5个风险点，小王逐一确认后补充到需求文档
5. 需求定稿后，AI基于历史用例知识库生成测试点
6. 测试点确认后，自动生成50条测试用例
7. 切换到思维导图模式，邀请团队评审
8. 导出CSV导入禅道，开始执行

**耗时**：传统方式需2天，AI辅助仅需2小时

#### 场景2：历史用例知识库查询
**角色**：新入职测试工程师小李
**流程**：
1. 接到"用户登录"模块的测试任务
2. 在知识库中搜索"登录"相关用例
3. 查看到历史20条登录相关用例，参考优先级和边界条件设计
4. 基于模板快速生成新用例

#### 场景3：用例评审会
**角色**：测试负责人、产品经理、开发团队
**流程**：
1. 测试负责人切换到思维导图模式
2. 投屏展示用例结构（模块 → 页面 → 用例）
3. 实时展开/折叠分支，聚焦讨论特定模块
4. 在线评论和标注，记录评审意见
5. 评审通过后锁定版本

---

## 三、功能需求详细设计

### 3.1 功能架构图

```
功能测试用例管理模块
│
├── 1. AI配置管理
│   ├── AI厂商配置 (OpenAI/Claude/通义千问/文心一言等)
│   ├── API Key管理
│   ├── 模型参数配置 (温度、最大token等)
│   └── 使用量统计与成本监控
│
├── 2. 需求管理
│   ├── 需求创建 (支持富文本、图片上传、文件导入)
│   ├── AI需求澄清 (多轮对话交互)
│   ├── 风险识别与确认
│   ├── 需求版本管理
│   └── 需求-用例关联
│
├── 3. 测试点管理
│   ├── 基于需求文档生成测试点
│   ├── 测试点分类管理 (功能/性能/安全/兼容性)
│   ├── 测试点优先级评估
│   └── 测试点覆盖率分析
│
├── 4. 测试用例管理
│   ├── 用例生成 (AI生成 + 手动创建)
│   ├── 用例编辑 (表格/卡片视图)
│   ├── 用例版本控制
│   ├── 用例标签与分类
│   └── 批量操作 (导入/导出/复制/删除)
│
├── 5. 可视化与评审
│   ├── 表格视图 (类似禅道格式)
│   ├── 思维导图视图 (模块 → 页面 → 用例)
│   ├── 统计图表 (覆盖率、优先级分布)
│   └── 在线评审与评论
│
├── 6. 导出与集成
│   ├── 导出格式 (CSV/Excel/Markdown/PDF)
│   ├── 禅道格式映射 (需求ID、模块ID自动拼接)
│   ├── 批量导出
│   └── 导入历史用例 (Excel/CSV)
│
└── 7. 知识库管理
    ├── 历史用例向量化
    ├── 语义搜索
    ├── 用例模板管理
    └── 知识库统计
```

### 3.2 核心功能详细设计

#### 3.2.1 AI配置管理

**功能描述**：用户可以配置多家AI厂商的API Key，灵活切换使用。

**界面设计**：
```
┌─────────────────────────────────────────────────────┐
│  AI配置管理                                    [保存] │
├─────────────────────────────────────────────────────┤
│                                                      │
│  默认AI模型: [OpenAI GPT-4 ▼]                       │
│                                                      │
│  ┌─ 已配置的AI厂商 ─────────────────────────────┐  │
│  │                                              │  │
│  │  OpenAI          [✓ 已启用]  [编辑] [删除]   │  │
│  │  └─ API Key: sk-...xxxx                     │  │
│  │  └─ 模型: GPT-4 Turbo                       │  │
│  │                                              │  │
│  │  Anthropic       [✗ 未启用]  [编辑] [启用]  │  │
│  │  └─ API Key: (未配置)                       │  │
│  │                                              │  │
│  │  阿里云通义千问    [✓ 已启用]  [编辑] [删除]  │  │
│  │  └─ API Key: sk-...xxxx                     │  │
│  │  └─ 模型: qwen-max                          │  │
│  │                                              │  │
│  └──────────────────────────────────────────────┘  │
│                                                      │
│  [+ 添加新的AI厂商]                                  │
│                                                      │
│  ┌─ 本月使用统计 ───────────────────────────────┐  │
│  │  OpenAI: 1,234 tokens ($0.06)               │  │
│  │  通义千问: 5,678 tokens (¥0.28)              │  │
│  │  总计: ¥1.50                                │  │
│  └──────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────┘
```

**支持的AI厂商**：
- OpenAI (GPT-4, GPT-3.5)
- Anthropic (Claude 3 Opus/Sonnet)
- 阿里云 (通义千问)
- 百度 (文心一言)
- 智谱AI (ChatGLM)
- Moonshot (Kimi)

**配置项**：
- API Key
- API Endpoint (支持自定义)
- 模型名称
- Temperature (0-1, 默认0.7)
- Max Tokens (默认4000)
- 超时时间 (默认30s)

**数据模型**：
```python
class AIProviderConfig(SQLModel, table=True):
    __tablename__ = "ai_provider_configs"

    id: int = Field(primary_key=True)
    provider_name: str  # OpenAI/Anthropic/等
    provider_type: str  # openai/anthropic/qwen等
    api_key: str  # 加密存储
    api_endpoint: Optional[str]  # 自定义endpoint
    model_name: str
    temperature: float = 0.7
    max_tokens: int = 4000
    is_enabled: bool = True
    is_default: bool = False
    user_id: int  # 关联用户
    created_at: datetime
    updated_at: datetime
```

#### 3.2.2 需求管理

**功能描述**：支持创建需求文档，AI辅助澄清碎片化需求，生成结构化文档。

**创建需求流程**：

```
┌─────────────────────────────────────────────────────┐
│  创建新需求                                          │
├─────────────────────────────────────────────────────┤
│                                                      │
│  需求ID: [REQ-2025-001        ]  (自动生成/手动输入) │
│  需求名称: [用户登录功能优化       ]                 │
│  所属模块: [用户管理模块 ▼]  (禅道模块ID: 101)      │
│  迭代版本: [v2.5.0                              ]   │
│  优先级: [高 ▼]                                      │
│                                                      │
│  ┌─ 需求描述 ───────────────────────────────────┐  │
│  │                                              │  │
│  │  [富文本编辑器]                               │  │
│  │                                              │  │
│  │  支持上传图片、附件 (拖拽或点击上传)           │  │
│  │                                              │  │
│  └──────────────────────────────────────────────┘  │
│                                                      │
│  附件: [Screenshot1.png] [Screenshot2.png] [...]    │
│                                                      │
│  ┌─ AI辅助需求澄清 ─────────────────────────────┐  │
│  │  [✓] 启用AI辅助澄清                          │  │
│  │                                              │  │
│  │  AI将帮助你:                                  │  │
│  │  • 补充需求的完整性                           │  │
│  │  • 识别潜在的逻辑漏洞                         │  │
│  │  • 发现边界条件和异常场景                     │  │
│  │  • 提示风险点供你确认                         │  │
│  │                                              │  │
│  └──────────────────────────────────────────────┘  │
│                                                      │
│              [保存草稿]  [开始AI澄清]                │
└─────────────────────────────────────────────────────┘
```

**AI需求澄清界面**（多轮对话）：

```
┌─────────────────────────────────────────────────────┐
│  AI需求澄清 - 用户登录功能优化              [结束] │
├─────────────────────────────────────────────────────┤
│                                                      │
│  ┌─ 左侧：需求文档预览 ──────┐  ┌─ 右侧：AI对话 ─┐  │
│  │                            │  │                 │  │
│  │  ## 需求概述               │  │ 👤 AI助手:     │  │
│  │  本次迭代优化用户登录...   │  │                 │  │
│  │                            │  │ 我已经阅读了你的 │
│  │  ## 功能描述               │  │ 需求描述和截图, │
│  │  1. 支持手机号登录         │  │ 现在有几个问题  │
│  │  2. 支持微信登录           │  │ 需要确认:       │
│  │                            │  │                 │  │
│  │  ## 待确认问题 ⚠️          │  │ 1. 手机号登录   │
│  │  - [问] 登录失败次数限制?  │  │    是否需要      │
│  │  - [问] 验证码有效期?      │  │    验证码?       │
│  │  - [问] 第三方登录异常处理?│  │                 │  │
│  │                            │  │ 2. 如果微信未  │
│  │  ## 已识别风险 🔴          │  │    绑定手机号,  │
│  │  - 验证码可能被爆破        │  │    是否允许登录? │
│  │  - 第三方登录态可能失效    │  │                 │  │
│  │                            │  │ 3. 登录失败     │
│  │  ## 修订历史               │  │    多少次后      │
│  │  - v1.0 初始创建           │  │    锁定账号?     │
│  │  - v1.1 添加验证码说明     │  │                 │  │
│  │                            │  │ 请回复确认或补充│
│  └────────────────────────────┘  │                 │  │
│                                   │                 │  │
│  [接受建议] [修改原文]            ─┘                 │  │
│                                                      │
│  ┌─ 你的输入 ────────────────────────────────────┐  │
│  │ 1. 手机号登录需要短信验证码                     │  │
│  │ 2. 微信未绑定手机号可以登录,但提示绑定          │  │
│  │ 3. 5次失败后锁定15分钟                         │  │
│  │                                [发送] [语音]   │  │
│  └──────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────┘
```

**AI能力**：
1. **信息提取**：从截图、碎片化描述中提取关键信息
2. **问题发现**：自动识别需求不完整之处
3. **风险识别**：基于历史经验标注潜在风险
4. **结构化生成**：最终生成Markdown格式需求文档

**需求文档模板**：
```markdown
# [REQ-2025-001] 用户登录功能优化

## 1. 需求概述
(自动生成或手动编写)

## 2. 功能详述
### 2.1 手机号登录
- **输入**: 手机号 + 短信验证码
- **规则**: 验证码6位数字,有效期5分钟
- **异常处理**: 验证码错误提示、超时重发

### 2.2 微信登录
- **流程**: OAuth授权 → 获取用户信息 → 登录
- **绑定规则**: 首次登录提示绑定手机号
- **异常处理**: 授权取消、用户信息获取失败

## 3. 边界条件
- 验证码尝试次数: 5次/15分钟
- 账号锁定: 15分钟自动解锁
- 手机号格式: +86-1xx-xxxx-xxxx

## 4. 非功能需求
- 响应时间: 登录请求 < 2s
- 并发支持: 1000 QPS

## 5. 风险与挑战
- [高风险] 验证码可能被爆破
- [中风险] 微信授权可能超时
- [低风险] 新用户引导流程可能遗漏

## 6. 验收标准
- [ ] 手机号登录成功率 > 99%
- [ ] 微信登录成功率 > 95%
- [ ] 异常场景覆盖100%

## 7. 参考文档
- 产品原型: [链接]
- 设计稿: [链接]
- API文档: [链接]
```

**数据模型**：
```python
class Requirement(SQLModel, table=True):
    __tablename__ = "requirements"

    id: int = Field(primary_key=True)
    requirement_id: str = Field(unique=True, index=True)  # REQ-2025-001
    name: str
    module_id: Optional[str]  # 禅道模块ID
    module_name: str
    iteration: str
    priority: str  # high/medium/low

    # 需求内容
    description: str  # Markdown格式
    attachments: List[str]  # MinIO存储路径

    # AI澄清记录
    ai_conversation_id: Optional[str]
    clarification_status: str  # draft/clarifying/confirmed
    risk_points: List[str]  # JSON数组

    # 状态
    status: str  # draft/review/approved/cancelled

    # 关联
    test_case_suite_id: Optional[int]  # 关联的用例集

    # 元数据
    created_by: int
    created_at: datetime
    updated_at: datetime
    version: int = 1
```

#### 3.2.3 测试点管理

**功能描述**：基于需求文档生成测试点，作为生成用例的中间步骤。

**测试点类型**：
- **功能测试点**: 正常流程、异常流程、边界值
- **性能测试点**: 响应时间、并发压力
- **安全测试点**: 权限控制、数据加密
- **兼容性测试点**: 浏览器、系统、分辨率
- **易用性测试点**: 用户体验、交互设计

**界面设计**：

```
┌─────────────────────────────────────────────────────┐
│  测试点梳理 - 用户登录功能优化                        │
├─────────────────────────────────────────────────────┤
│                                                      │
│  关联需求: REQ-2025-001                              │
│                                                      │
│  ┌─ AI生成的测试点 ──────────────────────────────┐  │
│  │                                              │  │
│  │  功能测试 (12个测试点)                        │  │
│  │  ✓ 1. 手机号正确 + 验证码正确 → 登录成功      │  │
│  │  ✓ 2. 手机号错误 → 提示"手机号格式错误"       │  │
│  │  ✓ 3. 验证码错误 → 提示"验证码错误,剩余X次"   │  │
│  │  ✓ 4. 验证码过期 → 提示"验证码已过期,请重新获取"│  │
│  │  ✓ 5. 验证码尝试5次失败 → 账号锁定15分钟      │  │
│  │  ⚠️ 6. 微信登录未绑定手机号 → 引导绑定        │  │
│  │  ⚠️ 7. 微信授权取消 → 返回登录页              │  │
│  │  ...                                          │  │
│  │                                              │  │
│  │  边界测试 (5个测试点)                         │  │
│  │  ⚠️ 1. 验证码刚好5分钟时提交                  │  │
│  │  ⚠️ 2. 手机号为空                             │  │
│  │  ⚠️ 3. 特殊字符手机号                         │  │
│  │  ...                                          │  │
│  │                                              │  │
│  │  安全测试 (3个测试点)                         │  │
│  │  ⚠️ 1. 验证码爆破防护                         │  │
│  │  ⚠️ 2. SQL注入测试                           │  │
│  │  ⚠️ 3. XSS注入测试                           │  │
│  │                                              │  │
│  │  [+] 添加测试点  [重新生成]  [批量编辑]       │  │
│  └──────────────────────────────────────────────┘  │
│                                                      │
│  ┌─ 测试点覆盖率分析 ───────────────────────────┐  │
│  │  需求覆盖: 85% (17/20功能点)                  │  │
│  │  ████████████████░░░                         │  │
│  │                                              │  │
│  │  风险覆盖: 100% (3/3风险点)                  │  │
│  │  ████████████████████                       │  │
│  │                                              │  │
│  │  ⚠️ 发现遗漏:                                 │  │
│  │  - 未覆盖验证码重发间隔限制                   │  │
│  │  - 未覆盖异地登录检测                        │  │
│  │                                              │  │
│  │  [一键补充遗漏测试点]                        │  │
│  └──────────────────────────────────────────────┘  │
│                                                      │
│                [确认测试点] [返回]                   │
└─────────────────────────────────────────────────────┘
```

**数据模型**：
```python
class TestPoint(SQLModel, table=True):
    __tablename__ = "test_points"

    id: int = Field(primary_key=True)
    requirement_id: int  # 关联需求
    category: str  # functional/performance/security/compatibility
    sub_category: Optional[str]  # 正常流程/异常流程/边界值

    title: str
    description: Optional[str]
    priority: str  # p0/p1/p2/p3
    risk_level: str  # high/medium/low

    # AI生成信息
    is_ai_generated: bool = True
    confidence_score: float  # AI置信度 0-1

    # 状态
    status: str  # draft/approved/rejected

    created_at: datetime
    updated_at: datetime
```

#### 3.2.4 测试用例管理

**功能描述**：基于测试点生成详细测试用例，支持手动编辑、批量操作。

**用例表格视图**（类似禅道）：

```
┌─────────────────────────────────────────────────────────────────────┐
│ 测试用例 - 用户登录功能优化                     [导出] [批量操作]   │
├─────────────────────────────────────────────────────────────────────┤
│ 需求ID: REQ-2025-001  |  模块: 用户管理(101)  |  用例数: 50条       │
├─────────────────────────────────────────────────────────────────────┤
│ 筛选: [全部 ▼] [P0] [P1] [P2]  搜索: [        ]  [视图: 表格|卡片] │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─ 模块: 登录页面 ─────────────────────────────────────────────┐   │
│  │                                                                │   │
│  │  ┌────────────────────────────────────────────────────────┐  │   │
│  │  │ TC-001 正常登录流程                    [P0] [功能] [✓] │  │   │
│  │  ├────────────────────────────────────────────────────────┤  │   │
│  │  │ 前置条件: 用户已注册,手机号正常                          │  │   │
│  │  │                                                        │  │   │
│  │  │ ┌───┬────────────────────┬──────────────────────────┐ │  │   │
│  │  │ │序号│ 操作步骤           │ 预期结果                 │ │  │   │
│  │  │ ├───┼────────────────────┼──────────────────────────┤ │  │   │
│  │  │ │ 1 │ 打开登录页面       │ 显示登录表单              │ │  │   │
│  │  │ │ 2 │ 输入正确手机号     │ 输入框显示手机号          │ │  │   │
│  │  │ │ 3 │ 点击"获取验证码"   │ 按钮置灰,倒计时60s        │ │  │   │
│  │  │ │ 4 │ 输入6位验证码      │ 验证码格式正确            │ │  │   │
│  │  │ │ 5 │ 点击"登录"按钮     │ 跳转至首页,顶部显示用户名 │ │  │   │
│  │  │ └───┴────────────────────┴──────────────────────────┘ │  │   │
│  │  │                                                        │  │   │
│  │  │ 优先级: P0  标签: 冒烟测试  自动化: [ ]              │  │   │
│  │  │ [编辑] [复制] [删除] [执行]                           │  │   │
│  │  └────────────────────────────────────────────────────────┘  │   │
│  │                                                                │   │
│  │  ┌────────────────────────────────────────────────────────┐  │   │
│  │  │ TC-002 验证码错误                     [P1] [功能] [ ]  │  │   │
│  │  ├────────────────────────────────────────────────────────┤  │   │
│  │  │ 前置条件: 用户已注册,手机号正常                          │  │   │
│  │  │                                                        │  │   │
│  │  │ ┌───┬────────────────────┬──────────────────────────┐ │  │   │
│  │  │ │序号│ 操作步骤           │ 预期结果                 │ │  │   │
│  │  │ ├───┼────────────────────┼──────────────────────────┤ │  │   │
│  │  │ │ 1 │ 打开登录页面       │ 显示登录表单              │ │  │   │
│  │  │ │ 2 │ 输入错误验证码     │ 输入错误验证码            │ │  │   │
│  │  │ │ 3 │ 点击"登录"按钮     │ 提示"验证码错误,剩余4次" │ │  │   │
│  │  │ └───┴────────────────────┴──────────────────────────┘ │  │   │
│  │  │                                                        │  │   │
│  │  │ 优先级: P1  标签: 异常场景  自动化: [✓]              │  │   │
│  │  │ [编辑] [复制] [删除] [执行]                           │  │   │
│  │  └────────────────────────────────────────────────────────┘  │   │
│  │                                                                │   │
│  │  [+ 添加用例]  [AI生成更多用例]                               │   │
│  └────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─ 模块: 个人中心 ─────────────────────────────────────────────┐   │
│  │  (折叠状态 - 点击展开)                                         │   │
│  └────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘

第 1 页 / 共 5 页  |  共 50 条用例
```

**用例编辑器**：

```
┌─────────────────────────────────────────────────────┐
│  编辑测试用例 - TC-001                      [保存] │
├─────────────────────────────────────────────────────┤
│                                                      │
│  所属模块: [登录页面 ▼]                              │
│  用例标题: [正常登录流程              ]              │
│  优先级: [P0 ▼]  类型: [功能测试 ▼]                 │
│  标签: [冒烟测试] [正交试验] [+ 添加]                │
│                                                      │
│  前置条件:                                           │
│  ┌──────────────────────────────────────────────┐   │
│  │ 1. 用户已注册                                  │   │
│  │ 2. 手机号格式正确                              │   │
│  │ 3. 短信服务正常                                │   │
│  │                                              │   │
│  └──────────────────────────────────────────────┘   │
│                                                      │
│  ┌─ 操作步骤与预期结果 ─────────────────────────┐   │
│  │                                               │   │
│  │  序号1:                                       │   │
│  │  ┌───────────────────────────────────────┐   │   │
│  │  │ 操作步骤:                              │   │   │
│  │  │ [打开登录页面                        ] │   │   │
│  │  │                                       │   │   │
│  │  │ 预期结果:                              │   │   │
│  │  │ [显示登录表单,包含手机号输入框...   ] │   │   │
│  │  └───────────────────────────────────────┘   │   │
│  │                                               │   │
│  │  [+ 添加步骤]                                 │   │
│  │                                               │   │
│  └───────────────────────────────────────────────┘   │
│                                                      │
│  其他信息:                                           │
│  自动化: [✓] 需要自动化                              │
│  复杂度: [低 ▼]                                      │
│  预估执行时间: [2] 分钟                               │
│                                                      │
│  ┌─ AI建议 ─────────────────────────────────────┐   │
│  │ 💡 建议补充:                                 │   │
│  │ • 添加"网络异常"场景的测试步骤                │   │
│  │ • 补充验证码大小写不敏感的验证               │   │
│  │ [一键采纳]                                   │   │
│  └──────────────────────────────────────────────┘   │
│                                                      │
└─────────────────────────────────────────────────────┘
```

**数据模型**：
```python
class TestCase(SQLModel, table=True):
    __tablename__ = "test_cases"

    id: int = Field(primary_key=True)
    case_id: str = Field(unique=True)  # TC-2025-001-001

    # 关联
    requirement_id: int  # 关联需求
    test_suite_id: int  # 关联用例集
    test_point_id: Optional[int]  # 关联测试点

    # 基础信息
    module_name: str  # 模块名称
    page_name: str  # 页面名称
    title: str  # 用例标题
    priority: str  # p0/p1/p2/p3
    case_type: str  # functional/performance/security/compatibility

    # 用例内容
    preconditions: List[str]  # 前置条件 (JSON)
    steps: List[TestCaseStep]  # 测试步骤
    expected_results: List[str]  # 预期结果 (与steps一一对应)

    # 标签
    tags: List[str]  # JSON数组

    # 元数据
    is_automated: bool = False
    complexity: str  # low/medium/high
    estimated_time: int  # 预估执行时间(分钟)

    # AI生成信息
    is_ai_generated: bool = False
    ai_model: Optional[str]  # 使用的AI模型

    # 状态
    status: str  # draft/review/approved/cancelled

    # 创建信息
    created_by: int
    created_at: datetime
    updated_at: datetime
    version: int = 1


class TestCaseStep(SQLModel):
    """测试步骤"""
    step_number: int
    action: str  # 操作步骤
    expected_result: str  # 预期结果
```

#### 3.2.5 思维导图视图

**功能描述**：将测试用例以思维导图形式展示,方便评审和整体把握。

**界面设计**：

```
┌─────────────────────────────────────────────────────────────────────┐
│ 测试用例思维导图 - 用户登录功能优化       [表格视图] [导出图片]     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  控制栏: [+] 放大  [-] 缩小  [↺] 重置  [🖱] 拖拽模式  [📷] 导出    │
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │                                                               │ │
│  │                                    ┌─────────────────────┐   │ │
│  │                                    │ 用户登录功能优化     │   │ │
│  │                                    │ REQ-2025-001        │   │ │
│  │                                    │ 50条用例 | P0:15    │   │ │
│  │                                    └──────────┬──────────┘   │ │
│  │                                               │               │ │
│  │              ┌────────────────────────────────┼────────┐     │ │
│  │              │                                │        │     │ │
│  │   ┌──────────▼──────────┐          ┌─────────▼─────┐  │     │ │
│  │   │ 登录页面             │          │ 个人中心       │  │     │ │
│  │   │ (30条)              │          │ (10条)         │  │     │ │
│  │   │ P0:10               │          │ P0:3           │  │     │ │
│  │   └──────┬──────┬───────┘          └───────┬────────┘  │     │ │
│  │          │      │                           │           │     │ │
│  │   ┌──────┴──┐ ┌─┴────┐              ┌──────┴────┐     │     │ │
│  │   │正常登录 │ │异常  │              │  修改手机号│     │     │ │
│  │   │(5条)   │ │登录  │              │  (10条)   │     │     │ │
│  │   │P0:2    │ │(25条)│              │  P0:2     │     │     │ │
│  │   └────┬───┘ └──┬───┘              └──────┬─────┘     │     │ │
│  │        │        │                          │           │     │ │
│  │   ┌────┴────┐ ┌─┴──────────┐       ┌──────┴──────┐     │     │ │
│  │   │TC-001  │ │TC-002 验证码│       │TC-031       │     │     │ │
│  │   │正常流程 │ │错误         │       │手机号格式... │     │     │ │
│  │   │P0      │ │P1           │       │P1           │     │     │ │
│  │   └────────┘ │TC-003 过期  │       └─────────────┘     │     │ │
│  │              │P1           │                          │     │ │
│  │              │TC-004 锁定  │                          │     │ │
│  │              │P0           │                          │     │ │
│  │              │...          │                          │     │ │
│  │              └─────────────┘                          │     │ │
│  │                                                      │     │ │
│  └──────────────────────────────────────────────────────┘     │ │
│                                                                   │
│  ┌─ 节点详情 ─────────────────────────────────────────────┐     │
│  │  TC-001 正常登录流程                                    │     │
│  │  优先级: P0  类型: 功能测试                              │     │
│  │  步骤数: 5  预估时间: 2分钟                              │     │
│  │                                                         │     │
│  │  [展开详情] [定位到表格视图] [评审]                      │     │
│  └─────────────────────────────────────────────────────────┘     │
│                                                                   │
└───────────────────────────────────────────────────────────────────┘
```

**交互功能**：
- **展开/折叠**: 点击节点展开或折叠子节点
- **高亮路径**: 鼠标悬停高亮该节点到根节点的路径
- **筛选显示**: 根据优先级、状态筛选显示的节点
- **拖拽重组**: 支持拖拽调整模块层级关系
- **快速定位**: 双击节点跳转到表格视图

**技术实现**：
- 使用 `ReactFlow` 或 `AntV G6` 渲染思维导图
- 支持导出为PNG/SVG
- 自适应布局算法

#### 3.2.6 导出与集成

**功能描述**：支持多种格式导出,适配主流测试管理工具。

**导出界面**：

```
┌─────────────────────────────────────────────────────┐
│  导出测试用例 - 用户登录功能优化                      │
├─────────────────────────────────────────────────────┤
│                                                      │
│  选择用例:                                           │
│  • 全部用例 (50条)                                   │
│  • 仅选中用例 (12条)                                 │
│  • 自定义筛选 [优先级 ▼][状态 ▼]                     │
│                                                      │
│  导出格式:                                           │
│  ┌─────────────────────────────────────────────┐    │
│  │  ☑ CSV (导入禅道)                           │    │
│  │  ☑ Excel (XLSX)                             │    │
│  │  ☐ Markdown (.md)                           │    │
│  │  ☐ PDF (带封面和目录)                        │    │
│  │  ☐ 思维导图图片 (PNG/SVG)                   │    │
│  └─────────────────────────────────────────────┘    │
│                                                      │
│  CSV格式配置 (导入禅道):                              │
│  ┌─────────────────────────────────────────────┐    │
│  │  ☑ 自动拼接需求ID (REQ-2025-001)            │    │
│  │  ☑ 自动拼接模块ID (101)                     │    │
│  │  ☑ 包含用例ID (TC-2025-001-001)             │    │
│  │  字段分隔符: [逗号 ▼]                        │    │
│  │  编码: [UTF-8 ▼]                             │    │
│  └─────────────────────────────────────────────┘    │
│                                                      │
│  文件命名:                                           │
│  [测试用例_REQ-2025-001_用户登录功能优化_20250130    │
│                                                      │
│              [预览] [取消] [导出]                    │
└─────────────────────────────────────────────────────┘
```

**CSV导出格式示例**（禅道兼容）：

```csv
用例ID,需求ID,模块ID,模块名称,用例标题,优先级,前置条件,操作步骤,预期结果,标签
TC-2025-001-001,REQ-2025-001,101,用户管理,正常登录流程,P0,"1.用户已注册;2.手机号正常","1.打开登录页面;2.输入手机号13800138000;3.点击获取验证码;4.输入验证码123456;5.点击登录","1.显示登录表单;2.输入框显示手机号;3.按钮置灰60s;4.验证码格式正确;5.跳转首页,显示用户名",冒烟测试
```

**Markdown导出示例**：

````markdown
# 测试用例 - 用户登录功能优化

**需求ID**: REQ-2025-001
**模块**: 用户管理 (101)
**生成时间**: 2025-01-30
**用例数量**: 50条

---

## 目录
- [登录页面](#登录页面) (30条)
  - [正常登录](#正常登录) (5条)
  - [异常登录](#异常登录) (25条)
- [个人中心](#个人中心) (10条)

---

## 登录页面

### 正常登录

#### TC-001 正常登录流程 [P0]

**前置条件**:
1. 用户已注册
2. 手机号格式正确
3. 短信服务正常

**测试步骤**:

| 序号 | 操作步骤 | 预期结果 |
|------|----------|----------|
| 1 | 打开登录页面 | 显示登录表单,包含手机号输入框、验证码输入框、登录按钮 |
| 2 | 输入正确手机号 13800138000 | 输入框显示手机号,格式正确 |
| 3 | 点击"获取验证码" | 按钮置灰,显示倒计时60s,手机收到短信 |
| 4 | 输入6位验证码 123456 | 验证码输入框显示验证码,格式正确 |
| 5 | 点击"登录"按钮 | 跳转至首页,顶部显示用户名,登录态保持 |

**标签**: 冒烟测试
**自动化**: 是
**预估时间**: 2分钟

---
````

**PDF导出特性**：
- 自动生成封面（包含项目名称、需求ID、版本、日期）
- 自动生成目录（支持点击跳转）
- 支持添加页眉页脚
- 支持自定义Logo

#### 3.2.7 知识库管理

**功能描述**：历史用例向量化存储,支持语义搜索和智能推荐。

**知识库统计界面**：

```
┌─────────────────────────────────────────────────────┐
│  测试用例知识库                                      │
├─────────────────────────────────────────────────────┤
│                                                      │
│  ┌─ 统计概览 ───────────────────────────────────┐  │
│  │  📊 总用例数: 3,456条                          │  │
│  │  📁 覆盖模块: 128个                           │  │
│  │  🤖 AI生成用例: 2,145条 (62.1%)               │  │
│  │  📈 平均质量分: 8.7/10                        │  │
│  └──────────────────────────────────────────────┘  │
│                                                      │
│  ┌─ 知识库健康度 ───────────────────────────────┐  │
│  │  向量化完成度: ████████████████████ 100%     │  │
│  │  标签覆盖率: ████████████████░░░░ 80%        │  │
│  │  步骤完整性: ████████████████████ 95%        │  │
│  └──────────────────────────────────────────────┘  │
│                                                      │
│  ┌─ 语义搜索 ───────────────────────────────────┐  │
│  │  🔍 [输入关键词或描述,如"用户登录异常"]     │  │
│  │                                              │  │
│  │  相关用例 (Top 10):                          │  │
│  │  1. TC-2025-001-002 验证码错误登录 (相似度  │  │
│  │     0.92)                                    │  │
│  │  2. TC-2024-112-015 微信登录失败 (相似度    │  │
│  │     0.87)                                    │  │
│  │  3. TC-2024-105-003 账号锁定场景 (相似度    │  │
│  │     0.81)                                    │  │
│  │                                              │  │
│  │  [查看详情] [引用到新用例]                   │  │
│  └──────────────────────────────────────────────┘  │
│                                                      │
│  ┌─ 用例模板 ───────────────────────────────────┐  │
│  │  常用模板:                                    │  │
│  │  • 表单提交测试模板 (使用234次)               │  │
│  │  • 列表查询测试模板 (使用189次)               │  │
│  │  • 文件上传测试模板 (使用156次)               │  │
│  │  • 权限控制测试模板 (使用143次)               │  │
│  │                                              │  │
│  │  [+ 创建自定义模板]                          │  │
│  └──────────────────────────────────────────────┘  │
│                                                      │
└─────────────────────────────────────────────────────┘
```

**技术实现**：
- **向量化**: 使用OpenAI Embeddings或开源模型（如Sentence-BERT）
- **向量数据库**: PostgreSQL + pgvector扩展
- **语义搜索**: 余弦相似度匹配
- **智能推荐**: 基于当前需求关键词检索相关历史用例

**数据模型**：
```python
class TestCaseKnowledge(SQLModel, table=True):
    __tablename__ = "test_case_knowledge"

    id: int = Field(primary_key=True)
    test_case_id: int  # 关联test_cases

    # 向量化数据
    embedding: List[float]  # 1536维向量 (OpenAI) 或 768维 (BERT)
    embedding_model: str  # 使用的向量化模型

    # 元数据 (用于过滤)
    module_name: str
    priority: str
    case_type: str
    tags: List[str]

    # 质量指标
    quality_score: float  # 质量评分 0-10
    usage_count: int  # 被引用次数

    created_at: datetime
```

---

## 四、UI/UX设计规范

### 4.1 设计语言

- **主色调**: 科技蓝 (#1890ff)
- **辅助色**: 成功绿 (#52c41a)、警告橙 (#faad14)、错误红 (#f5222d)
- **字体**: 系统默认字体栈 (Inter, -apple-system, Microsoft YaHei)
- **圆角**: 4px (按钮)、8px (卡片)
- **阴影**: 轻微阴影提升层次感

### 4.2 响应式设计

- **桌面端**: ≥1440px (完整功能)
- **平板端**: 768px - 1439px (简化布局)
- **移动端**: <768px (基础功能)

### 4.3 交互设计原则

1. **即时反馈**: 所有操作在200ms内给予反馈
2. **渐进式披露**: 复杂功能分步引导
3. **防错设计**: 关键操作需二次确认
4. **键盘友好**: 支持快捷键操作

---

## 五、非功能需求

### 5.1 性能要求

- **页面加载**: 首屏加载时间 < 2s
- **AI响应**: 需求澄清响应时间 < 5s
- **用例生成**: 50条用例生成时间 < 30s
- **导出操作**: 100条用例导出 < 10s

### 5.2 安全要求

- **API Key加密存储**: 使用AES-256加密
- **权限控制**: 基于角色的访问控制 (RBAC)
- **审计日志**: 记录所有敏感操作
- **数据隔离**: 不同用户/团队的数据严格隔离

### 5.3 可用性要求

- **系统可用性**: 99.5% (月度)
- **数据备份**: 每日增量备份,每周全量备份
- **容灾恢复**: RTO < 1小时, RPO < 5分钟

---

## 六、技术选型建议

### 6.1 后端技术栈

- **Web框架**: FastAPI (异步高性能)
- **数据库**: PostgreSQL + pgvector (向量存储)
- **ORM**: SQLModel (类型安全)
- **文件存储**: MinIO (对象存储)
- **AI集成**: LangChain (统一LLM接口)

### 6.2 前端技术栈

- **框架**: React 19 + TypeScript
- **状态管理**: React Query
- **UI组件**: shadcn/ui + Ant Design
- **思维导图**: ReactFlow 或 AntV G6
- **富文本编辑器**: Tiptap 或 Slate
- **导出库**: PapaParse (CSV), sheetjs (Excel), jsPDF (PDF)

### 6.3 AI技术栈

- **LLM编排**: LangChain + LangGraph (状态图管理多轮对话)
- **向量数据库**: pgvector
- **Embedding模型**: OpenAI text-embedding-3-small 或 BERT
- **多模态理解**: GPT-4V / Claude 3.5 Sonnet (支持图片输入)

**为什么选择LangGraph?**

LangGraph是LangChain生态中专门用于构建**有状态、多步骤AI应用**的框架,特别适合需求澄清这种复杂的多轮对话场景:

| 特性 | LangChain ConversationChain | LangGraph |
|------|---------------------------|-----------|
| 状态管理 | ❌ 只能保存消息历史 | ✅ 结构化状态(需求文档、风险点、问题列表) |
| 流程控制 | ❌ 只能线性对话 | ✅ 支持条件分支、循环 |
| 人工干预 | ❌ 不支持 | ✅ 支持人工输入节点(暂停等待用户回复) |
| 可观测性 | ❌ 难以调试 | ✅ 可视化状态图,每步都可追踪 |
| 持久化 | ❌ 需手动实现 | ✅ 内置checkpointer,自动保存状态 |

**需求澄清流程的状态图**:
```
开始 → AI分析需求 → 提出问题 → 等待用户回答 → 更新需求文档
                                                    ↓
                                            循环回"AI分析需求"
                                                    ↓
需求完整 → 生成最终报告 → 结束
```

### 6.4 平台选型 (自研 vs n8n/Dify)

详见第七章"技术实现方案"。

---

## 七、版本规划

### 7.1 MVP版本 (v1.0) - 核心功能

**范围**:
- ✅ AI配置管理 (OpenAI、通义千问)
- ✅ 需求创建 (支持富文本、图片上传)
- ✅ AI需求澄清 (基础多轮对话)
- ✅ 测试点生成 (功能测试点)
- ✅ 测试用例生成 (表格视图)
- ✅ 导出CSV、Excel
- ✅ 基础知识库检索

**不包含**:
- ❌ 思维导图视图
- ❌ PDF导出
- ❌ 高级统计分析
- ❌ 多AI厂商支持 (仅支持2家)

**交付时间**: 4-6周

### 7.2 完整版本 (v2.0) - 全功能

**新增功能**:
- ✅ 思维导图视图
- ✅ PDF导出
- ✅ 多AI厂商支持 (5+)
- ✅ 高级统计分析
- ✅ 用例评审协作
- ✅ 版本控制
- ✅ 禅道集成 (API对接)

**交付时间**: +4周

### 7.3 增强版本 (v3.0) - 智能化

**新增功能**:
- ✅ AI自动优化历史用例
- ✅ 智能推荐测试点
- ✅ 测试覆盖率智能分析
- ✅ 自动化测试用例优先级排序
- ✅ 多模态需求理解 (语音、视频)

---

## 八、成功指标 (KPI)

### 8.1 效率指标

- **用例编写效率**: 提升 70% (从2天 → 2小时)
- **需求澄清时间**: 减少 50% (AI辅助减少来回沟通)
- **用例评审时间**: 减少 40% (思维导图可视化)

### 8.2 质量指标

- **用例覆盖率**: 提升 40% (AI发现盲点)
- **用例质量分**: ≥ 8.0/10 (基于评审反馈)
- **AI生成准确率**: ≥ 85% (基于用户采纳率)

### 8.3 用户体验指标

- **用户满意度**: ≥ 4.5/5.0
- **功能使用率**: ≥ 60% 用户使用AI生成功能
- **月活跃用户**: 持续增长

---

## 九、风险评估与应对

### 9.1 技术风险

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|----------|
| AI生成质量不稳定 | 高 | 中 | 引入反馈机制,持续优化Prompt,支持用户修改 |
| 向量检索准确率低 | 中 | 低 | 测试多个Embedding模型,选择最优 |
| AI成本过高 | 中 | 中 | 支持多家AI厂商切换,本地模型降本 |
| 大文件处理性能差 | 低 | 中 | 异步处理,进度反馈 |

### 9.2 业务风险

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|----------|
| 用户接受度低 | 高 | 低 | 早期邀请核心用户参与测试,收集反馈 |
| 知识库冷启动 | 中 | 高 | 提供工具批量导入历史用例 |
| 数据安全担忧 | 高 | 中 | 私有化部署支持,数据加密存储 |

---

## 十、后续优化方向

1. **多语言支持**: 支持中英文用例生成
2. **移动端优化**: 支持移动设备查看用例
3. **AI模型微调**: 基于企业历史数据微调专属模型
4. **自动化测试集成**: 生成的用例可直接转换为自动化脚本
5. **需求变更追踪**: 需求变更自动影响用例更新

---

## 附录

### A. 术语表

- **需求ID**: 产品需求的唯一标识,格式如 REQ-YYYY-NNN
- **用例ID**: 测试用例的唯一标识,格式如 TC-YYYY-NNN-NNN
- **模块ID**: 禅道中模块的唯一标识,如 101
- **测试点**: 测试用例的抽象描述,不包含具体步骤
- **思维导图**: 树状结构展示用例层级关系

### B. 参考资料

- 禅道测试用例管理文档
- 《Google测试之道》
- LangChain官方文档
- pgvector使用指南

---

**文档结束**
