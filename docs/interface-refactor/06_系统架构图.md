# 接口管理模块重构 - 系统架构图

> 文档版本: v1.0
> 创建日期: 2025-02-11
> 角色: 系统架构师

---

## 1. 系统架构总览

```mermaid
graph TB
    subgraph Frontend["前端 React"]
        UI["用户界面"]
        State["状态管理<br/>React Query"]
        Hook["自定义 Hooks<br/>useEnvironment<br/>useVariableReplacement"]
    end

    subgraph Backend["后端 FastAPI"]
        API["REST API<br/>/api/v1/interfaces"]
        Services["服务层"]
        DB[(("数据库<br/>PostgreSQL/SQLite"))]
        Engine["测试引擎<br/>sisyphus-api-engine"]
    end

    subgraph External["外部服务"]
        MinIO["MinIO<br/>文件存储"]
        TargetAPI["目标 API<br/>被测接口"]
    end

    UI --> State
    State --> Hook
    Hook --> API
    API --> Services
    Services --> DB
    Services --> Engine
    Services --> MinIO
    Services --> TargetAPI
```

---

## 2. 前端架构

### 2.1 组件层次结构

```
frontend/src/pages/interface/
├── index.tsx                          # 布局容器
│   └── <InterfacePage>
│
├── components/
│   ├── InterfaceTree.tsx              # 左侧目录树
│   │   ├── <TreeNode>
│   │   ├── <ContextMenu>
│   │   └── <SearchInput>
│   │
│   ├── WelcomeCards.tsx               # 欢迎卡片
│   │   ├── <NewRequestCard>
│   │   ├── <ImportCurlCard>
│   │   └── <RecentInterfaces>
│   │
│   ├── RequestEditor/                 # 请求编辑器
│   │   ├── RequestEditor.tsx          # 容器组件
│   │   ├── MethodSelector.tsx        # 方法选择器
│   │   ├── UrlInput.tsx              # URL 输入框
│   │   ├── EnvironmentSelector.tsx   # 环境选择器
│   │   ├── KeyValueEditor.tsx        # 通用 KV 编辑器
│   │   │
│   │   └── tabs/
│   │       ├── ParamsTab.tsx         # Query 参数编辑器
│   │       ├── AuthTab.tsx           # 认证配置编辑器
│   │       ├── HeadersTab.tsx        # Headers 编辑器
│   │       ├── BodyTab.tsx           # Body 编辑器
│   │       │   ├── <NoneBody>
│   │       │   ├── <JsonBody>        # Monaco Editor
│   │       │   ├── <FormDataBody>    # KV 编辑器
│   │       │   ├── <UrlEncodedBody>  # KV 编辑器
│   │       │   └── <RawBody>        # Monaco Editor
│   │       └── PreRequestTab.tsx     # 前置脚本编辑器（未来）
│   │
│   └── ResponseViewer/               # 响应展示器
│       ├── ResponseViewer.tsx        # 容器组件
│       ├── ResponseHeader.tsx        # 响应头
│       │   ├── <StatusCodeBadge>
│       │   └── <MetaInfo>
│       │
│       └── tabs/
│           ├── BodyViewer.tsx         # Body 展示器
│           │   ├── <JsonViewer>      # 格式化 JSON
│           │   ├── <TextViewer>      # 纯文本
│           │   └── <ImageViewer>     # 图片预览
│           ├── HeadersViewer.tsx     # Headers 表格
│           ├── CookiesViewer.tsx     # Cookies 表格
│           ├── TimelineViewer.tsx    # 时间线可视化
│           └── TestResultsViewer.tsx # 断言结果（未来）
│
├── dialogs/
│   ├── EnvironmentDialog.tsx          # 环境管理弹窗
│   ├── CurlImportDialog.tsx          # cURL 导入弹窗
│   └── GenerateCaseDialog.tsx        # 生成测试用例弹窗
│
├── hooks/
│   ├── useVariableReplacement.ts      # 变量替换 Hook
│   ├── useRequestHistory.ts          # 请求历史 Hook
│   └── useEnvironment.ts             # 环境管理 Hook
│
└── utils/
    ├── curlParser.ts                 # cURL 前端解析器
    └── variableParser.ts             # 变量解析器
```

---

### 2.2 状态管理

```mermaid
graph LR
    subgraph Client["客户端状态"]
        Local["局部状态<br/><input>, <select>"]
        Global["全局状态<br/>Context/Zustand"]
        Server["服务端状态<br/>React Query"]
    end

    subgraph Storage["本地存储"]
        LS["localStorage<br/>展开状态"]
    end

    Local --> Global
    Global --> Server
    Global <--> LS
```

**状态划分：**

| 类型 | 状态 | 管理方式 |
|------|------|----------|
| 局部 | 输入框值、Tab 选择、对话框状态 | useState |
| 全局 | 当前选中接口、当前环境 | React Context |
| 服务端 | 接口列表、环境列表、历史记录 | React Query |
| 持久化 | 目录树展开状态 | localStorage |

---

## 3. 后端架构

### 3.1 分层架构

```mermaid
graph TB
    subgraph Presentation["表现层"]
        Router["FastAPI Router<br/>/api/v1/interfaces"]
    end

    subgraph Business["业务逻辑层"]
        EnvSvc["EnvironmentService<br/>环境管理"]
        CurlSvc["CurlParserService<br/>cURL 解析"]
        VarSvc["VariableReplacerService<br/>变量替换"]
        CaseSvc["TestCaseGeneratorService<br/>测试用例生成"]
        HistSvc["HistoryService<br/>历史记录"]
    end

    subgraph Data["数据访问层"]
        Session["AsyncSession<br/>SQLModel ORM"]
    end

    subgraph External["外部集成"]
        Engine["sisyphus-api-engine<br/>YAML 生成"]
        MinIO["MinIO<br/>文件存储"]
        HTTP["httpx<br/>HTTP 客户端"]
    end

    Router --> EnvSvc
    Router --> CurlSvc
    Router --> VarSvc
    Router --> CaseSvc
    Router --> HistSvc

    EnvSvc --> Session
    HistSvc --> Session

    CaseSvc --> Engine
    HistSvc --> MinIO
    VarSvc --> HTTP
```

---

### 3.2 服务依赖关系

```mermaid
graph LR
    A[InterfaceRouter] --> B[EnvironmentService]
    A --> C[CurlParserService]
    A --> D[VariableReplacerService]
    A --> E[TestCaseGeneratorService]
    A --> F[HistoryService]

    E --> D
    E --> G[FileWriter]

    F --> D
    F --> H[MinIOClient]
```

---

## 4. 数据流设计

### 4.1 发送接口请求流程

```mermaid
sequenceDiagram
    actor User
    participant FE as 前端
    participant API as FastAPI
    participant Var as 变量替换服务
    participant Env as 环境服务
    participant HTTP as httpx 客户端
    participant Target as 目标 API
    participant Hist as 历史记录服务
    participant DB as 数据库

    User->>FE: 点击「发送」
    FE->>FE: 收集请求数据
    Note over FE: URL: /api/users/{{userId}}<br/>Method: GET<br/>Environment: dev

    FE->>API: POST /interfaces/debug/send
    API->>Env: 获取环境变量
    Env->>DB: SELECT * FROM projectenvironment
    DB-->>Env: {token: "xxx", userId: 123}
    Env-->>API: 环境变量

    API->>Var: 替换变量
    Note over Var: {{userId}} → 123<br/>{{token}} → "xxx"
    Var-->>API: 替换后数据

    API->>HTTP: 发送请求
    HTTP->>Target: GET /api/users/123
    Target-->>HTTP: 200 OK
    HTTP-->>API: Response

    API->>Hist: 保存历史
    Hist->>DB: INSERT INTO interfacehistory
    DB-->>Hist: 保存成功

    API-->>FE: Response + history_id
    FE->>FE: 显示响应
```

---

### 4.2 cURL 导入流程

```mermaid
sequenceDiagram
    actor User
    participant FE as 前端
    participant Dialog as cURL 导入弹窗
    participant API as FastAPI
    participant CurlSvc as cURL 解析服务
    participant State as React State

    User->>Dialog: 粘贴 cURL 命令
    Dialog->>API: POST /interfaces/parse-curl
    API->>CurlSvc: 解析 cURL
    CurlSvc-->>API: 解析结果

    API-->>Dialog: 解析结果
    Dialog->>Dialog: 显示预览

    User->>Dialog: 确认导入
    Dialog->>State: 更新表单状态
    State->>FE: 渲染请求编辑器
```

---

### 4.3 测试用例生成流程

```mermaid
sequenceDiagram
    actor User
    participant FE as 前端
    participant Dialog as 生成用例弹窗
    participant API as FastAPI
    participant CaseSvc as 测试用例生成器
    participant Engine as sisyphus-api-engine
    participant DB as 数据库

    User->>Dialog: 填写配置
    Note over Dialog: 用例名称<br/>关键字名称<br/>所属场景

    User->>Dialog: 点击「生成并保存」
    Dialog->>API: POST /interfaces/{id}/generate-test-case
    API->>CaseSvc: 生成 YAML

    CaseSvc->>CaseSvc: 1. 获取接口配置
    CaseSvc->>CaseSvc: 2. 获取环境变量
    CaseSvc->>CaseSvc: 3. 生成断言（如需要）
    CaseSvc->>Engine: 写入 YAML 文件

    Engine-->>CaseSvc: 文件路径
    CaseSvc->>DB: 保存测试用例记录
    DB-->>CaseSvc: 保存成功

    CaseSvc-->>API: 返回结果
    API-->>FE: 测试用例数据

    Dialog->>Dialog: 显示成功提示
    Dialog->>FE: 刷新测试用例列表
```

---

## 5. 部署架构

### 5.1 开发环境

```mermaid
graph TB
    subgraph Dev["开发机"]
        FE[React Dev Server<br/>:5173]
        BE[FastAPI Uvicorn<br/>:8000]
    end

    subgraph Infra["Docker Compose"]
        PG[(PostgreSQL<br/>:5432)]
        R[(Redis<br/>:6379)]
        M[(MinIO<br/>:9000)]
    end

    FE --> BE
    BE --> PG
    BE --> R
    BE --> M
```

---

### 5.2 生产环境

```mermaid
graph TB
    subgraph Web["Web 层"]
        Nginx["Nginx<br/>反向代理"]
    end

    subgraph App["应用层"]
        FE[React Build<br/>静态文件]
        BE[FastAPI<br/>Gunicorn + Uvicorn]
    end

    subgraph Data["数据层"]
        PG[(PostgreSQL<br/>主从复制)]
        R[(Redis<br/>Cluster)]
    end

    subgraph Storage["存储层"]
        M[(MinIO<br/>分布式)]
    end

    Nginx --> FE
    Nginx --> BE
    BE --> PG
    BE --> R
    BE --> M
```

---

## 6. 技术栈矩阵

| 层级 | 技术 | 版本 | 用途 |
|------|------|------|------|
| 前端框架 | React | 19.2 | UI 框架 |
| 前端语言 | TypeScript | 5.9 | 类型安全 |
| 构建工具 | Vite | 7.2 | 开发服务器 |
| 状态管理 | React Query | 5.0 | 服务端状态 |
| 拖拽 | @dnd-kit | 6.1 | 拖拽排序 |
| 代码编辑 | Monaco | 4.6 | JSON/YAML 编辑 |
| 后端框架 | FastAPI | 0.115+ | API 框架 |
| 后端语言 | Python | 3.12+ | 后端逻辑 |
| ORM | SQLModel | 0.0.22 | 数据库 ORM |
| 数据库 | PostgreSQL | 16 | 生产数据库 |
| 数据库 | SQLite | 3.45 | 开发数据库 |
| 缓存 | Redis | 7.2 | 缓存层 |
| 对象存储 | MinIO | RELEASE.2024 | 文件存储 |
| HTTP 客户端 | httpx | 0.27+ | 异步请求 |
| 任务调度 | APScheduler | 3.10+ | 定时任务 |
| 容器化 | Docker | 26+ | 容器运行时 |
| 进程管理 | Gunicorn | 23+ | WSGI 服务器 |

---

## 7. 接口依赖关系图

```mermaid
graph TD
    A[环境管理接口] --> D[接口调试接口]
    B[cURL 解析接口] --> C[接口创建/更新]
    C --> D
    D --> E[历史记录接口]
    D --> F[测试用例生成接口]
    F --> G[Engine 集成]

    style A fill:#e1f5ff
    style D fill:#ffe1e1
    style F fill:#e1ffe1
```

---

## 8. 前端交互设计

### 8.1 执行日志展示（按需显示）

根据用户决策，执行日志采用「默认隐藏，按需展开」的设计。

**交互流程：**

```
┌─────────────────────────────────────────────────────────────┐
│ Response                              [200 OK]  [125ms]  │
├─────────────────────────────────────────────────────────────┤
│ [Body] [Headers] [Cookies] [Timeline]                    │
├─────────────────────────────────────────────────────────────┤
│ {                                                          │
│   "code": 0,                                               │
│   "data": {...}                                             │
│ }                                                          │
│                                                      [展开日志 ▼] │
└─────────────────────────────────────────────────────────────┘
                            ↓ 点击展开
┌─────────────────────────────────────────────────────────────┐
│ Response                              [200 OK]  [125ms]  │
├─────────────────────────────────────────────────────────────┤
│ [Body] [Headers] [Cookies] [Timeline] [执行日志]        │
├─────────────────────────────────────────────────────────────┤
│ {                                                          │
│   "code": 0,                                               │
│   "data": {...}                                             │
│ }                                                          │
├─────────────────────────────────────────────────────────────┤
│ 执行日志                                        [收起 ▲] │
│ ┌──────────────────────────────────────────────────────┐   │
│ │ [14:30:25.123] 开始发送请求                        │   │
│ │ [14:30:25.145] 环境变量替换完成                   │   │
│ │ [14:30:25.167] DNS 查询完成: 22ms                  │   │
│ │ [14:30:25.189] TCP 连接完成: 24ms                  │   │
│ │ [14:30:25.234] 首字节接收: 45ms                   │   │
│ │ [14:30:25.248] 响应接收完成: 125ms                │   │
│ └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

**实现要点：**

| 组件 | 状态 | 说明 |
|------|------|------|
| ResponseViewer | 默认 | 不显示「执行日志」Tab |
| ResponseViewer | 展开状态 | 新增「执行日志」Tab |
| 展开按钮 | 条件显示 | 仅在有执行日志时显示 |
| 日志内容 | 只读 | 从后端 timeline 数据生成 |

**前端代码位置：**
- `frontend/src/pages/interface-refactor/components/ResponseViewer/ResponseViewer.tsx`
- 新增 `ExecutionLogViewer.tsx` 组件（待实现）

**后端数据来源：**
- `interfacehistory.timeline` 字段
- 包含 DNS/TCP/TTFB/Download 时间数据

---

## 9. 用户决策说明

| 决策项 | 设计实现 | 状态 |
|--------|----------|------|
| 拖拽功能 P0 | 使用 @dnd-kit 实现完整拖拽排序 | ✅ 已实现 |
| Pre-request Script | 预留 UI 入口，暂不实现 | ✅ 已预留 |
| 执行日志按需显示 | 默认隐藏，支持展开/收起 | ⚠️ 待实现 |

---

**文档版本**：v1.2 (补充执行日志交互设计)
**最后更新**：2025-02-11
