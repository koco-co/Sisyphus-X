# 接口管理模块重构 - API 接口定义

> 文档版本: v1.0
> 创建日期: 2025-02-11
> 角色: 系统架构师
> 规范: OpenAPI 3.0

---

## 1. API 概览

### 基础信息

| 项目 | 值 |
|------|-----|
| Base URL | `/api/v1` |
| 认证方式 | JWT Bearer Token |
| 内容类型 | `application/json` |
| 响应编码 | UTF-8 |

### 通用响应格式

```typescript
interface ApiResponse<T> {
  success: boolean
  data?: T
  error?: string
  meta?: {
    total: number
    page: number
    size: number
  }
}
```

---

## 2. 环境管理接口

### 2.1 获取环境列表

```yaml
GET /api/v1/projects/{project_id}/environments
```

**请求参数：**

| 参数 | 类型 | 位置 | 必填 | 说明 |
|------|------|------|------|------|
| project_id | integer | path | 是 | 项目 ID |

**响应示例：**

```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "project_id": 1,
      "name": "开发环境",
      "domain": "https://api-dev.example.com",
      "variables": {
        "token": "eyJhbGc...",
        "user_id": "12345"
      },
      "headers": {
        "Authorization": "Bearer {{token}}"
      },
      "is_preupload": false,
      "created_at": "2025-02-11T10:00:00Z",
      "updated_at": "2025-02-11T10:00:00Z"
    }
  ]
}
```

---

### 2.2 创建环境

```yaml
POST /api/v1/projects/{project_id}/environments
```

**请求参数：**

| 参数 | 类型 | 位置 | 必填 | 说明 |
|------|------|------|------|------|
| project_id | integer | path | 是 | 项目 ID |

**请求体：**

```json
{
  "name": "测试环境",
  "domain": "https://api-test.example.com",
  "variables": {
    "token": "test_token_value",
    "user_id": "9999"
  },
  "headers": {
    "Authorization": "Bearer {{token}}",
    "X-Env": "test"
  },
  "is_preupload": false
}
```

**字段验证：**

| 字段 | 验证规则 |
|------|----------|
| name | 1-50 字符，项目内唯一 |
| domain | 有效 URL 格式 |
| variables | 对象，值支持 `{{变量}}` 引用 |
| headers | 对象，值支持 `{{变量}}` 引用 |

**响应示例：**

```json
{
  "success": true,
  "data": {
    "id": 2,
    "project_id": 1,
    "name": "测试环境",
    "domain": "https://api-test.example.com",
    "variables": {
      "token": "test_token_value",
      "user_id": "9999"
    },
    "headers": {
      "Authorization": "Bearer {{token}}",
      "X-Env": "test"
    },
    "is_preupload": false,
    "created_at": "2025-02-11T11:00:00Z",
    "updated_at": "2025-02-11T11:00:00Z"
  }
}
```

---

### 2.3 更新环境

```yaml
PUT /api/v1/projects/{project_id}/environments/{environment_id}
```

**请求参数：**

| 参数 | 类型 | 位置 | 必填 | 说明 |
|------|------|------|------|------|
| project_id | integer | path | 是 | 项目 ID |
| environment_id | integer | path | 是 | 环境 ID |

**请求体：**

```json
{
  "name": "测试环境 (已更新)",
  "domain": "https://api-test-updated.example.com",
  "variables": {
    "token": "new_token_value"
  },
  "headers": {
    "Authorization": "Bearer {{token}}"
  },
  "is_preupload": true
}
```

**响应示例：**

```json
{
  "success": true,
  "data": {
    "id": 2,
    "project_id": 1,
    "name": "测试环境 (已更新)",
    "domain": "https://api-test-updated.example.com",
    "variables": {
      "token": "new_token_value"
    },
    "headers": {
      "Authorization": "Bearer {{token}}"
    },
    "is_preupload": true,
    "created_at": "2025-02-11T11:00:00Z",
    "updated_at": "2025-02-11T12:00:00Z"
  }
}
```

---

### 2.4 删除环境

```yaml
DELETE /api/v1/projects/{project_id}/environments/{environment_id}
```

**请求参数：**

| 参数 | 类型 | 位置 | 必填 | 说明 |
|------|------|------|------|------|
| project_id | integer | path | 是 | 项目 ID |
| environment_id | integer | path | 是 | 环境 ID |

**响应示例：**

```json
{
  "success": true,
  "data": {
    "deleted": 2
  }
}
```

**错误响应：**

```json
{
  "success": false,
  "error": "Cannot delete environment with active interfaces"
}
```

---

### 2.5 克隆环境

```yaml
POST /api/v1/projects/{project_id}/environments/{environment_id}/copy
```

**请求参数：**

| 参数 | 类型 | 位置 | 必填 | 说明 |
|------|------|------|------|------|
| project_id | integer | path | 是 | 项目 ID |
| environment_id | integer | path | 是 | 源环境 ID |

**请求体：**

```json
{
  "name": "开发环境 - 副本"
}
```

**响应示例：**

```json
{
  "success": true,
  "data": {
    "id": 3,
    "project_id": 1,
    "name": "开发环境 - 副本",
    "domain": "https://api-dev.example.com",
    "variables": {
      "token": "eyJhbGc...",
      "user_id": "12345"
    },
    "headers": {
      "Authorization": "Bearer {{token}}"
    },
    "is_preupload": false,
    "created_at": "2025-02-11T13:00:00Z",
    "updated_at": "2025-02-11T13:00:00Z"
  }
}
```

---

### 2.6 替换环境变量

```yaml
POST /api/v1/projects/{project_id}/environments/{environment_id}/replace
```

**说明：** 在发送请求前，将所有 `{{变量名}}` 替换为实际值

**请求参数：**

| 参数 | 类型 | 位置 | 必填 | 说明 |
|------|------|------|------|------|
| project_id | integer | path | 是 | 项目 ID |
| environment_id | integer | path | 是 | 环境 ID |

**请求体：**

```json
{
  "text": "/api/users/{{userId}}?token={{token}}",
  "additional_vars": {
    "userId": "12345"
  }
}
```

**响应示例：**

```json
{
  "success": true,
  "data": {
    "original": "/api/users/{{userId}}?token={{token}}",
    "replaced": "/api/users/12345?token=eyJhbGc...",
    "variables_used": ["userId", "token"]
  }
}
```

---

## 3. cURL 解析接口

### 3.1 解析 cURL 命令

```yaml
POST /api/v1/interfaces/parse-curl
```

**请求体：**

```json
{
  "curl_command": "curl -X POST https://api.example.com/users \\ -H 'Content-Type: application/json' \\ -H 'Authorization: Bearer {{token}}' \\ -d '{\"name\":\"Alice\",\"email\":\"alice@example.com\"}'"
}
```

**响应示例：**

```json
{
  "success": true,
  "data": {
    "method": "POST",
    "url": "https://api.example.com/users",
    "headers": {
      "Content-Type": "application/json",
      "Authorization": "Bearer {{token}}"
    },
    "body": {
      "name": "Alice",
      "email": "alice@example.com"
    },
    "body_type": "json",
    "params": {},
    "auth": {
      "type": "bearer",
      "token": "{{token}}"
    }
  }
}
```

**错误响应：**

```json
{
  "success": false,
  "error": "Invalid cURL command: missing URL"
}
```

---

## 4. 接口管理接口（扩展）

### 4.1 发送接口请求（增强版）

```yaml
POST /api/v1/interfaces/debug/send
```

**请求体：**

```json
{
  "interface_id": 1,
  "environment_id": 2,
  "url": "/api/users/{{userId}}",
  "method": "GET",
  "headers": {
    "Authorization": "Bearer {{token}}"
  },
  "params": {
    "status": "active"
  },
  "body": null,
  "body_type": "none",
  "auth": {
    "type": "bearer",
    "token": "{{token}}"
  },
  "timeout": 30000,
  "save_history": true
}
```

**新增字段说明：**

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| interface_id | integer | 否 | 接口 ID（保存历史时使用） |
| environment_id | integer | 否 | 环境 ID（用于变量替换） |
| auth | object | 否 | 认证配置（详见 4.1.1） |
| save_history | boolean | 否 | 是否保存到历史记录，默认 false |

#### 4.1.1 认证配置对象

```typescript
interface AuthConfig {
  type: 'none' | 'bearer' | 'api_key' | 'basic'
  // Bearer Token
  token?: string
  // API Key
  key?: string
  value?: string
  add_to?: 'header' | 'query'
  // Basic Auth
  username?: string
  password?: string
}
```

**响应示例：**

```json
{
  "success": true,
  "data": {
    "status_code": 200,
    "headers": {
      "Content-Type": "application/json",
      "Content-Length": "1234"
    },
    "body": {
      "code": 0,
      "data": {
        "users": [
          {"id": 1, "name": "Alice"},
          {"id": 2, "name": "Bob"}
        ]
      },
      "message": "success"
    },
    "elapsed": 0.125,
    "size": 1234,
    "timeline": {
      "dns": 10,
      "tcp": 20,
      "ttfb": 80,
      "download": 15
    },
    "history_id": 123
  }
}
```

---

### 4.2 移动接口到文件夹

```yaml
PUT /api/v1/interfaces/{interface_id}/move
```

**请求体：**

```json
{
  "target_folder_id": 5
}
```

**响应示例：**

```json
{
  "success": true,
  "data": {
    "id": 10,
    "name": "用户列表接口",
    "folder_id": 5
  }
}
```

---

### 4.3 复制接口

```yaml
POST /api/v1/interfaces/{interface_id}/copy
```

**请求体：**

```json
{
  "name": "用户列表接口 - 副本",
  "target_folder_id": 5
}
```

**响应示例：**

```json
{
  "success": true,
  "data": {
    "id": 11,
    "name": "用户列表接口 - 副本",
    "folder_id": 5,
    "url": "/api/users",
    "method": "GET"
  }
}
```

---

## 5. 请求历史接口

### 5.1 获取接口历史记录

```yaml
GET /api/v1/interfaces/{interface_id}/history
```

**请求参数：**

| 参数 | 类型 | 位置 | 必填 | 说明 |
|------|------|------|------|------|
| interface_id | integer | path | 是 | 接口 ID |
| page | integer | query | 否 | 页码，默认 1 |
| size | integer | query | 否 | 每页数量，默认 20 |

**响应示例：**

```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": 1,
        "interface_id": 10,
        "user_id": 1,
        "url": "/api/users/12345",
        "method": "GET",
        "headers": {
          "Authorization": "Bearer eyJhbGc..."
        },
        "params": {
          "status": "active"
        },
        "body": {},
        "status_code": 200,
        "response_headers": {
          "Content-Type": "application/json"
        },
        "response_body": {
          "code": 0,
          "data": {...}
        },
        "elapsed": 0.125,
        "created_at": "2025-02-11T14:00:00Z"
      }
    ],
    "total": 50,
    "page": 1,
    "size": 20,
    "pages": 3
  }
}
```

---

### 5.2 删除历史记录

```yaml
DELETE /api/v1/interfaces/history/{history_id}
```

**响应示例：**

```json
{
  "success": true,
  "data": {
    "deleted": 1
  }
}
```

---

### 5.3 清空接口历史

```yaml
DELETE /api/v1/interfaces/{interface_id}/history
```

**响应示例：**

```json
{
  "success": true,
  "data": {
    "deleted_count": 50
  }
}
```

---

## 6. 测试用例生成接口

### 6.1 生成测试用例

```yaml
POST /api/v1/interfaces/{interface_id}/generate-test-case
```

**请求体：**

```json
{
  "case_name": "用户列表查询-默认状态",
  "keyword_name": "get_user_list",
  "scenario_id": 5,
  "auto_assertion": true,
  "environment_id": 2
}
```

**字段说明：**

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| case_name | string | 是 | 测试用例名称 |
| keyword_name | string | 是 | 关键字函数名 |
| scenario_id | integer | 否 | 所属场景 ID |
| auto_assertion | boolean | 是 | 是否自动生成断言 |
| environment_id | integer | 是 | 使用的环境 ID |

**响应示例：**

```json
{
  "success": true,
  "data": {
    "test_case": {
      "id": 100,
      "name": "用户列表查询-默认状态",
      "yaml_path": "engines/sisyphus_api_engine/cases/user_list.yaml",
      "keyword_path": "engines/sisyphus_api_engine/keywords/get_user_list.py"
    },
    "yaml_content": "name: 用户列表查询-默认状态\nbase_url: https://api-dev.example.com\n...",
    "assertions": [
      {
        "type": "status_code",
        "expected": 200
      },
      {
        "type": "json_path",
        "path": "$.code",
        "expected": 0
      }
    ]
  }
}
```

---

### 6.2 预览生成的 YAML

```yaml
POST /api/v1/interfaces/{interface_id}/preview-yaml
```

**请求体：**

```json
{
  "environment_id": 2,
  "auto_assertion": true
}
```

**响应示例：**

```json
{
  "success": true,
  "data": {
    "yaml_content": "name: 用户列表查询\nbase_url: https://api-dev.example.com\nvariables:\n  token: eyJhbGc...\nrequest:\n  method: GET\n  path: /api/users\n  params:\n    status: active\n  headers:\n    Authorization: Bearer {{token}}\nassertion:\n  - type: status_code\n    expected: 200\n  - type: json_path\n    path: $.code\n    expected: 0"
  }
}
```

---

## 7. 文件夹管理接口（扩展）

### 7.1 更新文件夹

```yaml
PUT /api/v1/interfaces/folders/{folder_id}
```

**请求体：**

```json
{
  "name": "用户管理 (已重命名)",
  "parent_id": null
}
```

**响应示例：**

```json
{
  "success": true,
  "data": {
    "id": 5,
    "name": "用户管理 (已重命名)",
    "project_id": 1,
    "parent_id": null
  }
}
```

---

### 7.2 批量更新排序

```yaml
PUT /api/v1/interfaces/folders/reorder
```

**请求体：**

```json
{
  "folder_orders": [
    {"id": 5, "order": 0},
    {"id": 6, "order": 1},
    {"id": 7, "order": 2}
  ],
  "interface_orders": [
    {"id": 10, "order": 0},
    {"id": 11, "order": 1}
  ]
}
```

**响应示例：**

```json
{
  "success": true,
  "data": {
    "updated": 5
  }
}
```

---

## 8. 搜索与过滤接口

### 8.1 搜索接口

```yaml
GET /api/v1/projects/{project_id}/interfaces/search
```

**请求参数：**

| 参数 | 类型 | 位置 | 必填 | 说明 |
|------|------|------|------|------|
| project_id | integer | path | 是 | 项目 ID |
| q | string | query | 否 | 搜索关键词（名称/URL） |
| method | string | query | 否 | 过滤方法 (GET/POST/...) |
| folder_id | integer | query | 否 | 过滤文件夹 ID |
| page | integer | query | 否 | 页码，默认 1 |
| size | integer | query | 否 | 每页数量，默认 20 |

**响应示例：**

```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": 10,
        "name": "用户列表接口",
        "url": "/api/users",
        "method": "GET",
        "folder_id": 5
      }
    ],
    "total": 15,
    "page": 1,
    "size": 20,
    "pages": 1
  }
}
```

---

## 9. 系统变量接口

### 9.1 获取系统变量列表

```yaml
GET /api/v1/system-variables
```

**说明：** 返回系统内置变量（`{{$timestamp}}`、`{{$randomInt}}` 等）

**响应示例：**

```json
{
  "success": true,
  "data": [
    {
      "name": "timestamp",
      "syntax": "{{$timestamp}}",
      "description": "当前 Unix 时间戳",
      "example": "1707654321"
    },
    {
      "name": "randomInt",
      "syntax": "{{$randomInt(min, max)}}",
      "description": "生成指定范围内的随机整数",
      "example": "{{$randomInt(1, 100)}}"
    },
    {
      "name": "guid",
      "syntax": "{{$guid}}",
      "description": "生成随机 GUID",
      "example": "550e8400-e29b-41d4-a716-446655440000"
    },
    {
      "name": "date",
      "syntax": "{{$date(format)}}",
      "description": "格式化日期",
      "example": "{{$date(YYYY-MM-DD)}}"
    }
  ]
}
```

---

## 10. 错误码定义

| 错误码 | 说明 |
|--------|------|
| 400 | 请求参数错误 |
| 401 | 未认证 |
| 403 | 无权限 |
| 404 | 资源不存在 |
| 409 | 资源冲突（如环境名称重复） |
| 422 | 数据验证失败 |
| 500 | 服务器内部错误 |

---

## 11. 变量引用语法规范

### 11.1 支持的变量类型

| 类型 | 语法 | 示例 |
|------|------|------|
| 环境变量 | `{{变量名}}` | `{{token}}`, `{{user_id}}` |
| 时间戳 | `{{$timestamp}}` | `{{$timestamp}}` |
| 随机整数 | `{{$randomInt(min, max)}}` | `{{$randomInt(1, 100)}}` |
| GUID | `{{$guid}}` | `{{$guid}}` |
| 日期 | `{{$date(format)}}` | `{{$date(YYYY-MM-DD)}}` |

### 11.2 变量替换优先级

1. 当前环境变量
2. 请求中附加的变量
3. 系统内置变量

---

**文档结束**
