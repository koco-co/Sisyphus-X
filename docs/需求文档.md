# Sisyphus-X 功能需求文档

**版本**: v1.1.0-beta
**日期**: 2026-02-15
**面向对象**: 开发团队、测试团队
**更新日志**:
- 修正后端技术栈为 SQLAlchemy 2.0 + Pydantic v2（分离 ORM 模型和 Schema）
- 统一版本号为 v1.1.0-beta
- 补充 MVP 范围和验收标准

## 项目概述

Sisyphus-X 是一款 YAML 驱动的企业级自动化测试管理平台，整合项目配置、接口定义、场景编排、测试计划、测试报告全流程。

**技术栈**:

- 前端: React **18.2.0** + TypeScript **5.9.3** + Vite **7.2.4** + Tailwind CSS + shadcn/ui
- 后端: FastAPI **0.115.0+** + Python **3.12+** + SQLAlchemy **2.0** + Pydantic **v2**
- 中间件: PostgreSQL 15+ + MinIO + Redis
- 核心执行器: pytest + sisyphus-api-engine

**技术选型理由**:

- **React 18.2.0**: 成熟稳定,Concurrent Features 提升性能,生态系统完善
- **FastAPI 0.115+**: 原生异步支持,性能优异,自动生成 OpenAPI 文档
- **SQLAlchemy 2.0**: 成熟的 Python ORM 框架,支持异步操作,强大的查询能力和关系映射
- **Pydantic v2**: 类型验证和数据序列化,与 FastAPI 深度集成,提供运行时类型安全,性能提升 5-50x
- **PostgreSQL 15+**: ACID 事务保证,JSONB 支持灵活数据结构,成熟的查询优化器

**架构说明**:

后端采用**分层架构**:
- **数据库层**: SQLAlchemy 2.0 ORM 模型（使用 Mapped[] 类型注解）
- **Schema 层**: Pydantic v2 Schema（请求/响应验证）
- **API 层**: FastAPI 路由（业务逻辑）
- 这种分离带来更好的灵活性和可维护性

---

## 功能模块

### 1. 用户认证 (AUTH-001 ~ AUTH-008)

#### 1.1 邮箱注册/登录

**功能描述**:

- 用户通过邮箱 + 密码注册
- 用户通过邮箱 + 密码登录
- 密码使用 bcrypt 哈希存储
- 登录成功返回 JWT Token，有效期 7 天
- Token 存储在 localStorage

**验收标准**:

- [x] 支持邮箱格式验证
- [x] 密码长度 8-20 位
- [x] 注册时二次确认密码
- [x] 登录态刷新页面不丢失
- [x] 所有 API 请求自动携带 JWT Token
- [x] 开发模式(APP_ENV=development)可跳过 JWT 验证

#### 1.2 OAuth 单点登录

**功能描述**:

- 支持 GitHub OAuth 单点登录
- 支持 Google OAuth 单点登录
- OAuth 用户可无密码注册

**验收标准**:

- [x] GitHub OAuth 授权成功后自动登录
- [x] Google OAuth 授权成功后自动登录
- [x] OAuth 新用户自动创建账户
- [x] OAuth 老用户直接登录

---

### 2. 项目管理 (PROJ-001 ~ PROJ-006)

#### 2.1 项目 CRUD

**功能描述**:

- 创建项目: 项目名称、描述
- 编辑项目信息
- 删除项目(二次确认)
- 项目列表分页展示
- 按项目名称查询

**验收标准**:

- [x] 列表字段: 项目名称、描述、创建时间、更新时间、操作列
- [x] 操作列包含: 编辑、数据库配置、删除
- [x] 删除时二次确认弹窗
- [x] 全局 Toast 提示(右上角 + 进度条)
- [x] 支持分页: 页码跳转、每页条数切换

#### 2.2 数据库配置

**功能描述**:

- 配置 MySQL/PostgreSQL 数据库连接
- 测试数据库连接
- 连接状态自动检测(每 10 分钟)
- 启用/禁用配置

**数据表**:

```sql
CREATE TABLE database_configs (
    id UUID PRIMARY KEY,
    project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,           -- 连接名称
    variable_name VARCHAR(255),            -- 引用变量名
    db_type VARCHAR(50) NOT NULL,          -- MySQL / PostgreSQL
    host VARCHAR(255) NOT NULL,
    port INTEGER NOT NULL,
    initial_database VARCHAR(255),
    username VARCHAR(255) NOT NULL,
    password VARCHAR(255) NOT NULL,         -- 加密存储
    is_enabled BOOLEAN DEFAULT TRUE,
    connection_status VARCHAR(50),          -- connected / failed / unknown
    last_tested_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(project_id, variable_name)
);
```

**验收标准**:

- [x] 创建数据库配置需填写: 连接名称、引用变量、主机、端口、初始数据库、用户名、密码
- [x] 点击"测试连接"按钮，测试通过后才能保存
- [x] 连接状态每 10 分钟自动检测一次
- [x] 支持启用/禁用开关
- [x] 列表字段: 连接名称、引用变量、配置信息(脱敏)、连接状态、启用状态
- [x] 操作列: 编辑、删除

---

### 3. 关键字配置 (KEYW-001 ~ KEYW-005)

#### 3.1 内置关键字

**功能描述**:
内置关键字不可删除和编辑，但可查看代码:

| 类型       | 名称                                            | 描述                           |
| ---------- | ----------------------------------------------- | ------------------------------ |
| 发送请求   | HTTP 请求                                       | 支持 requests 库所有 HTTP 方法 |
| 断言类型   | JSON、Header、Cookie、环境变量、HTTP Code、耗时 |                                |
| 提取变量   | JSON、Header、Cookie                            | 支持 JSONPath 提取             |
| 数据库操作 | 选择数据源、输入 SQL                            | 支持断言和提取变量             |
| 自定义操作 | 占位符                                          |                                |

**验收标准**:

- [x] 内置关键字代码可查看(回显在前端)
- [x] 内置关键字不可编辑和删除
- [x] 列表字段: 关键字类型、名称、方法名、启用状态、操作列

#### 3.2 自定义关键字

**功能描述**:

- 创建自定义关键字: 类型、名称、方法名、代码块、入参释义
- 使用 Monaco Editor 编辑代码块
- 编辑和删除自定义关键字
- 启用/禁用关键字

**数据表**:

```sql
CREATE TABLE keywords (
    id UUID PRIMARY KEY,
    project_id UUID REFERENCES projects(id) ON DELETE CASCADE,  -- NULL 表示内置
    type VARCHAR(50) NOT NULL,      -- request / assertion / extract / db / custom
    name VARCHAR(255) NOT NULL,
    method_name VARCHAR(255) NOT NULL,
    code TEXT NOT NULL,             -- Python 代码块
    parameters JSONB,               -- 入参释义 [{name, description}]
    is_builtin BOOLEAN DEFAULT FALSE,
    is_enabled BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(project_id, name)
);
```

**验收标准**:

- [x] 使用 Monaco Editor 编辑代码块
- [x] 支持编辑和删除自定义关键字
- [x] 支持启用/禁用关键字(默认启用)
- [x] 禁用的关键字不在场景编排下拉框中显示

---

### 4. 接口定义 (INTF-001 ~ INTF-006)

#### 4.1 接口目录树

**功能描述**:

- 创建接口目录
- 支持拖拽排序
- 接口和目录的增删改查

**数据表**:

```sql
CREATE TABLE interface_folders (
    id UUID PRIMARY KEY,
    project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    parent_id UUID REFERENCES interface_folders(id) ON DELETE SET NULL,
    name VARCHAR(255) NOT NULL,
    sort_order INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**验收标准**:

- [x] 支持创建多级目录
- [x] 支持拖拽排序(同级目录内)
- [x] 支持删除目录(级联删除子目录和接口)

#### 4.2 接口定义

**功能描述**:

- 手动填写接口信息
- cURL 命令导入
- 接口属性: 接口名称、请求方式、URL、请求头、请求体、断言规则
- 支持 Swagger 导入(Post-MVP)

**数据表**:

```sql
CREATE TABLE interfaces (
    id UUID PRIMARY KEY,
    project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    folder_id UUID REFERENCES interface_folders(id) ON DELETE SET NULL,
    name VARCHAR(255) NOT NULL,
    method VARCHAR(10) NOT NULL,     -- GET / POST / PUT / DELETE / PATCH
    url TEXT NOT NULL,
    headers JSONB,
    body JSONB,
    assertions JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**验收标准**:

- [x] 支持手动填写接口信息
- [x] 支持 cURL 命令导入
- [x] 接口调试中，file 参数上传到 MinIO(按项目分桶)
- [x] 支持接口拖拽排序(同级目录内)

#### 4.3 环境管理

**功能描述**:

- 创建多个环境: 环境名称、前置 URL
- 全局变量(所有环境可用)
- 环境变量(当前环境可用)
- 支持 `{{变量名}}` 引用变量

**数据表**:

```sql
CREATE TABLE environments (
    id UUID PRIMARY KEY,
    project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    base_url VARCHAR(1024),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(project_id, name)
);

CREATE TABLE env_variables (
    id UUID PRIMARY KEY,
    environment_id UUID REFERENCES environments(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    value TEXT NOT NULL,
    description TEXT,
    is_global BOOLEAN DEFAULT FALSE,   -- TRUE 表示全局变量
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(environment_id, name, is_global)
);
```

**验收标准**:

- [x] 右上角支持切换运行环境(显示环境名称)
- [x] 旁边有环境管理按钮，点击进入弹窗页面
- [x] 支持配置全局变量(手动设置、提取变量设置)
- [x] 支持配置环境变量(手动设置、提取变量设置)
- [x] 变量支持: 变量名、变量值、变量描述
- [x] 接口中支持 `{{变量名}}` 引用

---

### 5. 场景编排 (SCEN-001 ~ SCEN-007)

#### 5.1 测试场景 CRUD

**功能描述**:

- 创建测试场景: 项目、名称、描述、优先级(P0~P3)、标签
- 编辑和删除测试场景
- 分页列表展示
- 按场景名称和项目查询

**数据表**:

```sql
CREATE TABLE scenarios (
    id UUID PRIMARY KEY,
    project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    priority VARCHAR(10) DEFAULT 'P2',   -- P0 / P1 / P2 / P3
    tags JSONB,                         -- [tag1, tag2, ...]
    created_by UUID NOT NULL REFERENCES users(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**验收标准**:

- [x] 列表字段: 所属项目、场景名称、描述、操作列
- [x] 操作列包含: 编辑、删除
- [x] 支持分页和查询

#### 5.2 测试步骤编排

**功能描述**:

- 测试步骤列表: 支持增删改、拖拽排序
- 步骤配置: 步骤描述、关键字操作、关键字参数
- 关键字联动: 层层筛选(类型 → 名称 → 参数)
- 前置/后置 SQL(Monaco Editor)

**数据表**:

```sql
CREATE TABLE scenario_steps (
    id UUID PRIMARY KEY,
    scenario_id UUID NOT NULL REFERENCES scenarios(id) ON DELETE CASCADE,
    description TEXT,
    keyword_type VARCHAR(50) NOT NULL,
    keyword_name VARCHAR(255) NOT NULL,
    parameters JSONB,
    sort_order INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**验收标准**:

- [x] 基础信息: 项目、名称、描述、优先级、标签
- [x] Tab 切换: 测试步骤 | 变量定义 | 前置 SQL | 后置 SQL
- [x] 步骤支持拖拽排序(@dnd-kit)
- [x] 选择"发送请求"后，可选择项目中的接口(目录-接口筛选，支持按名称搜索)
- [x] 选择"断言类型"后，可配置断言规则(JSONPath 表达式、判断符号、预期结果)
- [x] 选择"提取变量"后，可配置提取规则(JSONPath 表达式、变量名称、变量类型)
- [x] 选择"数据库操作"后，可选择数据源并输入 SQL
- [x] 前置/后置 SQL 支持 `{{变量名}}` 引用
- [x] 前置/后置 SQL 支持动态传参，如 `source_table_{{random(12)}}`

#### 5.3 数据驱动测试

**功能描述**:

- 创建测试数据集: 数据集名称
- 手动输入测试数据
- 导入/导出 CSV
- 在接口中通过 `{{变量名}}` 引用数据

**数据表**:

```sql
CREATE TABLE datasets (
    id UUID PRIMARY KEY,
    project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    csv_data TEXT NOT NULL,              -- CSV 格式数据
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**验收标准**:

- [x] 右侧边栏支持切换测试数据集(默认不使用)
- [x] 下拉框右边按钮点击后，抽屉展开新建数据集页面
- [x] 支持手动输入测试数据
- [x] 支持导入 CSV
- [x] 支持导出 CSV(无数据时作为导入模板)
- [x] CSV 数据包含表头和数据，一一对应
- [x] 调试时，数据驱动是并行执行，N 行数据 = N 个 YAML 文件

#### 5.4 场景调试

**功能描述**:

- 点击调试按钮调用 sisyphus-api-engine
- 执行完成后自动跳转 Allure 报告
- 调试结果不记录在测试报告模块，不持久化
- 调试结果放在 `temp/${登录账号}/report` 下

**验收标准**:

- [x] 点击调试按钮立即调用 sisyphus-api-engine
- [x] 执行完成后自动跳转 Allure 报告页面
- [x] 下一次调试后自动删除上一次的调试结果
- [x] 不会删除其他用户的调试结果

---

### 6. 测试计划 (PLAN-001 ~ PLAN-006)

#### 6.1 测试计划 CRUD

**功能描述**:

- 创建测试计划: 测试计划名称、所属项目、描述
- 编辑和删除测试计划
- 分页列表展示
- 按测试计划名称和项目查询

**数据表**:

```sql
CREATE TABLE test_plans (
    id UUID PRIMARY KEY,
    project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    created_by UUID NOT NULL REFERENCES users(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**验收标准**:

- [x] 列表字段: 所属项目、测试计划名称、操作列
- [x] 操作列包含: 编辑、执行、复制、查看图表、删除

#### 6.2 测试场景编排

**功能描述**:

- 编排测试场景: 支持拖拽排序
- 支持增删改查测试场景
- 添加测试场景抽屉: 支持项目筛选、场景名称搜索、分页展示

**数据表**:

```sql
CREATE TABLE plan_scenarios (
    id UUID PRIMARY KEY,
    test_plan_id UUID NOT NULL REFERENCES test_plans(id) ON DELETE CASCADE,
    scenario_id UUID NOT NULL REFERENCES scenarios(id) ON DELETE CASCADE,
    dataset_id UUID REFERENCES datasets(id) ON DELETE SET NULL,
    environment_id UUID REFERENCES environments(id) ON DELETE SET NULL,
    variables JSONB,                    -- 场景变量覆盖
    sort_order INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**验收标准**:

- [x] 基础信息: 测试计划名称、所属项目、描述
- [x] 测试场景: 支持拖拽排序，支持增删改查
- [x] 添加测试场景抽屉:
  - [x] MVP: 支持项目筛选(默认选择基础信息中的所属项目)
  - [x] MVP: 支持场景名称搜索
  - [x] MVP: 支持分页展示(默认每页 20 条,可选 10/20/50/100)
  - [x] MVP: 列表显示: 场景名称、描述、优先级、标签、添加按钮
- [x] 测试场景列表显示: 场景名称、变量依赖、引用数据集、操作列(编辑、删除)
- [x] 测试场景顺序执行，数据驱动并行执行

#### 6.3 测试执行

**功能描述**:

- 点击执行按钮，下钻到执行计划页面
- 执行计划页面列表显示: 场景名称、优先级、标签、运行环境、运行结果、创建时间、创建人
- 实时进度监控: WebSocket 推送
- 终止/暂停/恢复控制

**数据表**:

```sql
CREATE TABLE test_executions (
    id UUID PRIMARY KEY,
    test_plan_id UUID NOT NULL REFERENCES test_plans(id) ON DELETE CASCADE,
    status VARCHAR(50) DEFAULT 'running',  -- running / completed / terminated / paused / failed
    started_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP,
    created_by UUID NOT NULL REFERENCES users(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE execution_steps (
    id UUID PRIMARY KEY,
    execution_id UUID NOT NULL REFERENCES test_executions(id) ON DELETE CASCADE,
    scenario_id UUID NOT NULL REFERENCES scenarios(id),
    status VARCHAR(50) DEFAULT 'pending',  -- pending / running / passed / failed / skipped
    result JSONB,
    started_at TIMESTAMP,
    completed_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**验收标准**:

- [x] 执行计划页面列表显示: 场景名称、优先级、标签、运行环境、运行结果(通过、失败、跳过)、创建时间、创建人
- [x] 支持分页和查询
- [x] 点击场景名称，跳转到场景编排详情页
- [x] 鼠标悬浮运行结果，显示最近运行时间、通过指标、性能指标
- [x] 支持批量选择测试场景并运行
- [x] 执行页面:
  - [x] MVP: 面包屑左侧: 测试计划名称
  - [x] MVP: 面包屑右侧: 终止、暂停按钮
  - [x] MVP: 左侧: 实时运行组件(场景总数、通过数、失败数)
  - [x] MVP: 中间: 接口用例运行总/通过/失败数
  - [x] MVP: 右侧: 性能指标(平均响应时间、P95、P99)
  - [x] MVP: 下方: 测试场景列表(运行状态、场景名称、进度条，可折叠/展开)
  - [x] MVP: 场景展开后: 显示接口请求列表(可折叠/展开)
  - [x] MVP: 点击接口请求，展开查看参数(请求方式、URL 等)
  - [x] MVP: 点击接口请求名称，跳转到场景编排详情
- [x] WebSocket 实时推送执行进度
- [x] 运行结束后，支持"再次运行"、导出报告
- [x] 支持"Allure Report"按钮，点击跳转到 Allure 报告页面
- [x] 执行记录持久化到测试报告模块

---

### 7. 测试报告 (REPT-001 ~ REPT-005)

#### 7.1 测试报告列表

**功能描述**:

- 列表显示测试报告: 运行状态、运行时间、测试结果、操作列
- 运行状态: 已完成、运行中、已终止、已暂停、失败
- 测试结果以图形形式展示(通过率、失败率)
- 报告信息包含: 场景名称、运行环境、运行时长、运行人

**数据表**:

```sql
CREATE TABLE test_reports (
    id UUID PRIMARY KEY,
    execution_id UUID NOT NULL REFERENCES test_executions(id) ON DELETE CASCADE,
    scenario_id UUID NOT NULL REFERENCES scenarios(id),
    status VARCHAR(50),                   -- passed / failed / skipped
    duration INTEGER,                      -- 耗时(秒)
    result JSONB,                         -- 详细结果
    allure_report_path TEXT,               -- Allure 报告路径
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**验收标准**:

- [x] 默认显示自定义报告模板
- [x] 已结束的测试计划支持"Allure Report"按钮，点击跳转
- [x] Allure 报告默认保存 30 天
- [x] 操作列: 导出、删除

#### 7.2 历史报告详情

**功能描述**:

- 点击场景名称，下钻到历史报告页面
- 历史报告页面支持: 再次运行、导出报告、Allure 报告、删除、查询、导出
- 历史报告页面与测试计划中的报告运行页面一致

**验收标准**:

- [x] 历史报告页面与测试计划中的报告运行页面一致
- [x] 支持再次运行、导出报告、Allure 报告、删除

---

### 8. 全局参数 (GPAR-001 ~ GPAR-004)

#### 8.1 全局参数管理

**功能描述**:

- 封装工具函数
- 使用 Monaco Editor 编写工具函数
- 自动解析 Google docstring，提取: 类名、方法名、功能描述、入参、出参

**数据表**:

```sql
CREATE TABLE global_params (
    id UUID PRIMARY KEY,
    class_name VARCHAR(255) NOT NULL,
    method_name VARCHAR(255) NOT NULL,
    code TEXT NOT NULL,                  -- Python 代码块
    description TEXT,
    parameters JSONB,                    -- 入参释义 [{name, type, description}]
    return_value JSONB,                  -- 出参释义 {type, description}
    created_by UUID NOT NULL REFERENCES users(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(class_name, method_name)
);
```

**验收标准**:

- [x] 全局参数列表显示:
  - [x] MVP: 参数类名(作为目录，可折叠/展开)
  - [x] MVP: 参数方法名(点击进入详情页，有复制按钮)
  - [x] MVP: 功能描述
  - [x] MVP: 入参类型释义
  - [x] MVP: 出参类型释义
  - [x] MVP: 操作列(编辑、删除)
- [x] 支持创建全局参数(Monaco Editor 编写工具函数)
- [x] 支持自动解析 docstring，提取: 类名、方法名、功能描述、入参、出参
- [x] 支持编辑和删除全局参数
- [x] 保存时弹窗: 显示自动解析结果，确认后保存
- [x] 功能描述、入参、出参缺失时用 "-" 表示
- [x] 自动根据类名分配所属目录
- [x] 初始内置 uuid 函数工具
- [x] 问号图标提示: 使用 Google docstring 规范

---

## API 规范

### 统一响应格式

```typescript
interface ApiResponse<T> {
  success: boolean; // 请求是否成功
  data?: T; // 响应数据(成功时)
  error?: string; // 错误信息(失败时)
  meta?: {
    // 元数据(分页等)
    total: number;
    page: number;
    limit: number;
  };
}
```

### 认证方式

- JWT Token (Bearer Token)
- Token 有效期: 7 天
- 开发模式可跳过认证(APP_ENV=development)

### 请求头规范

```http
Authorization: Bearer <JWT_TOKEN>
Content-Type: application/json
```

### 核心 API 端点

#### 用户认证模块

```
POST   /api/auth/register           # 邮箱注册
POST   /api/auth/login              # 邮箱登录
GET    /api/auth/github             # GitHub OAuth 重定向
GET    /api/auth/github/callback    # GitHub OAuth 回调
GET    /api/auth/google             # Google OAuth 重定向
GET    /api/auth/google/callback    # Google OAuth 回调
```

#### 项目管理模块

```
GET    /api/projects                # 获取项目列表
POST   /api/projects                # 创建项目
GET    /api/projects/{id}           # 获取项目详情
PUT    /api/projects/{id}           # 更新项目
DELETE /api/projects/{id}           # 删除项目

GET    /api/projects/{id}/databases      # 获取数据库配置列表
POST   /api/projects/{id}/databases      # 创建数据库配置
GET    /api/projects/{id}/databases/{db_id}  # 获取数据库配置详情
PUT    /api/projects/{id}/databases/{db_id}  # 更新数据库配置
DELETE /api/projects/{id}/databases/{db_id}  # 删除数据库配置
POST   /api/projects/{id}/databases/{db_id}/test  # 测试数据库连接
```

#### 关键字配置模块

```
GET    /api/keywords               # 获取关键字列表
POST   /api/keywords               # 创建关键字
GET    /api/keywords/{id}          # 获取关键字详情
PUT    /api/keywords/{id}          # 更新关键字
DELETE /api/keywords/{id}          # 删除关键字
PATCH  /api/keywords/{id}/toggle   # 切换关键字启用状态
```

#### 接口定义模块

```
GET    /api/projects/{id}/interfaces       # 获取接口列表
POST   /api/projects/{id}/interfaces       # 创建接口
GET    /api/projects/{id}/interfaces/{int_id}  # 获取接口详情
PUT    /api/projects/{id}/interfaces/{int_id}  # 更新接口
DELETE /api/projects/{id}/interfaces/{int_id}  # 删除接口
POST   /api/projects/{id}/interfaces/import  # 导入接口(cURL)
POST   /api/projects/{id}/interfaces/debug   # 调试接口
```

#### 环境管理模块

```
GET    /api/projects/{id}/environments     # 获取环境列表
POST   /api/projects/{id}/environments     # 创建环境
GET    /api/projects/{id}/environments/{env_id}  # 获取环境详情
PUT    /api/projects/{id}/environments/{env_id}  # 更新环境
DELETE /api/projects/{id}/environments/{env_id}  # 删除环境

GET    /api/environments/{id}/variables    # 获取变量列表
POST   /api/environments/{id}/variables    # 创建变量
GET    /api/environments/{id}/variables/{var_id}  # 获取变量详情
PUT    /api/environments/{id}/variables/{var_id}  # 更新变量
DELETE /api/environments/{id}/variables/{var_id}  # 删除变量
POST   /api/environments/{id}/variables/batch  # 批量创建变量
```

**数据库连接测试 API**:

```
POST   /api/projects/{id}/databases/{db_id}/test  # 测试数据库连接
```

**响应格式**:
```json
{
  "success": true,
  "data": {
    "status": "connected",
    "latency_ms": 45,
    "message": "连接成功",
    "database_version": "PostgreSQL 15.2"
  }
}
```

**失败响应**:
```json
{
  "success": false,
  "error": "ERR_DB_001",
  "message": "数据库连接失败",
  "details": "Connection refused: localhost:5432"
}
```

#### 场景编排模块

```
GET    /api/scenarios               # 获取场景列表
POST   /api/scenarios               # 创建场景
GET    /api/scenarios/{id}          # 获取场景详情
PUT    /api/scenarios/{id}          # 更新场景
DELETE /api/scenarios/{id}          # 删除场景
POST   /api/scenarios/{id}/debug    # 调试场景

GET    /api/scenarios/{id}/datasets     # 获取测试数据集列表
POST   /api/scenarios/{id}/datasets     # 创建测试数据集
GET    /api/scenarios/{id}/datasets/{ds_id}  # 获取数据集详情
PUT    /api/scenarios/{id}/datasets/{ds_id}  # 更新数据集
DELETE /api/scenarios/{id}/datasets/{ds_id}  # 删除数据集
POST   /api/scenarios/{id}/datasets/import  # 导入 CSV
GET    /api/scenarios/{id}/datasets/{ds_id}/export  # 导出 CSV
```

**导入 CSV 请求**:
```http
POST /api/scenarios/{id}/datasets/import
Content-Type: multipart/form-data

file: test_data.csv
```

**响应**:
```json
{
  "success": true,
  "data": {
    "id": "uuid-123",
    "name": "test_data",
    "row_count": 10,
    "columns": ["username", "password", "expected_result"]
  }
}
```

**导出 CSV 响应**:
```http
Content-Type: text/csv
Content-Disposition: attachment; filename="test_data.csv"

username,password,expected_result
user1,pass123,success
user2,pass456,failure
```

#### 测试计划模块

```
GET    /api/plans                   # 获取测试计划列表
POST   /api/plans                   # 创建测试计划
GET    /api/plans/{id}              # 获取测试计划详情
PUT    /api/plans/{id}              # 更新测试计划
DELETE /api/plans/{id}              # 删除测试计划
POST   /api/plans/{id}/execute      # 执行测试计划
POST   /api/plans/{id}/terminate    # 终止测试执行
POST   /api/plans/{id}/pause        # 暂停测试执行
POST   /api/plans/{id}/resume       # 恢复测试执行
GET    /api/plans/{id}/executions   # 获取执行记录列表
GET    /api/plans/{id}/executions/{exe_id}  # 获取执行记录详情
```

#### 测试报告模块

```
GET    /api/reports                 # 获取测试报告列表
GET    /api/reports/{id}            # 获取测试报告详情
GET    /api/reports/{id}/allure     # 获取 Allure 报告 URL
POST   /api/reports/{id}/export     # 导出测试报告
DELETE /api/reports/{id}            # 删除测试报告
```

#### 全局参数模块

```
GET    /api/global-params           # 获取全局参数列表
POST   /api/global-params           # 创建全局参数
GET    /api/global-params/{id}      # 获取全局参数详情
PUT    /api/global-params/{id}      # 更新全局参数
DELETE /api/global-params/{id}      # 删除全局参数
```

#### WebSocket 端点

```
WS     /ws/executions/{execution_id}  # 实时执行进度推送
```

---

### 错误处理规范

#### 统一错误响应格式

所有错误响应遵循以下格式:

```typescript
interface ApiErrorResponse {
  success: false;
  error: string;        // 错误码 (如 AUTH_001, PROJ_001)
  message: string;      // 用户友好的错误描述
  details?: string;     // 详细错误信息(开发环境)
  timestamp: string;    // ISO 8601 时间戳
  path: string;         // 请求路径
}
```

#### 错误码规范

**格式**: `{模块}_{序号}`

**认证模块错误码**:
```typescript
AUTH_001  // Token 缺失或格式错误
AUTH_002  // Token 已过期
AUTH_003  // Token 签名验证失败
AUTH_004  // 用户名或密码错误
AUTH_005  // 用户已存在
AUTH_006  // OAuth 授权失败
AUTH_007  // 权限不足
```

**项目管理模块错误码**:
```typescript
PROJ_001  // 项目不存在
PROJ_002  // 项目名称重复
PROJ_003  // 项目被占用(有关联数据)
PROJ_004  // 数据库配置连接失败
```

**接口定义模块错误码**:
```typescript
INTF_001  // 接口不存在
INTF_002  // 接口名称重复
INTF_003  // cURL 格式错误
INTF_004  // 环境变量未定义
INTF_005  // 文件上传失败
```

**场景编排模块错误码**:
```typescript
SCEN_001  // 场景不存在
SCEN_002  // 场景名称重复
SCEN_003  // 测试步骤配置错误
SCEN_004  // 数据驱动数据格式错误
SCEN_005  // 场景执行失败
```

**测试执行模块错误码**:
```typescript
EXEC_001  // 执行计划不存在
EXEC_002  // 执行计划已终止
EXEC_003  // 场景执行超时
EXEC_004  // 数据库连接失败
EXEC_005  // YAML 生成失败
```

**通用错误码**:
```typescript
ERR_001   // 请求参数验证失败
ERR_002   // 资源不存在
ERR_003   // 服务器内部错误
ERR_004   // 数据库操作失败
ERR_005   // 外部服务调用失败
ERR_006   // 文件操作失败
ERR_007  // 请求超时
ERR_008   // 并发冲突
ERR_009   // 限流
```

#### 常见错误场景处理

**1. 网络超时**:
```json
{
  "success": false,
  "error": "ERR_007",
  "message": "请求超时，请稍后重试",
  "details": "Request timeout after 30s",
  "timestamp": "2026-02-15T10:30:00Z",
  "path": "/api/scenarios/123/debug"
}
```

**2. 数据库连接失败**:
```json
{
  "success": false,
  "error": "PROJ_004",
  "message": "数据库连接失败，请检查配置",
  "details": "Connection refused: localhost:5432",
  "timestamp": "2026-02-15T10:30:00Z",
  "path": "/api/projects/456/databases/789/test"
}
```

**3. 测试执行失败**:
```json
{
  "success": false,
  "error": "SCEN_005",
  "message": "场景执行失败：第 3 步断言不通过",
  "details": "Assertion failed: expected 200 but got 500",
  "timestamp": "2026-02-15T10:30:00Z",
  "path": "/api/scenarios/123/debug"
}
```

**4. 文件上传失败**:
```json
{
  "success": false,
  "error": "INTF_005",
  "message": "文件上传失败：文件大小超过限制",
  "details": "File size 15MB exceeds limit 10MB",
  "timestamp": "2026-02-15T10:30:00Z",
  "path": "/api/projects/123/interfaces/import"
}
```

**5. 参数验证失败**:
```json
{
  "success": false,
  "error": "ERR_001",
  "message": "请求参数验证失败",
  "details": {
    "field": "email",
    "message": "邮箱格式不正确"
  },
  "timestamp": "2026-02-15T10:30:00Z",
  "path": "/api/auth/register"
}
```

#### HTTP 状态码规范

- `200 OK`: 请求成功
- `201 Created`: 资源创建成功
- `204 No Content`: 删除成功
- `400 Bad Request`: 请求参数错误
- `401 Unauthorized`: 未认证
- `403 Forbidden`: 无权限
- `404 Not Found`: 资源不存在
- `409 Conflict`: 资源冲突(如名称重复)
- `422 Unprocessable Entity`: 请求格式正确但语义错误
- `429 Too Many Requests`: 请求过于频繁
- `500 Internal Server Error`: 服务器内部错误
- `503 Service Unavailable`: 服务暂时不可用

---

## 非功能性需求

### 性能

#### API 响应时间

**测试环境条件**:
- 网络带宽: 100 Mbps
- 并发用户数: 10
- 数据库连接池: 20 个连接
- 缓存状态: 冷启动(无缓存)

**性能指标**:
- P50 < 200ms: 50% 的请求响应时间
- P95 < 500ms: 95% 的请求响应时间
- P99 < 1000ms: 99% 的请求响应时间
- **慢接口定义**: 响应时间 > 1s

**数据库查询性能**:
- 单次查询 < 100ms (不含网络传输)
- 复杂查询(多表关联) < 300ms
- 分页查询 < 200ms

**前端渲染性能**:
- 首屏加载时间 < 2s
- 页面切换响应 < 500ms
- 列表滚动加载(100 条) < 1s

#### 测试执行性能

**场景执行启动时间**:
- < 3 秒 (点击执行到开始执行)
- 包含: YAML 生成、引擎调用、第一个请求发送

**实时进度推送**:
- WebSocket 延迟 < 1 秒 (从服务端到客户端)
- 推送频率: 每完成 1 个接口请求推送一次

**并发执行**:
- 数据驱动并行执行: 支持 10 个并发进程
- 场景顺序执行: 单场景并发(数据驱动)

#### 内存使用限制

- 单用户内存占用 < 200MB (后端)
- 前端单页面内存 < 100MB
- 测试执行峰值内存 < 1GB (含引擎)

### 可扩展性

#### 用户规模

- 支持 100+ 并发用户
- 支持 1000+ 注册用户
- 单用户支持 100+ 测试场景

#### 数据规模

- 单项目支持 1000+ 测试场景
- 单场景支持 100+ 测试步骤
- 单场景支持 100+ 历史执行记录
- 单环境支持 200+ 变量

#### 存储扩展

- MinIO 对象存储: 支持 10TB+ 文件上传
- PostgreSQL 数据库: 支持 1TB+ 数据
- Allure 报告: 自动清理 30 天前的报告

### 安全性

#### 认证安全

- JWT Token 算法: RS256 (非对称加密)
- Token 有效期: 7 天 (Access Token) + 30 天 (Refresh Token)
- 密码存储: bcrypt 哈希,加盐存储 (work factor 12)
- 登录失败锁定: 5 次失败锁定 30 分钟

#### 数据加密

- **传输加密**: 强制 HTTPS (TLS 1.3)
- **存储加密**:
  - 数据库密码: AES-256-GCM 加密
  - API Token: AES-256-GCM 加密
  - 敏感配置: 环境变量 + KMS (生产环境)

#### 访问控制

- 基于角色的访问控制 (RBAC)
- 资源级权限控制 (用户只能访问自己创建的资源)
- API 限流: 100 req/min per user
- IP 白名单: 管理员操作支持

#### 安全防护

- SQL 注入防护: 使用参数化查询
- XSS 防护: 用户输入转义 + CSP 策略
- CSRF 防护: Token 验证
- 文件上传限制: 大小 10MB,类型白名单

### 可靠性

#### 系统可用性

- **目标**: >99.5% (月度)
- **计算公式**: (总时间 - 故障时间) / 总时间
- **故障定义**: 服务不可用 或 响应时间 > 5s
- **不包含**: 计划内维护时间 (提前 24 小时通知)

#### 数据备份

- PostgreSQL 数据库: 每日全量备份 + 实时归档日志
- MinIO 对象存储: 3 副本存储 + 跨区域复制
- 配置文件: Git 版本控制
- 备份保留: 30 天

#### 错误处理

- 所有 API 统一错误响应格式
- 结构化日志记录 (JSON 格式)
- 关键操作审计日志 (保留 90 天)
- 异常告警: 钉钉/企业微信通知

#### 容错机制

- 数据库连接失败: 自动重试 3 次,间隔 1s
- API 调用失败: 自动重试 2 次,指数退避
- 测试执行超时: 自动终止,释放资源
- WebSocket 断线: 自动重连,恢复状态

### 可用性

#### 浏览器支持

- **推荐**: Chrome 120+, Firefox 120+, Safari 17+, Edge 120+
- **最低**: Chrome 90+, Firefox 88+, Safari 14+
- **不支持**: IE 11 及更早版本

#### 移动端支持

- 响应式设计 (Phone / Pad)
- 触摸操作优化
- 横屏/竖屏自适应

#### 国际化支持

- 支持中英文切换 (i18next)
- 日期时间格式本地化
- 货币、数字格式本地化

### 可维护性

#### 代码规范

- **后端**: Ruff (line_length=100)
- **前端**: ESLint + Prettier
- **注释**: 中文注释,Google docstring 规范
- **命名**: 驼峰命名 (JS/TS) / 蛇形命名 (Python)

#### 测试覆盖

- **单元测试**: 覆盖率 ≥ 80% (pytest)
- **集成测试**: 核心流程全覆盖
- **E2E 测试**: 关键用户流程 (Playwright)

#### 文档完善

- README: 项目介绍和快速开始
- API 文档: Swagger/OpenAPI 自动生成
- 部署文档: Docker Compose / Kubernetes
- 开发文档: 架构设计、数据库设计

#### 日志规范

- **格式**: JSON 结构化日志
- **级别**: DEBUG / INFO / WARNING / ERROR / CRITICAL
- **内容**: 时间戳、日志级别、模块、消息、上下文数据
- **保留**: 30 天 (DEBUG 级别 7 天)

#### 监控告警

- **应用监控**: CPU、内存、响应时间、错误率 (Prometheus + Grafana)
- **业务监控**: 测试通过率、执行时长、失败分布
- **告警规则**:
  - CPU > 80% 持续 5 分钟
  - 内存使用 > 85%
  - 错误率 > 5%
  - API 响应时间 P95 > 2s
  - 测试通过率 < 90%

---

---

## 开发环境启动

### 前置依赖

```bash
# Docker 服务 (PostgreSQL/MinIO/Redis)
docker-compose up -d

# 检查服务状态
docker-compose ps
```

### 后端开发

```bash
cd backend

# 安装依赖 (使用 uv)
uv sync

# 环境配置
cp .env.example .env
# 编辑 .env 配置数据库连接、密钥等

# 初始化数据库
python -m app.init_db

# 启动开发服务器
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

**API 文档**: http://localhost:8000/docs

### 前端开发

```bash
cd frontend

# 安装依赖
npm install

# 启动开发服务器 (默认端口 3000)
npm run dev

# 构建生产版本
npm run build

# 代码检查
npm run lint
```

**前端地址**: http://localhost:3000

### 核心执行器 (可选)

```bash
cd api-engine

# 安装依赖
uv sync

# 安装 CLI 工具
pip install -e .
```

---

## 测试要求

### 白盒测试

- 使用 pytest
- 覆盖率 ≥ 80%
- 单元测试、集成测试

### 黑盒测试

- 使用 Playwright
- 覆盖核心用户流程

### TDD 开发流程

- 遵循测试驱动开发: 红 → 绿 → 重构
- 先写测试，再实现代码

---

## 项目规范

### 代码规范

- 全程使用 Google 开发范式
- 注释使用中文
- 前端组件样式全局统一(弹窗、分页、查询框、下拉框、暂无数据等)

### 全局文案规范

- 产品设计时考虑合适的文案，不要有歧义
- 全局文案格式规范统一

### 文档管理

- 前端、后端、测试、核心执行器的配置和相关文档都在同一个根目录下维护
- README、CHANGELOG 使用同一个文档

### 标签页管理

- 接口自动化这几个模块均支持对标签页的切换
- 支持关闭全部/当前/其它标签页

### 列表字段筛选

- 所有列表字段中，存在枚举的字段，都支持筛选按钮
- 可重置和确定

---

## 附录

### 核心执行器: sisyphus-api-engine

封装的接口核心执行器，通过 CLI 命令，实现 YAML 文件进行交互。

**功能**:

- 遵循一个 YAML 文件，就是一个完整的测试场景用例
- 支持数据驱动(CSV 文件路径 + YAML 文件中的 ddts 字段)
- 支持文本报告(默认，使用 rich 库)、JSON 响应、Allure 报告、HTML 报告

**工作流程**:

1. 前端将参数传递给后端
2. 后端将参数解析为 YAML 文件，保存在 temp 临时目录中，生成唯一的 UUID 的 YAML 文件名称
3. 调用 sisyphus-api-engine 这个依赖的命令，去执行并得到 JSON 响应数据
4. 后端将 JSON 返回给前端

### Web 自动化 (后续开发)

### App 自动化 (后续开发)

### 消息通知管理 (后续开发)

---
