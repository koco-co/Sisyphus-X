"""接口目录管理 API 端点

参考文档: docs/接口定义.md §5.1-5.4 接口目录管理
"""

import uuid
from typing import Any

from fastapi import APIRouter, Depends, HTTPException, status
from sqlalchemy import func, select
from sqlalchemy.ext.asyncio import AsyncSession
from sqlmodel import col

from app.api.deps import get_current_user
from app.core.db import get_session
from app.models.project import Interface, InterfaceFolder, Project
from app.models.user import User
from app.schemas.interface import FolderCreate, FolderMoveRequest, FolderResponse

router = APIRouter()


def build_folder_tree(folders: list[InterfaceFolder]) -> list[dict]:
    """构建文件夹树形结构

    Args:
        folders: 所有文件夹列表

    Returns:
        树形结构的文件夹列表
    """

    # 根节点（没有父节点的文件夹）
    root_folders = [folder for folder in folders if folder.parent_id is None]

    def build_tree(folder: InterfaceFolder) -> dict:
        """递归构建树"""
        folder_dict = {
            "id": folder.id,
            "project_id": folder.project_id,
            "name": folder.name,
            "parent_id": folder.parent_id,
            "order": folder.order,
            "created_at": folder.created_at.isoformat() if folder.created_at else None,
            "children": [],
        }

        # 查找子文件夹
        for child in folders:
            if child.parent_id == folder.id:
                folder_dict["children"].append(build_tree(child))

        # 按排序字段排序子节点
        folder_dict["children"].sort(key=lambda x: x["order"])

        return folder_dict

    # 为每个根节点构建树
    tree = [build_tree(folder) for folder in root_folders]
    tree.sort(key=lambda x: x["order"])

    return tree


@router.get("/{project_id}/interface-folders/", response_model=list[dict])
async def list_interface_folders(
    project_id: str,
    session: AsyncSession = Depends(get_session),
) -> list[dict]:
    """获取项目的接口目录树

    Args:
        project_id: 项目 ID
        session: 数据库会话

    Returns:
        树形结构的文件夹列表
    """
    # 验证项目存在
    project = await session.get(Project, project_id)
    if not project:
        raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail="项目不存在")

    # 查询所有文件夹
    statement = (
        select(InterfaceFolder)
        .where(col(InterfaceFolder.project_id) == project_id)
        .order_by(col(InterfaceFolder.order))
    )

    result = await session.execute(statement)
    folders = result.scalars().all()

    # 构建树形结构
    return build_folder_tree(list(folders))


@router.post(
    "/{project_id}/interface-folders/",
    response_model=FolderResponse,
    status_code=status.HTTP_201_CREATED,
)
async def create_interface_folder(
    project_id: str,
    folder_in: FolderCreate,
    current_user: User = Depends(get_current_user),
    session: AsyncSession = Depends(get_session),
) -> FolderResponse:
    """创建接口目录

    Args:
        project_id: 项目 ID
        folder_in: 目录创建请求
        current_user: 当前登录用户
        session: 数据库会话

    Returns:
        创建的目录

    Raises:
        HTTPException 404: 项目不存在
        HTTPException 400: 父目录不存在
    """
    # 验证项目存在
    project = await session.get(Project, project_id)
    if not project:
        raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail="项目不存在")

    # 验证父目录存在（如果指定）
    if folder_in.parent_id:
        parent_folder = await session.get(InterfaceFolder, folder_in.parent_id)
        if not parent_folder or parent_folder.project_id != project_id:
            raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail="父目录不存在")

    # 创建目录
    folder = InterfaceFolder(
        id=str(uuid.uuid4()),
        project_id=project_id,
        name=folder_in.name,
        parent_id=folder_in.parent_id,
        order=folder_in.order,
    )
    session.add(folder)
    await session.commit()
    await session.refresh(folder)

    return FolderResponse.model_validate(folder)


@router.get("/{project_id}/interface-folders/{folder_id}/", response_model=FolderResponse)
async def get_interface_folder(
    project_id: str,
    folder_id: str,
    session: AsyncSession = Depends(get_session),
) -> FolderResponse:
    """获取接口目录详情

    Args:
        folder_id: 目录 ID
        session: 数据库会话

    Returns:
        目录详情

    Raises:
        HTTPException 404: 目录不存在
    """
    folder = await session.get(InterfaceFolder, folder_id)
    if not folder:
        raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail="目录不存在")

    return FolderResponse.model_validate(folder)


@router.put("/{project_id}/interface-folders/{folder_id}/", response_model=FolderResponse)
async def update_interface_folder(
    project_id: str,
    folder_id: str,
    folder_in: FolderCreate,
    current_user: User = Depends(get_current_user),
    session: AsyncSession = Depends(get_session),
) -> FolderResponse:
    """更新接口目录

    Args:
        folder_id: 目录 ID
        folder_in: 目录更新请求
        current_user: 当前登录用户
        session: 数据库会话

    Returns:
        更新后的目录

    Raises:
        HTTPException 404: 目录不存在
        HTTPException 400: 父目录不存在或循环引用
    """
    folder = await session.get(InterfaceFolder, folder_id)
    if not folder:
        raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail="目录不存在")

    # 验证父目录
    if folder_in.parent_id:
        # 不能将目录移动到自己或自己的子目录下
        if folder_in.parent_id == folder_id:
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST, detail="不能将目录移动到自己"
            )

        parent_folder = await session.get(InterfaceFolder, folder_in.parent_id)
        if not parent_folder or parent_folder.project_id != folder.project_id:
            raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail="父目录不存在")

    # 更新字段
    folder.name = folder_in.name
    folder.parent_id = folder_in.parent_id
    folder.order = folder_in.order

    session.add(folder)
    await session.commit()
    await session.refresh(folder)

    return FolderResponse.model_validate(folder)


@router.delete("/{project_id}/interface-folders/{folder_id}/", status_code=status.HTTP_204_NO_CONTENT)
async def delete_interface_folder(
    project_id: str,
    folder_id: str,
    current_user: User = Depends(get_current_user),
    session: AsyncSession = Depends(get_session),
) -> None:
    """删除接口目录

    Args:
        folder_id: 目录 ID
        current_user: 当前登录用户
        session: 数据库会话

    Raises:
        HTTPException 404: 目录不存在
        HTTPException 400: 目录下有子目录或接口
    """
    folder = await session.get(InterfaceFolder, folder_id)
    if not folder:
        raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail="目录不存在")

    # 检查是否有子目录
    child_folders_statement = (
        select(func.count())
        .select_from(InterfaceFolder)
        .where(col(InterfaceFolder.parent_id) == folder_id)
    )
    child_count_result = await session.execute(child_folders_statement)
    child_count = int(child_count_result.scalar_one() or 0)

    # 检查是否有接口
    interfaces_statement = (
        select(func.count()).select_from(Interface).where(col(Interface.folder_id) == folder_id)
    )
    interface_count_result = await session.execute(interfaces_statement)
    interface_count = int(interface_count_result.scalar_one() or 0)

    if child_count > 0 or interface_count > 0:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="该目录下有子目录或接口，无法删除",
        )

    await session.delete(folder)
    await session.commit()


@router.patch("/{project_id}/interface-folders/{folder_id}/move/")
async def move_interface_folder(
    project_id: str,
    folder_id: str,
    move_in: FolderMoveRequest,
    current_user: User = Depends(get_current_user),
    session: AsyncSession = Depends(get_session),
) -> dict[str, Any]:
    """移动接口目录（用于拖拽排序）

    Args:
        folder_id: 目录 ID
        move_in: 移动请求
        current_user: 当前登录用户
        session: 数据库会话

    Returns:
        移动结果

    Raises:
        HTTPException 404: 目录不存在
        HTTPException 400: 无效的移动操作
    """
    folder = await session.get(InterfaceFolder, folder_id)
    if not folder:
        raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail="目录不存在")

    # 验证目标父目录
    if move_in.target_parent_id:
        # 不能移动到自己或自己的子目录下
        if move_in.target_parent_id == folder_id:
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST, detail="不能将目录移动到自己"
            )

        target_parent = await session.get(InterfaceFolder, move_in.target_parent_id)
        if not target_parent or target_parent.project_id != folder.project_id:
            raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail="目标父目录不存在")

    # 更新父目录和排序
    folder.parent_id = move_in.target_parent_id
    if move_in.target_order is not None:
        folder.order = move_in.target_order

    session.add(folder)
    await session.commit()

    return {"id": folder_id, "parent_id": folder.parent_id, "order": folder.order, "moved": True}
